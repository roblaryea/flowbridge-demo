<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover">
<title>FlowBridge - Global Settlement Protocol | Investor Demo v4</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#06080d;--bg2:#0d1117;--bg3:#161b22;--bg4:#21262d;--accent:#58a6ff;--accent2:#79c0ff;--green:#3fb950;--yellow:#d29922;--red:#f85149;--purple:#a371f7;--pink:#f778ba;--cyan:#39d353;--text:#e6edf3;--text2:#8b949e;--text3:#484f58;--border:rgba(48,54,61,0.8);--glass:rgba(13,17,23,0.85);--safe-bottom:env(safe-area-inset-bottom,0px);--safe-top:env(safe-area-inset-top,0px)}
html,body{height:100%;margin:0;padding:0}
body{font-family:'Space Grotesk',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
.ambient{position:fixed;inset:0;pointer-events:none;z-index:0;background:radial-gradient(ellipse 100% 80% at 50% -30%,rgba(88,166,255,0.08),transparent),radial-gradient(ellipse 60% 60% at 100% 50%,rgba(63,185,80,0.04),transparent)}
.demo-bar{position:fixed;top:0;left:0;right:0;background:linear-gradient(90deg,#161b22,#0d1117);border-bottom:1px solid var(--border);padding:10px 20px;z-index:1000;display:flex;align-items:center;justify-content:space-between;gap:16px}
.demo-bar-left{display:flex;align-items:center;gap:12px}
.demo-bar-right{display:flex;align-items:center;gap:10px}
.demo-logo{font-size:20px;font-weight:700;background:linear-gradient(135deg,var(--accent),var(--green));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.demo-bar select{background:var(--bg3);border:1px solid var(--border);border-radius:8px;color:var(--text);padding:8px 12px;font-size:12px;font-family:inherit;cursor:pointer}
.live-badge{display:flex;align-items:center;gap:6px;padding:6px 12px;background:rgba(63,185,80,0.1);border:1px solid rgba(63,185,80,0.3);border-radius:20px;font-size:11px;font-family:'JetBrains Mono',monospace}
.live-dot{width:8px;height:8px;background:var(--green);border-radius:50%;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1;box-shadow:0 0 0 0 rgba(63,185,80,0.4)}50%{opacity:0.8;box-shadow:0 0 0 8px rgba(63,185,80,0)}}
.reset-btn,.guided-btn,.scenario-btn,.replay-btn,.mode-btn{background:var(--bg3);border:1px solid var(--border);border-radius:8px;color:var(--text2);padding:8px 12px;font-size:11px;font-family:inherit;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;gap:6px}
.reset-btn:hover,.guided-btn:hover,.scenario-btn:hover,.replay-btn:hover,.mode-btn:hover{background:var(--bg4);color:var(--text);border-color:var(--accent)}
.guided-btn{background:linear-gradient(135deg,var(--purple),var(--pink));border:none;color:#fff}
.guided-btn.active{box-shadow:0 0 0 2px var(--purple)}
.replay-btn{background:linear-gradient(135deg,var(--green),var(--cyan));border:none;color:#fff}
.scenario-btn{background:linear-gradient(135deg,var(--accent),var(--accent2));border:none;color:#fff}
.mode-btn.free{background:linear-gradient(135deg,var(--yellow),#f59e0b);border:none;color:#000}
.savings-ticker{background:linear-gradient(135deg,rgba(63,185,80,0.15),rgba(57,211,83,0.1));border:1px solid rgba(63,185,80,0.3);border-radius:8px;padding:6px 12px;font-size:11px;display:flex;align-items:center;gap:6px}
.savings-ticker .value{font-weight:700;color:var(--green);font-family:'JetBrains Mono',monospace}
.app{display:flex;min-height:100vh;padding-top:52px}
.sidebar{width:260px;background:var(--glass);backdrop-filter:blur(20px);border-right:1px solid var(--border);position:fixed;top:52px;left:0;bottom:0;overflow-y:auto;z-index:100}
.sidebar-header{padding:24px 20px;border-bottom:1px solid var(--border);text-align:center}
.sidebar-avatar{width:72px;height:72px;border-radius:16px;margin:0 auto 12px;display:flex;align-items:center;justify-content:center;font-size:28px;font-weight:700;color:#fff}
.sidebar-name{font-size:16px;font-weight:600;margin-bottom:4px}
.sidebar-role{font-size:11px;color:var(--text2);text-transform:uppercase;letter-spacing:1px}
.sidebar-badges{display:flex;justify-content:center;gap:6px;margin-top:10px;flex-wrap:wrap}
.sidebar-nav{padding:16px 12px}
.nav-section{font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:1px;padding:12px 12px 8px;margin-top:8px}
.nav-btn{display:flex;align-items:center;gap:12px;width:100%;padding:12px 16px;background:transparent;border:none;color:var(--text2);font-size:13px;font-family:inherit;border-radius:10px;cursor:pointer;transition:all 0.2s;text-align:left;position:relative}
.nav-btn:hover{background:rgba(255,255,255,0.03);color:var(--text)}
.nav-btn.active{background:linear-gradient(135deg,rgba(88,166,255,0.15),rgba(63,185,80,0.1));color:var(--text);border:1px solid rgba(88,166,255,0.2)}
.nav-btn-icon{font-size:18px;width:24px;text-align:center}
.nav-btn-badge{position:absolute;right:12px;background:var(--red);color:#fff;font-size:10px;padding:2px 6px;border-radius:8px;font-weight:600}
.main{flex:1;margin-left:260px;display:flex}
.content{flex:1;padding:24px;min-width:0}
.notif-panel{width:300px;background:var(--glass);backdrop-filter:blur(20px);border-left:1px solid var(--border);padding:20px;position:sticky;top:52px;height:calc(100vh - 52px);overflow-y:auto}
@media(max-width:1200px){.notif-panel{display:none}.main{margin-left:0}.sidebar{transform:translateX(-100%)}}
.badge{display:inline-flex;align-items:center;gap:4px;padding:4px 8px;border-radius:6px;font-size:10px;font-weight:600;text-transform:uppercase}
.badge-bronze{background:linear-gradient(135deg,#78350f,#92400e);color:#fef3c7}
.badge-silver{background:linear-gradient(135deg,#374151,#4b5563);color:#f3f4f6}
.badge-gold{background:linear-gradient(135deg,#b45309,#d97706);color:#fef3c7}
.badge-platinum{background:linear-gradient(135deg,#6366f1,#8b5cf6);color:#fff}
.badge-success{background:rgba(63,185,80,0.15);color:var(--green);border:1px solid rgba(63,185,80,0.3)}
.badge-warning{background:rgba(210,153,34,0.15);color:var(--yellow);border:1px solid rgba(210,153,34,0.3)}
.badge-danger{background:rgba(248,81,73,0.15);color:var(--red);border:1px solid rgba(248,81,73,0.3)}
.badge-info{background:rgba(88,166,255,0.15);color:var(--accent);border:1px solid rgba(88,166,255,0.3)}
.badge-premium{background:linear-gradient(135deg,#7c3aed,#a855f7);color:#fff}
.badge-new{background:rgba(163,113,247,0.2);color:var(--purple);border:1px solid rgba(163,113,247,0.4);animation:badgePulse 2s infinite}
.badge-scheduled{background:rgba(88,166,255,0.1);color:var(--accent);border:1px solid rgba(88,166,255,0.3)}
@keyframes badgePulse{0%,100%{opacity:1}50%{opacity:0.6}}
.card{background:var(--glass);backdrop-filter:blur(20px);border:1px solid var(--border);border-radius:16px;padding:20px;margin-bottom:16px}
.card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:8px}
.card-title{font-size:14px;font-weight:600;display:flex;align-items:center;gap:8px}
.glass-card{background:rgba(255,255,255,0.02);border:1px solid var(--border);border-radius:12px;padding:16px}
.grid-2{display:grid;grid-template-columns:repeat(2,1fr);gap:16px}
.grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
.grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:16px}
@media(max-width:1024px){.grid-4{grid-template-columns:repeat(2,1fr)}}
@media(max-width:640px){.grid-2,.grid-3,.grid-4{grid-template-columns:1fr}}
.stat-card{background:var(--glass);border:1px solid var(--border);border-radius:14px;padding:18px;position:relative;overflow:hidden}
.stat-card.green{border-color:rgba(63,185,80,0.3);background:linear-gradient(135deg,rgba(63,185,80,0.05),transparent)}
.stat-card.yellow{border-color:rgba(210,153,34,0.3);background:linear-gradient(135deg,rgba(210,153,34,0.05),transparent)}
.stat-card.purple{border-color:rgba(163,113,247,0.3);background:linear-gradient(135deg,rgba(163,113,247,0.05),transparent)}
.stat-icon{font-size:24px;margin-bottom:8px}
.stat-value{font-size:22px;font-weight:700;margin-bottom:4px}
.stat-label{font-size:11px;color:var(--text2);text-transform:uppercase;letter-spacing:0.5px}
.stat-change{position:absolute;top:12px;right:12px;font-size:10px;padding:3px 6px;border-radius:4px}
.stat-change.up{background:rgba(63,185,80,0.15);color:var(--green)}
.btn{padding:10px 18px;border-radius:10px;font-size:13px;font-weight:600;font-family:inherit;cursor:pointer;transition:all 0.2s;border:none;display:inline-flex;align-items:center;gap:6px}
.btn-primary{background:linear-gradient(135deg,var(--accent),#79c0ff);color:#fff}
.btn-primary:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(88,166,255,0.3)}
.btn-primary:disabled{opacity:0.5;cursor:not-allowed;transform:none}
.btn-secondary{background:var(--bg3);color:var(--text);border:1px solid var(--border)}
.btn-secondary:hover{background:var(--bg4);border-color:var(--accent)}
.btn-success{background:linear-gradient(135deg,var(--green),#39d353);color:#fff}
.btn-danger{background:linear-gradient(135deg,var(--red),#f85149);color:#fff}
.btn-sm{padding:6px 12px;font-size:11px}
.btn-lg{padding:14px 28px;font-size:15px}
.form-group{margin-bottom:16px}
.form-label{display:block;font-size:11px;color:var(--text2);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px}
.form-input,.form-select{width:100%;padding:12px 14px;background:var(--bg3);border:1px solid var(--border);border-radius:10px;color:var(--text);font-size:14px;font-family:inherit}
.form-input:focus,.form-select:focus{outline:none;border-color:var(--accent)}
.form-error{color:var(--red);font-size:11px;margin-top:6px;display:flex;align-items:center;gap:4px}
.form-error a{color:var(--accent);text-decoration:underline;cursor:pointer}
.form-hint{color:var(--green);font-size:11px;margin-top:6px;display:flex;align-items:center;gap:4px}
.score-section{display:flex;align-items:center;gap:32px;padding:32px;background:linear-gradient(135deg,rgba(88,166,255,0.05),rgba(63,185,80,0.03));border:1px solid var(--border);border-radius:20px;margin-bottom:20px}
.score-ring{position:relative;width:140px;height:140px;flex-shrink:0}
.score-ring svg{width:100%;height:100%;transform:rotate(-90deg)}
.score-ring circle{fill:none;stroke-width:8;stroke-linecap:round}
.score-ring .bg{stroke:var(--bg4)}
.score-ring .progress{stroke:url(#scoreGrad);stroke-dasharray:339;transition:stroke-dashoffset 0.6s cubic-bezier(0.4,0,0.2,1)}
.score-inner{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center}
.score-num{font-size:36px;font-weight:700;background:linear-gradient(135deg,var(--accent),var(--green));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.score-lbl{font-size:10px;color:var(--text2);text-transform:uppercase;letter-spacing:1px}
.score-info{flex:1}
.score-title{font-size:22px;font-weight:700;margin-bottom:4px}
.score-sub{color:var(--text2);margin-bottom:16px}
.score-actions{display:flex;gap:10px;margin-bottom:12px;flex-wrap:wrap}
.score-controls{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
.score-ctrl-btn{padding:4px 10px;font-size:10px;background:var(--bg3);border:1px solid var(--border);border-radius:6px;color:var(--text2);cursor:pointer;transition:all 0.2s}
.score-ctrl-btn:hover{border-color:var(--accent);color:var(--text)}
.user-selector{display:flex;gap:6px;margin-bottom:16px;flex-wrap:wrap}
.user-pill{padding:8px 14px;font-size:11px;background:var(--bg3);border:1px solid var(--border);border-radius:20px;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;gap:6px}
.user-pill:hover{border-color:var(--accent);background:var(--bg4)}
.user-pill.active{border-color:var(--accent);background:linear-gradient(135deg,rgba(88,166,255,0.15),rgba(63,185,80,0.1));color:var(--text)}
.user-pill .avatar{font-size:14px}
.tier-bar{display:flex;gap:4px;margin-top:12px}
.tier-item{flex:1;padding:8px;text-align:center;background:var(--bg4);border-radius:8px;font-size:10px;color:var(--text3);transition:all 0.3s}
.tier-item.active{background:linear-gradient(135deg,var(--accent),var(--green));color:#fff;font-weight:600}
.tier-item .tier-name{font-weight:600;margin-bottom:2px}
.tier-item .tier-limit{opacity:0.8}
.send-form{max-width:480px}
.amount-display{display:flex;align-items:baseline;gap:8px;padding:24px;background:var(--bg3);border-radius:14px;margin-bottom:16px}
.amount-value{font-size:40px;font-weight:700}
.amount-currency{font-size:18px;color:var(--text2)}
.rate-info{display:flex;align-items:center;justify-content:space-between;padding:12px;background:rgba(63,185,80,0.05);border:1px solid rgba(63,185,80,0.2);border-radius:10px;margin-bottom:16px}
.rate-value{font-family:'JetBrains Mono',monospace;color:var(--green)}
.receive-amount{display:flex;align-items:center;gap:12px;padding:16px;background:linear-gradient(135deg,rgba(88,166,255,0.1),rgba(63,185,80,0.05));border:1px solid rgba(88,166,255,0.2);border-radius:12px;margin-bottom:20px}
.receive-flag{font-size:32px}
.receive-value{font-size:28px;font-weight:700}
.receive-currency{font-size:14px;color:var(--text2)}
.recipient-card{display:flex;align-items:center;gap:12px;padding:14px;background:var(--bg3);border:1px solid var(--border);border-radius:12px;cursor:pointer;transition:all 0.2s;margin-bottom:10px}
.recipient-card:hover,.recipient-card.selected{border-color:var(--accent);background:rgba(88,166,255,0.05)}
.recipient-avatar{width:44px;height:44px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px}
.recipient-info{flex:1}
.recipient-name{font-weight:600;margin-bottom:2px}
.recipient-detail{font-size:12px;color:var(--text2)}
.schedule-option{display:flex;align-items:center;gap:10px;padding:10px 14px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;cursor:pointer;transition:all 0.2s}
.schedule-option:hover,.schedule-option.active{border-color:var(--accent);background:rgba(88,166,255,0.05)}
.schedule-option input{display:none}
.info-link{font-size:11px;color:var(--accent);cursor:pointer;display:inline-flex;align-items:center;gap:4px;margin-top:8px}
.info-link:hover{text-decoration:underline}
.competitor-compare{background:var(--bg3);border:1px solid var(--border);border-radius:10px;padding:12px;margin-top:12px}
.competitor-compare .title{font-size:10px;color:var(--text2);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px}
.competitor-row{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--border);font-size:12px}
.competitor-row:last-child{border-bottom:none}
.competitor-row .name{color:var(--text2)}
.competitor-row .rate{font-family:'JetBrains Mono',monospace}
.competitor-row.best .rate{color:var(--green);font-weight:600}
.competitor-row.worst .rate{color:var(--red)}
.speed-compare{display:flex;gap:12px;margin-top:12px}
.speed-item{flex:1;padding:10px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;text-align:center}
.speed-item.highlight{border-color:var(--green);background:rgba(63,185,80,0.05)}
.speed-item .label{font-size:10px;color:var(--text2);margin-bottom:4px}
.speed-item .time{font-size:14px;font-weight:600}
.speed-item.highlight .time{color:var(--green)}
.savings-highlight{background:linear-gradient(135deg,rgba(63,185,80,0.15),rgba(57,211,83,0.1));border:1px solid rgba(63,185,80,0.3);border-radius:10px;padding:12px;margin-top:12px;text-align:center}
.savings-highlight .amount{font-size:20px;font-weight:700;color:var(--green)}
.savings-highlight .label{font-size:11px;color:var(--text2)}
.swipe-container{position:relative;max-width:400px;margin:0 auto;min-height:500px;padding-bottom:100px}
.swipe-card{position:absolute;width:100%;background:var(--glass);border:1px solid var(--border);border-radius:20px;padding:24px;cursor:grab;transition:transform 0.3s,opacity 0.3s;user-select:none;margin-bottom:20px}
.swipe-card:active{cursor:grabbing}
.swipe-card.dragging{transition:none}
.swipe-card .header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:20px}
.swipe-card .user-info{display:flex;align-items:center;gap:12px}
.swipe-card .avatar{width:50px;height:50px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:700;color:#fff}
.swipe-card .name{font-weight:600;font-size:15px}
.swipe-card .location{font-size:12px;color:var(--text2)}
.swipe-card .amount-section{text-align:center;padding:24px 0;border-top:1px solid var(--border);border-bottom:1px solid var(--border);margin-bottom:20px}
.swipe-card .amount{font-size:36px;font-weight:700}
.swipe-card .conversion{font-size:14px;color:var(--text2);margin-top:8px}
.swipe-card .corridor-label{font-size:11px;color:var(--accent);margin-top:4px}
.swipe-card .details{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.swipe-card .detail-item{padding:12px;background:var(--bg4);border-radius:10px}
.swipe-card .detail-label{font-size:10px;color:var(--text2);text-transform:uppercase;margin-bottom:4px}
.swipe-card .detail-value{font-weight:600}
.swipe-actions{display:flex;justify-content:center;gap:20px;margin-top:20px;position:relative;z-index:10}
.swipe-btn{width:64px;height:64px;border-radius:50%;border:2px solid var(--border);background:var(--bg3);display:flex;align-items:center;justify-content:center;font-size:24px;cursor:pointer;transition:all 0.2s}
.swipe-btn.pass:hover{border-color:var(--red);background:rgba(248,81,73,0.1);transform:scale(1.1)}
.swipe-btn.match:hover{border-color:var(--green);background:rgba(63,185,80,0.1);transform:scale(1.1)}
.swipe-hint{text-align:center;font-size:12px;color:var(--text3);margin-top:16px}
.empty-state{text-align:center;padding:60px 20px}
.empty-icon{font-size:48px;margin-bottom:16px;opacity:0.5}
.empty-title{font-size:18px;font-weight:600;margin-bottom:8px}
.empty-text{color:var(--text2);margin-bottom:20px}
.timeline{position:relative;padding-left:28px}
.timeline::before{content:'';position:absolute;left:8px;top:0;bottom:0;width:2px;background:var(--border)}
.timeline-item{position:relative;padding-bottom:24px}
.timeline-item:last-child{padding-bottom:0}
.timeline-dot{position:absolute;left:-22px;width:18px;height:18px;border-radius:50%;border:2px solid var(--border);background:var(--bg3);display:flex;align-items:center;justify-content:center;font-size:8px}
.timeline-dot.active{border-color:var(--accent);background:var(--accent);color:#fff;animation:dotPulse 2s infinite}
.timeline-dot.complete{border-color:var(--green);background:var(--green);color:#fff}
.timeline-dot.pending{border-color:var(--text3)}
@keyframes dotPulse{0%,100%{box-shadow:0 0 0 0 rgba(88,166,255,0.4)}50%{box-shadow:0 0 0 8px rgba(88,166,255,0)}}
.timeline-content{padding-left:8px}
.timeline-title{font-weight:600;margin-bottom:4px;display:flex;align-items:center;gap:8px}
.timeline-time{font-size:11px;color:var(--text2)}
.timeline-desc{font-size:12px;color:var(--text2);margin-top:4px}
.order-item{display:flex;align-items:center;gap:16px;padding:14px;background:var(--bg3);border:1px solid var(--border);border-radius:12px;margin-bottom:10px}
.order-item.highlight{border-color:var(--accent);background:rgba(88,166,255,0.05);animation:highlightPulse 2s infinite}
@keyframes highlightPulse{0%,100%{box-shadow:0 0 0 0 rgba(88,166,255,0.2)}50%{box-shadow:0 0 0 4px rgba(88,166,255,0.1)}}
.order-item.new{border-color:var(--purple);background:rgba(163,113,247,0.05)}
.order-corridor{font-size:18px}
.order-details{flex:1}
.order-amount{font-weight:600;margin-bottom:2px}
.order-rate{font-size:12px;color:var(--text2)}
.order-score{text-align:right}
.order-score-value{font-size:18px;font-weight:700;color:var(--green)}
.order-score-label{font-size:10px;color:var(--text2)}
.position-card{padding:16px;background:var(--bg3);border:1px solid var(--border);border-radius:12px;margin-bottom:12px;cursor:pointer;transition:all 0.2s}
.position-card:hover{border-color:var(--accent)}
.position-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.position-pair{font-weight:600;display:flex;align-items:center;gap:8px}
.position-util{font-size:12px;color:var(--text2)}
.position-bar{height:8px;background:var(--bg4);border-radius:4px;overflow:hidden}
.position-fill{height:100%;border-radius:4px;transition:width 0.5s}
.payout-card{padding:16px;background:var(--bg3);border:1px solid var(--border);border-radius:12px;margin-bottom:12px}
.payout-card.pending{border-color:var(--yellow)}
.payout-card.ready{border-color:var(--green);background:rgba(63,185,80,0.05)}
.payout-header{display:flex;justify-content:space-between;margin-bottom:12px}
.payout-amount{font-size:20px;font-weight:700}
.payout-details{display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:12px}
.payout-label{color:var(--text2)}
.tx-row{display:flex;align-items:center;gap:12px;padding:14px;background:var(--bg3);border:1px solid var(--border);border-radius:10px;margin-bottom:8px;cursor:pointer;transition:all 0.2s}
.tx-row:hover{border-color:var(--accent)}
.tx-row.suspicious{border-color:var(--yellow);background:rgba(210,153,34,0.05)}
.tx-row.highlight{border-color:var(--purple);background:rgba(163,113,247,0.05)}
.tx-icon{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px}
.tx-info{flex:1;min-width:0}
.tx-title{font-weight:600;margin-bottom:2px;display:flex;align-items:center;gap:6px;flex-wrap:wrap}
.tx-detail{font-size:12px;color:var(--text2)}
.tx-amount{text-align:right}
.tx-value{font-weight:600}
.tx-status{font-size:11px;color:var(--text2)}
.notif-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--border)}
.notif-title{font-weight:600;display:flex;align-items:center;gap:8px}
.notif-count{background:var(--accent);color:#fff;font-size:10px;padding:2px 6px;border-radius:8px}
.notif-list{display:flex;flex-direction:column;gap:8px}
.notif-item{padding:12px;background:var(--bg3);border:1px solid var(--border);border-radius:10px;font-size:12px;transition:all 0.3s;animation:slideIn 0.3s ease}
@keyframes slideIn{from{opacity:0;transform:translateX(20px)}to{opacity:1;transform:translateX(0)}}
.notif-item.success{border-color:rgba(63,185,80,0.3);background:rgba(63,185,80,0.05)}
.notif-item.warning{border-color:rgba(210,153,34,0.3);background:rgba(210,153,34,0.05)}
.notif-item.info{border-color:rgba(88,166,255,0.3);background:rgba(88,166,255,0.05)}
.notif-item .time{font-size:10px;color:var(--text3);margin-top:4px}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;z-index:2000;opacity:0;visibility:hidden;transition:all 0.3s;padding:16px;padding-top:calc(16px + env(safe-area-inset-top));padding-bottom:calc(16px + env(safe-area-inset-bottom))}
.modal-overlay.active{opacity:1;visibility:visible}
.modal{background:var(--bg2);border:1px solid var(--border);border-radius:20px;padding:28px;max-width:560px;width:90%;max-height:calc(85vh - env(safe-area-inset-top) - env(safe-area-inset-bottom));overflow-y:auto;transform:scale(0.9);transition:transform 0.3s}
.modal-overlay.active .modal{transform:scale(1)}
@media(max-width:640px){
.modal{padding:20px;max-height:90vh;width:95%;border-radius:16px}
.modal-header{margin-bottom:16px}
.modal-title{font-size:16px}
.modal-close{min-width:36px;min-height:36px}
}
.modal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px}
.modal-title{font-size:18px;font-weight:700}
.modal-close{width:32px;height:32px;border-radius:8px;border:none;background:var(--bg3);color:var(--text2);cursor:pointer;display:flex;align-items:center;justify-content:center}
.modal-close:hover{background:var(--bg4);color:var(--text)}
.modal-body{margin-bottom:20px}
.modal-footer{display:flex;gap:10px;justify-content:flex-end}
.match-summary{text-align:center;padding:20px}
.match-icon{font-size:64px;margin-bottom:16px}
.match-title{font-size:24px;font-weight:700;margin-bottom:8px}
.match-detail{color:var(--text2);margin-bottom:20px}
.match-stats{display:grid;grid-template-columns:1fr 1fr;gap:12px;text-align:left}
.match-stat{padding:12px;background:var(--bg3);border-radius:10px}
.match-stat-label{font-size:10px;color:var(--text2);text-transform:uppercase;margin-bottom:4px}
.match-stat-value{font-weight:600}
.toast{position:fixed;bottom:calc(24px + env(safe-area-inset-bottom));right:24px;background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:14px 20px;display:flex;align-items:center;gap:12px;z-index:3000;transform:translateY(100px);opacity:0;transition:all 0.3s}
.toast.active{transform:translateY(0);opacity:1}
.toast.success{border-color:var(--green);background:linear-gradient(135deg,var(--bg2),rgba(63,185,80,0.1))}
.toast.error{border-color:var(--red);background:linear-gradient(135deg,var(--bg2),rgba(248,81,73,0.1))}
.toast.warning{border-color:var(--yellow)}
.toast.info{border-color:var(--accent)}
.toast-icon{font-size:20px}
.toast-msg{font-size:13px}
.guided-highlight{position:relative}
.guided-highlight::after{content:'';position:absolute;inset:-4px;border:2px solid var(--purple);border-radius:inherit;animation:guidedPulse 1.5s infinite;pointer-events:none}
@keyframes guidedPulse{0%,100%{opacity:1}50%{opacity:0.5}}
.guided-progress{background:var(--bg4);border-radius:8px;padding:8px 12px;margin-bottom:16px;font-size:11px;display:flex;align-items:center;gap:8px}
.guided-progress .step{color:var(--purple);font-weight:600}
.investor-highlight{background:linear-gradient(135deg,rgba(88,166,255,0.1),rgba(63,185,80,0.05));border:1px solid rgba(88,166,255,0.2);border-radius:10px;padding:12px;margin-top:12px}
.investor-highlight .title{font-size:10px;color:var(--accent);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px}
.investor-highlight .value{font-size:18px;font-weight:700;color:var(--green)}
.investor-highlight .sub{font-size:11px;color:var(--text2)}
.fraud-bar{height:20px;background:var(--bg4);border-radius:4px;overflow:hidden;margin:8px 0}
.fraud-bar-fill{height:100%;background:linear-gradient(90deg,var(--yellow),var(--red));transition:width 0.5s}
.badge-collusion{background:rgba(248,81,73,0.2);color:var(--red);border:1px solid rgba(248,81,73,0.4)}
.revenue-breakdown{display:grid;gap:8px;margin-top:12px}
.revenue-row{display:flex;justify-content:space-between;padding:8px 12px;background:var(--bg3);border-radius:8px;font-size:12px}
.revenue-row .label{color:var(--text2)}
.revenue-row .value{font-weight:600;color:var(--green)}
.corridor-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px}
.corridor-card{padding:14px;background:var(--bg3);border:1px solid var(--border);border-radius:12px;cursor:pointer;transition:all 0.2s}
.corridor-card:hover{border-color:var(--accent);transform:translateY(-2px)}
.corridor-card .flags{font-size:24px;margin-bottom:8px}
.corridor-card .route{font-weight:600;margin-bottom:4px}
.corridor-card .volume{font-size:12px;color:var(--text2)}
.corridor-card .rate{font-size:11px;color:var(--green);font-family:'JetBrains Mono',monospace}
.settlement-leg{display:flex;align-items:flex-start;gap:12px;padding:12px;background:var(--bg3);border-radius:10px;margin-bottom:8px}
.settlement-leg .status{width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;flex-shrink:0}
.settlement-leg .status.complete{background:var(--green);color:#fff}
.settlement-leg .status.active{background:var(--accent);color:#fff;animation:dotPulse 2s infinite}
.settlement-leg .status.pending{background:var(--bg4);color:var(--text3)}
.settlement-leg .content{flex:1}
.settlement-leg .title{font-weight:600;margin-bottom:2px}
.settlement-leg .desc{font-size:12px;color:var(--text2)}
.settlement-leg .time{font-size:10px;color:var(--text3);margin-top:4px}
.liquidity-modal{display:grid;gap:16px}
.liquidity-input{display:flex;gap:12px;align-items:flex-end}
.liquidity-input .form-group{flex:1;margin-bottom:0}
.corridor-detail-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px}
.corridor-stat{padding:12px;background:var(--bg3);border-radius:8px;text-align:center}
.corridor-stat .value{font-size:20px;font-weight:700;margin-bottom:2px}
.corridor-stat .label{font-size:10px;color:var(--text2);text-transform:uppercase}
.mini-tx-list{max-height:200px;overflow-y:auto}
.mini-tx{display:flex;justify-content:space-between;padding:8px 12px;background:var(--bg4);border-radius:6px;margin-bottom:4px;font-size:12px}
.mode-indicator{font-size:10px;padding:4px 8px;border-radius:4px;margin-left:8px}
.mode-indicator.guided{background:rgba(163,113,247,0.2);color:var(--purple)}
.mode-indicator.free{background:rgba(210,153,34,0.2);color:var(--yellow)}
.kb-hint{font-size:9px;color:var(--text3);padding:2px 4px;background:var(--bg4);border-radius:3px;font-family:'JetBrains Mono',monospace}
@media(max-width:640px){
.kb-hint{padding:4px 8px;font-size:10px;min-width:24px;text-align:center}
}
.kyc-status{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;border-radius:8px;font-size:11px;font-weight:600}
.kyc-verified{background:rgba(63,185,80,0.15);color:var(--green);border:1px solid rgba(63,185,80,0.3)}
.kyc-pending{background:rgba(210,153,34,0.15);color:var(--yellow);border:1px solid rgba(210,153,34,0.3)}
.kyc-rejected{background:rgba(248,81,73,0.15);color:var(--red);border:1px solid rgba(248,81,73,0.3)}
.profile-header{display:flex;align-items:center;gap:20px;padding:24px;background:linear-gradient(135deg,rgba(88,166,255,0.08),rgba(63,185,80,0.05));border-radius:16px;margin-bottom:20px}
.profile-avatar{width:96px;height:96px;border-radius:20px;display:flex;align-items:center;justify-content:center;font-size:40px;flex-shrink:0}
.profile-info{flex:1}
.profile-name{font-size:24px;font-weight:700;margin-bottom:4px}
.profile-meta{font-size:13px;color:var(--text2);margin-bottom:12px}
.profile-badges{display:flex;gap:8px;flex-wrap:wrap}
.doc-item{display:flex;align-items:center;justify-content:space-between;padding:14px;background:var(--bg3);border:1px solid var(--border);border-radius:10px;margin-bottom:10px}
.doc-info{display:flex;align-items:center;gap:12px}
.doc-icon{width:40px;height:40px;border-radius:8px;background:rgba(88,166,255,0.1);display:flex;align-items:center;justify-content:center;font-size:18px}
.doc-details{flex:1}
.doc-name{font-weight:600;font-size:13px;margin-bottom:2px}
.doc-meta{font-size:11px;color:var(--text2)}

/* ============ MOBILE RESPONSIVE FIXES ============ */
/* Safe area padding for notched devices */
body{padding-top:env(safe-area-inset-top);padding-bottom:env(safe-area-inset-bottom)}
.app{padding-top:calc(52px + env(safe-area-inset-top));padding-bottom:calc(20px + env(safe-area-inset-bottom))}
.content{padding-bottom:calc(40px + env(safe-area-inset-bottom))}

/* CRITICAL FIX: Add extra top padding on mobile when demo bar wraps */
@media(max-width:800px){
.app{padding-top:calc(120px + env(safe-area-inset-top))}
}
@media(max-width:600px){
.app{padding-top:calc(100px + env(safe-area-inset-top))}
}

/* Hamburger Menu */
.hamburger-btn{display:none;width:44px;height:44px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;align-items:center;justify-content:center;cursor:pointer;font-size:20px;color:var(--text);transition:all 0.2s}
.hamburger-btn:hover{background:var(--bg4);border-color:var(--accent)}
.mobile-menu-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);backdrop-filter:blur(4px);z-index:1500;opacity:0;visibility:hidden;transition:all 0.3s}
.mobile-menu-overlay.active{opacity:1;visibility:visible}
.mobile-menu{position:fixed;top:0;left:0;bottom:0;width:280px;background:var(--glass);backdrop-filter:blur(20px);border-right:1px solid var(--border);z-index:1600;transform:translateX(-100%);transition:transform 0.3s;overflow-y:auto;padding-top:env(safe-area-inset-top)}
.mobile-menu.active{transform:translateX(0)}
.mobile-menu-header{padding:20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.mobile-menu-close{width:44px;height:44px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:20px;color:var(--text2)}
.mobile-menu-close:hover{background:var(--bg4);color:var(--text)}

/* Mobile-specific overrides */
@media(max-width:1200px){
.hamburger-btn{display:flex}
.sidebar{transform:translateX(-100%)}
.main{margin-left:0}
}

/* Header button wrapping and mobile sizing */
@media(max-width:800px){
.demo-bar{flex-wrap:wrap;padding:8px 12px;gap:8px}
.demo-bar-left,.demo-bar-right{gap:8px}
.demo-bar-right{flex-wrap:wrap}
.demo-logo{font-size:16px}
.demo-bar select{padding:6px 10px;font-size:11px;min-width:120px}
.reset-btn,.guided-btn,.scenario-btn,.replay-btn,.mode-btn{padding:6px 10px;font-size:10px;min-width:70px;height:36px}
.savings-ticker{font-size:10px;padding:4px 8px}
.live-badge{font-size:10px;padding:4px 8px}
}

/* Hide non-essential buttons on very small screens */
@media(max-width:600px){
.scenario-btn,.mode-btn{display:none}
}

/* Swipe container mobile fix */
@media(max-width:480px){
.swipe-container{max-width:100%;padding:0 16px;height:auto;min-height:400px}
.swipe-card{max-width:340px;margin:0 auto}
.amount-value{font-size:32px}
}

/* Modal grid collapse on mobile */
@media(max-width:640px){
.match-stats,.corridor-detail-grid,.payout-details{display:flex;flex-direction:column;gap:12px}
.corridor-grid{grid-template-columns:1fr}
.grid-2{grid-template-columns:1fr}
}

/* Toast mobile overflow fix */
.toast{max-width:calc(100vw - 48px);word-break:break-word}

/* Tap target improvements - all buttons minimum 44px */
@media(max-width:768px){
.btn{min-height:44px;padding:12px 20px}
.btn-sm{min-height:40px;padding:8px 14px}
.swipe-btn{width:70px;height:70px}
.nav-btn{min-height:48px}
.user-pill{min-height:40px;padding:10px 16px}
}

/* Profile header mobile stacking */
@media(max-width:640px){
.profile-header{flex-direction:column;text-align:center;align-items:center}
.profile-avatar{margin-bottom:16px}
.profile-badges{justify-content:center}
}

/* Score section mobile layout */
@media(max-width:640px){
.score-section{flex-direction:column;align-items:center;text-align:center;gap:20px}
.score-ring{width:120px;height:120px}
.score-num{font-size:28px}
}

/* Transaction row mobile stacking */
@media(max-width:480px){
.tx-row{flex-direction:column;align-items:flex-start;gap:8px}
.tx-amount{text-align:left;margin-top:4px}
}

/* Modal mobile improvements */
@media(max-width:640px){
.modal{width:95%;padding:20px;max-height:90vh}
.modal-header{flex-wrap:wrap}
.modal-close{min-width:44px;min-height:44px}
.modal-footer{flex-wrap:wrap}
.modal-footer .btn{flex:1;min-width:120px}
}

/* Card overflow protection */
.card{overflow-wrap:break-word;word-break:break-word}

/* Recipient card mobile */
@media(max-width:480px){
.recipient-avatar{width:36px;height:36px;font-size:16px}
.recipient-card{padding:12px}
}

/* Order item mobile */
@media(max-width:480px){
.order-item{flex-wrap:wrap;gap:12px}
.order-score{width:100%;text-align:left}
}

/* Revenue row mobile */
@media(max-width:480px){
.revenue-row{flex-direction:column;gap:4px;align-items:flex-start}
.revenue-row .label{margin-right:0}
}

/* Doc item mobile */
@media(max-width:480px){
.doc-item{flex-direction:column;align-items:flex-start;gap:12px}
}

/* Content padding mobile */
@media(max-width:768px){
.content{padding:16px}
}

/* Stat grid responsive */
@media(max-width:640px) and (min-width:480px){
.grid-4{grid-template-columns:repeat(2,1fr)}
}
</style>
</head>
<body>
<svg style="position:absolute;width:0;height:0"><defs><linearGradient id="scoreGrad" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" stop-color="#58a6ff"/><stop offset="100%" stop-color="#3fb950"/></linearGradient></defs></svg>
<div class="ambient"></div>
<div class="demo-bar">
<div class="demo-bar-left">
<button class="hamburger-btn" onclick="toggleMobileMenu()" title="Menu">‚ò∞</button>
<div class="demo-logo">‚ö° FlowBridge</div>
<div class="live-badge"><span class="live-dot"></span>DEMO v4</div>
<select id="roleSelect" onchange="switchRole(this.value)">
<option value="sender">üë§ Sender</option>
<option value="lp">üè¶ Liquidity Provider</option>
<option value="anchor">üè™ Anchor (Ghana)</option>
<option value="receiver">üì± Receiver (Kofi)</option>
<option value="admin">‚öôÔ∏è Admin / Investor</option>
</select>
<span class="mode-indicator" id="modeIndicator">GUIDED</span>
</div>
<div class="demo-bar-right">
<div class="savings-ticker">üí∞ Saved: <span class="value" id="savingsTicker">$847,293</span></div>
<button class="scenario-btn" onclick="showScenarioModal()" title="Load demo scenario">üéØ Scenarios</button>
<button class="replay-btn" onclick="replayFullDemo()" title="Restart guided demo">üîÅ Replay</button>
<button class="mode-btn" id="modeBtn" onclick="toggleMode()" title="Toggle guided/free mode">üéØ Mode</button>
<button class="guided-btn" id="guidedBtn" onclick="toggleGuidedDemo()" title="Toggle step-by-step guidance">üéì Guide</button>
<button class="reset-btn" onclick="resetDemo()" title="Reset all demo state">‚Ü∫ Reset</button>
<button class="reset-btn" onclick="showKeyboardShortcutsModal()" title="View keyboard shortcuts">‚å®Ô∏è</button>
</div>
</div>
<div class="mobile-menu-overlay" id="mobileMenuOverlay" onclick="toggleMobileMenu()"></div>
<div class="mobile-menu" id="mobileMenu" onclick="event.stopPropagation()">
<div class="mobile-menu-header">
<div class="demo-logo">‚ö° FlowBridge</div>
<button class="mobile-menu-close" onclick="toggleMobileMenu()">‚úï</button>
</div>
<div id="mobileMenuContent"></div>
</div>
<div class="app">
<aside class="sidebar" id="sidebar"></aside>
<main class="main">
<section class="content" id="content"></section>
<aside class="notif-panel" id="notifPanel"></aside>
</main>
</div>
<div class="modal-overlay" id="modalOverlay" onclick="closeModal(event)">
<div class="modal" id="modal" onclick="event.stopPropagation()"></div>
</div>
<div class="toast" id="toast"></div>
<script>
// ============ DATA STRUCTURES ============
const CURRENCIES={USD:{name:'US Dollar',symbol:'$',flag:'üá∫üá∏'},AED:{name:'UAE Dirham',symbol:'ÿØ.ÿ•',flag:'üá¶üá™'},NGN:{name:'Nigerian Naira',symbol:'‚Ç¶',flag:'üá≥üá¨'},GBP:{name:'British Pound',symbol:'¬£',flag:'üá¨üáß'},EUR:{name:'Euro',symbol:'‚Ç¨',flag:'üá™üá∫'},INR:{name:'Indian Rupee',symbol:'‚Çπ',flag:'üáÆüá≥'},PHP:{name:'Philippine Peso',symbol:'‚Ç±',flag:'üáµüá≠'},KES:{name:'Kenyan Shilling',symbol:'KSh',flag:'üá∞üá™'},GHS:{name:'Ghanaian Cedi',symbol:'‚Çµ',flag:'üá¨üá≠'},ZAR:{name:'South African Rand',symbol:'R',flag:'üáøüá¶'},MXN:{name:'Mexican Peso',symbol:'$',flag:'üá≤üáΩ'},PKR:{name:'Pakistani Rupee',symbol:'‚Ç®',flag:'üáµüá∞'},BDT:{name:'Bangladeshi Taka',symbol:'‡ß≥',flag:'üáßüá©'},ZWL:{name:'Zimbabwe Dollar',symbol:'Z$',flag:'üáøüáº'}};

// Amount mode state
let amountMode = 'send'; // 'send' or 'receive'
let pricingCollapsed = true;
let recipientCollapsed = true; // Recipient section collapsed by default

const RATES={USD:{NGN:1580,INR:83.2,PHP:56.1,KES:154,GHS:15.4,ZAR:18.7,MXN:17.2,PKR:278,BDT:110,GBP:0.79,EUR:0.92,AED:3.67,ZWL:363},AED:{NGN:430,INR:22.6,PHP:15.2,KES:42,GHS:4.2,ZAR:5.1,PKR:75.6,BDT:30,USD:0.272,GBP:0.215,EUR:0.25,ZWL:99},GBP:{NGN:2000,INR:105,PHP:71,KES:195,GHS:19.5,ZAR:23.7,USD:1.27,EUR:1.17,AED:4.65,ZWL:460,PKR:352},EUR:{NGN:1720,INR:90.5,PHP:61,USD:1.09,GBP:0.86,AED:4.0,ZWL:395}};

const TRAD_RATES={USD:{NGN:1520,INR:81.5,PHP:54.8,GHS:14.8,MXN:16.8,ZWL:340},AED:{NGN:410,INR:21.8,PHP:14.6,GHS:4.0,ZWL:92},GBP:{NGN:1920,INR:101,GHS:18.5,ZWL:440}};

const COMPETITORS={western_union:{name:'Western Union',markup:0.045,fee:8},moneygram:{name:'MoneyGram',markup:0.038,fee:6},wise:{name:'Wise',markup:0.012,fee:3},bank:{name:'Bank Wire',markup:0.055,fee:25}};

// ============ CORRIDOR PRICING ENGINE ============
const corridorPricing = {
  1: { lp: 0.50, anchor: 0.50, fb: 0.25 },
  2: { lp: 1.00, anchor: 1.00, fb: 0.50 },
  3: { lp: 1.50, anchor: 1.50, fb: 0.75 },
  4: { lp: 2.50, anchor: 2.50, fb: 1.00 }
};

// Default pricing for backwards compatibility
let defaultCorridorPricing = JSON.parse(JSON.stringify(corridorPricing));

function calculatePricing(tier, txAmountUSD) {
  const p = corridorPricing[tier];
  if (!p) return { lpFee: 0, anchorFee: 0, fbMargin: 0, totalFee: 0, effCostPct: 0 };
  const totalFee = p.lp + p.anchor + p.fb;
  return {
    lpFee: p.lp,
    anchorFee: p.anchor,
    fbMargin: p.fb,
    totalFee,
    effCostPct: txAmountUSD ? (totalFee / txAmountUSD * 100) : 0
  };
}

function simulateDynamicPricing(base, LPI, VIXc, RPS) {
  // base = { lp, anchor, fb }
  // LPI = Liquidity Pressure Index (0-1): higher = less liquidity available
  // VIXc = Volatility Index for corridor (0-0.3): currency volatility
  // RPS = Risk Profile Score (0-1): higher = more risk
  
  const liquidityMultiplier = 1 + (LPI * 0.5); // Up to 50% increase
  const volatilityMultiplier = 1 + (VIXc * 2); // Up to 60% increase
  const riskMultiplier = 1 + (RPS * 0.3); // Up to 30% increase
  
  const combinedMultiplier = liquidityMultiplier * volatilityMultiplier * riskMultiplier;
  
  return {
    lp: base.lp * combinedMultiplier,
    anchor: base.anchor * combinedMultiplier,
    fb: base.fb * combinedMultiplier,
    multiplier: combinedMultiplier
  };
}

const TOP_CORRIDORS=[
{from:'AED',to:'NGN',vol:'$2.4M',name:'UAE ‚Üí Nigeria',txCount:847,avgSize:2834,revenue:36000,fraudFlags:2,fromCountry:'UAE',toCountry:'Nigeria',isLive:true,lpIds:['kwame'],anchorIds:['mtn'],requiresHop:false,tier:2},
{from:'USD',to:'INR',vol:'$4.1M',name:'US ‚Üí India',txCount:1234,avgSize:3324,revenue:61500,fraudFlags:0,fromCountry:'USA',toCountry:'India',isLive:true,lpIds:['raj'],anchorIds:['upi'],requiresHop:false,tier:1},
{from:'GBP',to:'INR',vol:'$1.8M',name:'UK ‚Üí India',txCount:542,avgSize:3321,revenue:27000,fraudFlags:1,fromCountry:'UK',toCountry:'India',isLive:true,lpIds:['raj'],anchorIds:['upi'],requiresHop:false,tier:1},
{from:'AED',to:'PHP',vol:'$1.6M',name:'UAE ‚Üí Philippines',txCount:623,avgSize:2568,revenue:24000,fraudFlags:0,fromCountry:'UAE',toCountry:'Philippines',isLive:true,lpIds:['kwame','chen'],anchorIds:['gcash'],requiresHop:true,hopPath:['kwame','chen'],tier:3},
{from:'USD',to:'MXN',vol:'$3.2M',name:'US ‚Üí Mexico',txCount:1156,avgSize:2768,revenue:48000,fraudFlags:3,fromCountry:'USA',toCountry:'Mexico',isLive:true,lpIds:['jose'],anchorIds:['jose'],requiresHop:false,tier:2},
{from:'AED',to:'GHS',vol:'$890K',name:'UAE ‚Üí Ghana',txCount:312,avgSize:2853,revenue:13350,fraudFlags:0,fromCountry:'UAE',toCountry:'Ghana',isLive:true,lpIds:['kwame'],anchorIds:['kwame'],requiresHop:false,tier:1},
{from:'GBP',to:'ZWL',vol:'$520K',name:'UK ‚Üí Zimbabwe',txCount:187,avgSize:2781,revenue:7800,fraudFlags:0,fromCountry:'UK',toCountry:'Zimbabwe',isLive:true,lpIds:['kwame'],anchorIds:['ecocash'],requiresHop:false,tier:4},
{from:'AED',to:'KES',vol:'$1.1M',name:'UAE ‚Üí Kenya',txCount:398,avgSize:2764,revenue:16500,fraudFlags:1,fromCountry:'UAE',toCountry:'Kenya',isLive:true,lpIds:['kwame'],anchorIds:['mpesa'],requiresHop:false,tier:2}
];

const TIER_LIMITS={bronze:{daily:500,monthly:2000,perTx:300,label:'Bronze'},silver:{daily:2000,monthly:10000,perTx:1500,label:'Silver'},gold:{daily:5000,monthly:25000,perTx:4000,label:'Gold'},platinum:{daily:15000,monthly:100000,perTx:10000,label:'Platinum'}};

// Multi-user system with distinct tiers and limits  
// FIX 3: Added monthlyUsed and flagged properties
const USERS={
  aisha:{id:'USR-1001',name:'Aisha Okonkwo',email:'aisha@email.com',tier:'gold',score:87,avatar:'üá≥üá¨',color:'#3fb950',premium:true,baseCur:'AED',dailyUsed:1200,monthlyUsed:8500,flagged:false},
  chidi:{id:'USR-2002',name:'Chidi Nwankwo',email:'chidi@email.com',tier:'silver',score:68,avatar:'üá¨üá≠',color:'#58a6ff',premium:false,baseCur:'AED',dailyUsed:800,monthlyUsed:4200,flagged:false},
  priya:{id:'USR-3003',name:'Priya Sharma',email:'priya@email.com',tier:'bronze',score:42,avatar:'üáÆüá≥',color:'#a371f7',premium:false,baseCur:'USD',dailyUsed:150,monthlyUsed:900,flagged:false},
  platinum:{id:'USR-9999',name:'Sarah Al-Mansouri',email:'sarah@email.com',tier:'platinum',score:95,avatar:'üíé',color:'#8b5cf6',premium:true,baseCur:'AED',dailyUsed:500,monthlyUsed:15000,flagged:false}
};

let activeSenderId='aisha'; // Currently selected sender

// Multi-LP profiles with routing capabilities
const LP_PROFILES={
  kwame:{name:'Kwame (Africa)',avatar:'üè¶',region:'Africa',homeCountry:'Ghana',revenue:18472,status:'active',positions:{AED_NGN:{available:125000,locked:45000,rate:431.5,util:0.265},AED_GHS:{available:55000,locked:15000,rate:4.21,util:0.214},AED_KES:{available:42000,locked:8000,rate:42,util:0.16}},supportedCorridors:['AED_NGN','AED_GHS','AED_KES','GBP_NGN'],canHopTo:['chen']},
  jose:{name:'Jose (LatAm)',avatar:'üåé',region:'LatAm',homeCountry:'Mexico',revenue:23150,status:'active',positions:{USD_MXN:{available:98000,locked:35000,rate:17.2,util:0.263},GBP_MXN:{available:45000,locked:12000,rate:21.8,util:0.21}},supportedCorridors:['USD_MXN','GBP_MXN'],canHopTo:[]},
  raj:{name:'Raj (India)',avatar:'üáÆüá≥',region:'India',homeCountry:'India',revenue:31200,status:'active',positions:{USD_INR:{available:89000,locked:31000,rate:83.3,util:0.258},GBP_INR:{available:67000,locked:18000,rate:105,util:0.212}},supportedCorridors:['USD_INR','GBP_INR','AED_INR'],canHopTo:[]},
  chen:{name:'Chen (Asia)',avatar:'üá®üá≥',region:'Asia',homeCountry:'Philippines',revenue:27800,status:'active',positions:{AED_PHP:{available:67000,locked:23000,rate:15.2,util:0.256},USD_PHP:{available:78000,locked:22000,rate:56.1,util:0.22}},supportedCorridors:['AED_PHP','USD_PHP','GBP_PHP'],canHopTo:[]}
};

let activeLPId='kwame';

// Multi-Anchor profiles with corridor support
const ANCHOR_PROFILES={
  mpesa:{name:'M-Pesa Kenya',avatar:'üá∞üá™',country:'Kenya',currency:'KES',pending:3,completed:47,balance:125000,commission:2340,supportedCorridors:['AED_KES','USD_KES','GBP_KES'],status:'active'},
  gcash:{name:'GCash Philippines',avatar:'üáµüá≠',country:'Philippines',currency:'PHP',pending:2,completed:38,balance:89000,commission:1890,supportedCorridors:['AED_PHP','USD_PHP','GBP_PHP'],status:'active'},
  upi:{name:'UPI India',avatar:'üáÆüá≥',country:'India',currency:'INR',pending:1,completed:62,balance:156000,commission:3100,supportedCorridors:['USD_INR','GBP_INR','AED_INR'],status:'active'},
  mtn:{name:'MTN Mobile Money',avatar:'üá≥üá¨',country:'Nigeria',currency:'NGN',pending:4,completed:55,balance:187000,commission:2750,supportedCorridors:['AED_NGN','USD_NGN','GBP_NGN'],status:'active'},
  ecocash:{name:'EcoCash Zimbabwe',avatar:'üáøüáº',country:'Zimbabwe',currency:'ZWL',pending:1,completed:24,balance:34000,commission:850,supportedCorridors:['GBP_ZWL','USD_ZWL'],status:'active'}
};

let activeAnchorId='mpesa';

// Multi-Receiver profiles mapped to recipient countries
const RECEIVER_PROFILES={
  ghana:{name:'Kofi Mensah',avatar:'üá¨üá≠',method:'Mobile Money',country:'Ghana',currency:'GHS',balance:2500},
  philippines:{name:'Grace Reyes',avatar:'üáµüá≠',method:'Bank Transfer',country:'Philippines',currency:'PHP',balance:8500},
  india:{name:'Raj Patel',avatar:'üáÆüá≥',method:'UPI',country:'India',currency:'INR',balance:12000},
  zimbabwe:{name:'Tendai Moyo',avatar:'üáøüáº',method:'EcoCash',country:'Zimbabwe',currency:'ZWL',balance:3200},
  nigeria:{name:'Emeka Obi',avatar:'üá≥üá¨',method:'Bank Transfer',country:'Nigeria',currency:'NGN',balance:15000}
};

let activeReceiverId='ghana';

const RECIPIENTS=[
{id:'RCP-001',name:'Kofi Mensah',country:'Ghana',flag:'üá¨üá≠',method:'Mobile Money',account:'**** 4521',cur:'GHS'},
{id:'RCP-002',name:'Grace Reyes',country:'Philippines',flag:'üáµüá≠',method:'Bank Transfer',account:'**** 8832',cur:'PHP'},
{id:'RCP-003',name:'Raj Patel',country:'India',flag:'üáÆüá≥',method:'UPI',account:'**** 6677',cur:'INR'},
{id:'RCP-004',name:'Tendai Moyo',country:'Zimbabwe',flag:'üáøüáº',method:'EcoCash',account:'**** 3344',cur:'ZWL'},
{id:'RCP-005',name:'Emeka Obi',country:'Nigeria',flag:'üá≥üá¨',method:'Bank Transfer',account:'**** 7712',cur:'NGN'}
];

// Enhanced SWIPE data with multiple LPs per corridor
const SWIPE=[
  // AED ‚Üí NGN corridor (Nigeria) - Exactly 3 LPs
  {id:'AED_NGN_LP1',corridor:'AED-NGN',name:'Ibrahim T.',flag:'üá≥üá¨',city:'Lagos, Nigeria',proximity:'Cross-border LP',lpType:'Nigeria-based LP',reliability:85,settlement:'5 min',rateDeltaPct:-0.12,score:72,avatar:'#ef4444',badgeHint:'Closest LP',lpProfileId:'kwame'},
  {id:'AED_NGN_LP2',corridor:'AED-NGN',name:'Fatima A.',flag:'üá≥üá¨',city:'Sharjah, UAE',proximity:'Local LP',lpType:'Local Exchange',reliability:89,settlement:'2 min',rateDeltaPct:0.38,score:81,avatar:'#a855f7',badgeHint:'Fastest payout',lpProfileId:'kwame'},
  {id:'AED_NGN_LP3',corridor:'AED-NGN',name:'Yusuf K.',flag:'üá≥üá¨',city:'Dubai, UAE',proximity:'Local LP',lpType:'Regional Bank',reliability:96,settlement:'3 min',rateDeltaPct:0.74,score:85,avatar:'#3b82f6',badgeHint:'Best rate',lpProfileId:'kwame'},
  
  // AED ‚Üí PHP corridor (Philippines) - Exactly 3 LPs
  {id:'AED_PHP_LP1',corridor:'AED-PHP',name:'Carlos M.',flag:'üáµüá≠',city:'Cebu, Philippines',proximity:'Regional LP',lpType:'Regional Branch',reliability:84,settlement:'5 min',rateDeltaPct:1.32,score:77,avatar:'#f43f5e',badgeHint:'Best rate',lpProfileId:'chen'},
  {id:'AED_PHP_LP2',corridor:'AED-PHP',name:'Maria S.',flag:'üáµüá≠',city:'Manila, Philippines',proximity:'Regional LP',lpType:'Philippines Desk',reliability:89,settlement:'4 min',rateDeltaPct:0.66,score:80,avatar:'#ec4899',badgeHint:'Fastest payout',lpProfileId:'chen'},
  {id:'AED_PHP_LP3',corridor:'AED-PHP',name:'Jose R.',flag:'üáµüá≠',city:'Dubai, UAE',proximity:'Local LP',lpType:'UAE-PH Partner',reliability:91,settlement:'3 min',rateDeltaPct:0.52,score:82,avatar:'#14b8a6',badgeHint:'Closest LP',lpProfileId:'chen'},
  
  // USD ‚Üí INR corridor (India) - Exactly 3 LPs
  {id:'USD_INR_LP1',corridor:'USD-INR',name:'Raj P.',flag:'üáÆüá≥',city:'Delhi, India',proximity:'Local LP',lpType:'Local FX Partner',reliability:97,settlement:'1 min',rateDeltaPct:0.42,score:88,avatar:'#f59e0b',badgeHint:'Fastest payout',lpProfileId:'raj'},
  {id:'USD_INR_LP2',corridor:'USD-INR',name:'Priya K.',flag:'üáÆüá≥',city:'Mumbai, India',proximity:'Regional LP',lpType:'Regional FX Desk',reliability:90,settlement:'5 min',rateDeltaPct:0.58,score:82,avatar:'#8b5cf6',badgeHint:'Best rate',lpProfileId:'raj'},
  {id:'USD_INR_LP3',corridor:'USD-INR',name:'Amit S.',flag:'üáÆüá≥',city:'Bangalore, India',proximity:'Cross-border LP',lpType:'Tech Hub Exchange',reliability:93,settlement:'3 min',rateDeltaPct:0.31,score:85,avatar:'#06b6d4',badgeHint:'Closest LP',lpProfileId:'raj'},
  
  // AED ‚Üí GHS corridor (Ghana) - Exactly 3 LPs
  {id:'AED_GHS_LP1',corridor:'AED-GHS',name:'Ama K.',flag:'üá¨üá≠',city:'Dubai, UAE',proximity:'Local LP',lpType:'Premium Exchange',reliability:94,settlement:'2 min',rateDeltaPct:0.71,score:83,avatar:'#eab308',badgeHint:'Best rate',lpProfileId:'kwame'},
  {id:'AED_GHS_LP2',corridor:'AED-GHS',name:'Kofi A.',flag:'üá¨üá≠',city:'Dubai, UAE',proximity:'Local LP',lpType:'Local FX Partner',reliability:91,settlement:'3 min',rateDeltaPct:0.24,score:75,avatar:'#10b981',badgeHint:'Fastest payout',lpProfileId:'kwame'},
  {id:'AED_GHS_LP3',corridor:'AED-GHS',name:'Kwame B.',flag:'üá¨üá≠',city:'Accra, Ghana',proximity:'Cross-border LP',lpType:'Ghana-based',reliability:87,settlement:'4 min',rateDeltaPct:-0.24,score:79,avatar:'#14b8a6',badgeHint:'Closest LP',lpProfileId:'kwame'},
  
  // GBP ‚Üí ZWL corridor (Zimbabwe) - Exactly 3 LPs
  {id:'GBP_ZWL_LP1',corridor:'GBP-ZWL',name:'Tendai M.',flag:'üáøüáº',city:'Harare, Zimbabwe',proximity:'Cross-border LP',lpType:'Local MTO',reliability:80,settlement:'6 min',rateDeltaPct:0.22,score:71,avatar:'#6366f1',badgeHint:'Closest LP',lpProfileId:'kwame'},
  {id:'GBP_ZWL_LP2',corridor:'GBP-ZWL',name:'Rudo K.',flag:'üáøüáº',city:'London, UK',proximity:'Local LP',lpType:'UK-Zimbabwe Desk',reliability:88,settlement:'4 min',rateDeltaPct:0.48,score:79,avatar:'#ef4444',badgeHint:'Best rate',lpProfileId:'kwame'},
  {id:'GBP_ZWL_LP3',corridor:'GBP-ZWL',name:'Tafadzwa N.',flag:'üáøüáº',city:'Bulawayo, Zimbabwe',proximity:'Regional LP',lpType:'Zimbabwe Partner',reliability:83,settlement:'5 min',rateDeltaPct:-0.15,score:74,avatar:'#10b981',badgeHint:'Fastest payout',lpProfileId:'kwame'},
  
  // USD ‚Üí MXN corridor (Mexico) - Exactly 3 LPs
  {id:'USD_MXN_LP1',corridor:'USD-MXN',name:'Maria L.',flag:'üá≤üáΩ',city:'Mexico City',proximity:'Local LP',lpType:'Local Bank',reliability:95,settlement:'2 min',rateDeltaPct:0.38,score:83,avatar:'#f97316',badgeHint:'Fastest payout',lpProfileId:'jose'},
  {id:'USD_MXN_LP2',corridor:'USD-MXN',name:'Carlos G.',flag:'üá≤üáΩ',city:'Guadalajara',proximity:'Regional LP',lpType:'Regional Exchange',reliability:89,settlement:'3 min',rateDeltaPct:0.52,score:81,avatar:'#3b82f6',badgeHint:'Best rate',lpProfileId:'jose'},
  {id:'USD_MXN_LP3',corridor:'USD-MXN',name:'Ana R.',flag:'üá≤üáΩ',city:'Monterrey',proximity:'Cross-border LP',lpType:'North Mexico Desk',reliability:91,settlement:'4 min',rateDeltaPct:0.19,score:78,avatar:'#ec4899',badgeHint:'Closest LP',lpProfileId:'jose'}
];

// Compute LP rates at initialization
SWIPE.forEach(lp=>{
  const baseRate=getRate(lp.from||lp.corridor.split('-')[0],lp.to||lp.corridor.split('-')[1]);
  lp.from=lp.from||lp.corridor.split('-')[0];
  lp.to=lp.to||lp.corridor.split('-')[1];
  lp.lpRate=baseRate*(1+(lp.rateDeltaPct||0)/100);
  lp.fbRate=baseRate;
  lp.location=lp.city; // For backward compatibility
});

const SCENARIOS={
A:{name:'Instant Send',desc:'UAE migrant worker sends 500 AED to Ghana',corridor:{from:'AED',to:'GHS'},amount:500,recipient:RECIPIENTS[0],schedule:'now',premium:false,user:'aisha'},
B:{name:'Scheduled Transfer',desc:'UAE worker schedules 1000 AED to Philippines',corridor:{from:'AED',to:'PHP'},amount:1000,recipient:RECIPIENTS[1],schedule:'+2min',premium:false,user:'chidi'},
C:{name:'Premium Fast-Track',desc:'US investor sends $1500 to India with priority',corridor:{from:'USD',to:'INR'},amount:1500,recipient:RECIPIENTS[2],schedule:'now',premium:true,user:'aisha'}
};

const GUIDED_STEPS=[
{role:'sender',view:'send',action:'Fill amount & select recipient',desc:'Enter 500 AED to send to Ghana'},
{role:'sender',view:'swipe',action:'Find a matching counterparty',desc:'Swipe right to match with Kofi'},
{role:'lp',view:'orders',action:'LP accepts the order',desc:'Liquidity provider funds the trade'},
{role:'anchor',view:'payouts',action:'Anchor processes payout',desc:'Local partner pays out in GHS'},
{role:'receiver',view:'dashboard',action:'Receiver gets funds',desc:'Kofi receives mobile money'},
{role:'admin',view:'dashboard',action:'Review settlement',desc:'See complete flow & revenue'}
];

// ============ STATE VARIABLES ============
let currentRole='sender',currentView='dashboard',notifications=[],DEMO_TX=null,txHistory=[],swipeIndex=0;
let guidedMode=false,guidedStep=0,freeMode=false; // Mode flags
let TOTAL_SAVINGS=847293,LP_REVENUE=18472,ANCHOR_REVENUE=12340;
let BUSINESS_METRICS={totalVolume:2847293,txCount:1847,avgTxSize:1541,revenueTotal:42847,revenueFX:28400,revenuePremium:8200,revenueLP:4100,revenueAnchor:2147};

// Admin Revenue date filter state
let ADMIN_REVENUE_RANGE='LAST_30';

// Demo revenue streams (subscription & future revenues)
const DEMO_REVENUE_STREAMS={
  lpSubscriptions:2500,
  anchorSubscriptions:1800,
  institutionalApi:900,
  dataAnalytics:0
};

// ============ LP QUOTES SYSTEM ============
let LP_QUOTES = []; // Array to store LP quotes for transactions
let LP_REQUESTS = []; // Array to store pending quote requests from senders
let ACTIVE_TX_ID = null; // Currently selected transaction for FlowSwipe
let SWIPE_INDEX = {}; // Track swipe index per transaction

// ============ PRICING BANDS SYSTEM ============
const PRICING_BANDS = {
  default: { minDeltaPct: -5, maxDeltaPct: 2 }
  // Optional per-corridor overrides can be added here
};

// Helper function to clamp LP rate delta within allowed bands
function clampDelta(corridor, deltaPct) {
  const band = PRICING_BANDS[corridor] || PRICING_BANDS.default;
  return Math.min(band.maxDeltaPct, Math.max(band.minDeltaPct, deltaPct));
}

// ============ LP CORRIDOR FILTER ============
let LP_CORRIDOR_FILTER = 'ALL'; // Current corridor filter for LP views

// ============ ISSUES SYSTEM ============
let ISSUES = [];
// Each issue: { id, txId, raisedByRole, raisedByUserId, reason, detail, severity, status, createdAt }

function raiseIssue({ txId, raisedByRole, raisedByUserId, reason, detail, severity = 'normal' }) {
  const issue = {
    id: 'ISS-' + Math.random().toString(36).substr(2,5).toUpperCase(),
    txId,
    raisedByRole,
    raisedByUserId,
    reason,
    detail,
    severity,
    status: 'open',
    createdAt: new Date()
  };
  ISSUES.unshift(issue);
  pushNotif('‚ö†Ô∏è Issue raised on '+txId,'warning','admin');
  showToast('Issue raised: '+issue.id,'warning');
  render();
}

function updateIssueStatus(issueId, status) {
  const issue = ISSUES.find(i => i.id === issueId);
  if (issue) {
    issue.status = status;
    showToast('Issue '+issueId+' updated to '+status,'info');
    render();
  }
}

function showIssueModal(role) {
  if (!DEMO_TX) {
    showToast('No active transaction to flag','warning');
    return;
  }
  const userId = role === 'sender' ? getActiveSender().id : role === 'lp' ? 'LP-'+activeLPId : 'SYS';
  const html = '<div class="modal-header"><span class="modal-title">üö© Flag Issue</span><button class="modal-close" onclick="forceCloseModal()">‚úï</button></div><div class="modal-body"><div class="glass-card" style="margin-bottom:16px"><div style="font-weight:600;margin-bottom:8px">Transaction Details</div><div style="font-size:12px;line-height:1.8"><div>ID: '+DEMO_TX.id+'</div><div>Amount: '+fmtCur(DEMO_TX.amount,DEMO_TX.fromCur)+'</div><div>Status: '+DEMO_TX.status+'</div></div></div><div class="form-group"><label class="form-label">Issue Reason</label><select class="form-select" id="issueReason"><option value="Recipient not paid">Recipient not paid</option><option value="Wrong amount">Wrong amount</option><option value="Delay">Excessive delay</option><option value="Rate discrepancy">Rate discrepancy</option><option value="Other">Other</option></select></div><div class="form-group"><label class="form-label">Details</label><textarea class="form-input" id="issueDetail" rows="4" placeholder="Describe the issue..."></textarea></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="forceCloseModal()">Cancel</button><button class="btn btn-danger" onclick="submitIssue(\''+role+'\',\''+userId+'\')">Submit Issue</button></div>';
  openModal(html);
}

function submitIssue(role, userId) {
  const reason = document.getElementById('issueReason')?.value;
  const detail = document.getElementById('issueDetail')?.value;
  if (!detail || detail.trim().length < 10) {
    showToast('Please provide detailed description (min 10 characters)','error');
    return;
  }
  raiseIssue({
    txId: DEMO_TX.id,
    raisedByRole: role,
    raisedByUserId: userId,
    reason,
    detail,
    severity: 'normal'
  });
  forceCloseModal();
}

let LP_STATE={
AED_NGN:{available:125000,locked:45000,rate:431.5,util:0.265},
USD_INR:{available:89000,locked:31000,rate:83.3,util:0.258},
AED_PHP:{available:67000,locked:23000,rate:15.2,util:0.256},
GBP_ZWL:{available:42000,locked:8000,rate:461,util:0.16},
AED_GHS:{available:55000,locked:15000,rate:4.21,util:0.214}
};

let ANCHOR_STATE={
ghana:{name:'GhanaPay Mobile',pending:3,completed:47,balance:125000,commission:2340},
philippines:{name:'PH Express',pending:2,completed:38,balance:89000,commission:1890},
india:{name:'India PayFast',pending:1,completed:62,balance:156000,commission:3100},
zimbabwe:{name:'ZimCash',pending:1,completed:24,balance:34000,commission:850}
};

// Synthetic transaction history for corridors
const CORRIDOR_TX_HISTORY={
'AED_NGN':[
{id:'TX-A001',amount:2500,from:'AED',to:'NGN',status:'completed',time:'10:45 AM',sender:'USR-8821'},
{id:'TX-A002',amount:1800,from:'AED',to:'NGN',status:'completed',time:'10:32 AM',sender:'USR-7623'},
{id:'TX-A003',amount:3200,from:'AED',to:'NGN',status:'completed',time:'10:15 AM',sender:'USR-9912'},
{id:'TX-A004',amount:950,from:'AED',to:'NGN',status:'flagged',time:'09:58 AM',sender:'USR-1123',flag:'velocity'},
{id:'TX-A005',amount:4100,from:'AED',to:'NGN',status:'completed',time:'09:41 AM',sender:'USR-5534'}
],
'USD_INR':[
{id:'TX-U001',amount:3500,from:'USD',to:'INR',status:'completed',time:'11:02 AM',sender:'USR-3344'},
{id:'TX-U002',amount:2200,from:'USD',to:'INR',status:'completed',time:'10:48 AM',sender:'USR-6678'},
{id:'TX-U003',amount:5000,from:'USD',to:'INR',status:'completed',time:'10:21 AM',sender:'USR-2211'}
],
'AED_GHS':[
{id:'TX-G001',amount:800,from:'AED',to:'GHS',status:'completed',time:'10:55 AM',sender:'USR-4455'},
{id:'TX-G002',amount:1200,from:'AED',to:'GHS',status:'completed',time:'10:28 AM',sender:'USR-7788'}
]
};

// ============ ADMIN REVENUE DATE FILTERING ============
// State for custom date range
let ADMIN_REVENUE_CUSTOM_FROM = null;
let ADMIN_REVENUE_CUSTOM_TO = null;

function getAdminRevenueDateRange(){
  const value=ADMIN_REVENUE_RANGE;
  const now=new Date();
  let from=null;
  let to=now;
  
  if(value==='LAST_7')from=new Date(now.getTime()-7*86400000);
  else if(value==='LAST_30')from=new Date(now.getTime()-30*86400000);
  else if(value==='LAST_90')from=new Date(now.getTime()-90*86400000);
  else if(value==='MTD')from=new Date(now.getFullYear(),now.getMonth(),1);
  else if(value==='YTD')from=new Date(now.getFullYear(),0,1);
  else if(value==='CUSTOM'){
    from=ADMIN_REVENUE_CUSTOM_FROM?new Date(ADMIN_REVENUE_CUSTOM_FROM):null;
    to=ADMIN_REVENUE_CUSTOM_TO?new Date(ADMIN_REVENUE_CUSTOM_TO):now;
  }
  // 'ALL' => from stays null
  
  return{from,to,mode:value};
}

function setCustomRevenueDate(type,value){
  if(type==='from'){
    ADMIN_REVENUE_CUSTOM_FROM=value;
  }else{
    ADMIN_REVENUE_CUSTOM_TO=value;
  }
  render();
}

function computeRevenueBreakdown(){
  const{from,to,mode}=getAdminRevenueDateRange();
  
  // Calculate days in range for proportional revenue
  let daysInRange=30; // default
  if(from&&to){
    daysInRange=Math.max(1,Math.ceil((to-from)/(1000*60*60*24)));
  }else if(mode==='LAST_7'){
    daysInRange=7;
  }else if(mode==='LAST_30'){
    daysInRange=30;
  }else if(mode==='LAST_90'){
    daysInRange=90;
  }else if(mode==='MTD'){
    const now=new Date();
    daysInRange=now.getDate();
  }else if(mode==='YTD'){
    const now=new Date();
    const startOfYear=new Date(now.getFullYear(),0,1);
    daysInRange=Math.ceil((now-startOfYear)/(1000*60*60*24));
  }else if(mode==='ALL'){
    daysInRange=365; // assume 1 year of data
  }
  
  // Filter transactions by date range
  const filteredTxs=txHistory.filter(t=>{
    if(!t.timestamp)return false;
    const d=new Date(t.timestamp);
    if(from&&d<from)return false;
    if(to&&d>to)return false;
    return true;
  });
  
  // Calculate transaction fee revenue from filtered transactions
  let transactionFees=0;
  filteredTxs.forEach(t=>{
    if(t.status==='completed'&&t.amount){
      const amt=t.amount||0;
      transactionFees+=amt*0.012; // 1.2% fee
    }
  });
  
  // Generate realistic revenue based on time period
  // Base daily rates (revenue per day)
  const dailyRates={
    transactionFees:850, // avg $850/day from tx fees
    lpSubscriptions:83, // $2500/month = ~$83/day
    anchorSubscriptions:60, // $1800/month = ~$60/day
    senderPremium:50, // avg $50/day from premium
    institutionalApi:30, // $900/month = ~$30/day
    dataAnalytics:10 // growing, ~$10/day
  };
  
  // Add randomization factor (¬±15%) for realism
  const randomFactor=()=>0.85+Math.random()*0.3;
  
  // Calculate proportional revenue based on days in range
  const breakdown={
    transactionFees:transactionFees>0?transactionFees:Math.round(dailyRates.transactionFees*daysInRange*randomFactor()),
    lpSubscriptions:Math.round(dailyRates.lpSubscriptions*daysInRange*randomFactor()),
    anchorSubscriptions:Math.round(dailyRates.anchorSubscriptions*daysInRange*randomFactor()),
    senderPremium:filteredTxs.filter(t=>t.premium&&t.status==='completed').length*5||Math.round(dailyRates.senderPremium*daysInRange*randomFactor()),
    institutionalApi:Math.round(dailyRates.institutionalApi*daysInRange*randomFactor()),
    dataAnalytics:Math.round(dailyRates.dataAnalytics*daysInRange*randomFactor())
  };
  
  // Calculate total
  const totalRevenue=
    breakdown.transactionFees+
    breakdown.lpSubscriptions+
    breakdown.anchorSubscriptions+
    breakdown.senderPremium+
    breakdown.institutionalApi+
    breakdown.dataAnalytics;
  
  return{breakdown,totalRevenue};
}

// ============ UTILITY FUNCTIONS ============
function fmt(n,d=2){if(n===null||n===undefined)return'0';return new Intl.NumberFormat('en-US',{minimumFractionDigits:d,maximumFractionDigits:d}).format(n)}
function fmtAmount(n){if(isNaN(n)||n===null||n===undefined)return'0.00';return Number(n).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})}
function fmtCur(amt,cur){const c=CURRENCIES[cur];return c?(c.symbol||'')+fmt(amt):'$'+fmt(amt)}

// Currency metadata for enhanced display
const CURRENCY_META={
  AED:{symbol:'ÿØ.ÿ•',flag:'üá¶üá™'},
  USD:{symbol:'$',flag:'üá∫üá∏'},
  INR:{symbol:'‚Çπ',flag:'üáÆüá≥'},
  GBP:{symbol:'¬£',flag:'üá¨üáß'},
  EUR:{symbol:'‚Ç¨',flag:'üá™üá∫'},
  PHP:{symbol:'‚Ç±',flag:'üáµüá≠'},
  NGN:{symbol:'‚Ç¶',flag:'üá≥üá¨'},
  GHS:{symbol:'‚Çµ',flag:'üá¨üá≠'},
  KES:{symbol:'KSh',flag:'üá∞üá™'},
  MXN:{symbol:'$',flag:'üá≤üáΩ'},
  ZWL:{symbol:'Z$',flag:'üáøüáº'}
};
function getRate(from,to){if(from===to)return 1;if(RATES[from]&&RATES[from][to])return RATES[from][to];if(RATES[to]&&RATES[to][from])return 1/RATES[to][from];if(RATES[from]&&RATES[from]['USD']&&RATES['USD']&&RATES['USD'][to])return RATES[from]['USD']*RATES['USD'][to];return 430} // Default fallback
function getTradRate(from,to){if(TRAD_RATES[from]&&TRAD_RATES[from][to])return TRAD_RATES[from][to];const r=getRate(from,to);return r?r*0.96:null}
function calcReceive(amt,from,to){const r=getRate(from,to);return r?amt*r:0}
function calculateSavings(amt,from,to){const ourRate=getRate(from,to),tradRate=getTradRate(from,to);if(!ourRate||!tradRate)return 0;return Math.max(0,amt*ourRate-amt*tradRate)}
function getActiveSender(){return USERS[activeSenderId]||USERS.aisha}
function getTierFromScore(s){if(s>=90)return'platinum';if(s>=75)return'gold';if(s>=50)return'silver';return'bronze'}
function getLimit(tier){return TIER_LIMITS[tier]||TIER_LIMITS.bronze}
function updateSavingsTicker(){const el=document.getElementById('savingsTicker');if(el)el.textContent='$'+fmt(TOTAL_SAVINGS,0)}
function updateModeIndicator(){const el=document.getElementById('modeIndicator');if(!el)return;if(guidedMode){el.textContent='GUIDED';el.className='mode-indicator guided'}else if(freeMode){el.textContent='FREE';el.className='mode-indicator free'}else{el.textContent='DEMO';el.className='mode-indicator'}}

// ============ UI FEEDBACK ============
function showToast(msg,type='info'){const t=document.getElementById('toast');if(!t)return;t.innerHTML='<span class="toast-icon">'+(type==='success'?'‚úì':type==='error'?'‚úï':type==='warning'?'‚ö†':'‚Ñπ')+'</span><span class="toast-msg">'+msg+'</span>';t.className='toast '+type+' active';setTimeout(()=>{if(t)t.classList.remove('active')},3500)}

function pushNotif(msg,type='info',role=null){const n={id:Date.now()+Math.random(),msg,type,time:new Date().toLocaleTimeString(),role};notifications.unshift(n);if(notifications.length>20)notifications.pop();if(!role||role===currentRole)renderNotifications()}

function renderNotifications(){const p=document.getElementById('notifPanel');if(!p)return;const filtered=notifications.filter(n=>!n.role||n.role===currentRole).slice(0,12);
p.innerHTML='<div class="notif-header"><span class="notif-title">üîî Activity</span>'+(filtered.length?'<span class="notif-count">'+filtered.length+'</span>':'')+'</div><div class="notif-list">'+filtered.map(n=>'<div class="notif-item '+n.type+'"><div>'+n.msg+'</div><div class="time">'+n.time+'</div></div>').join('')+'</div>'}

// ============ MODAL SYSTEM ============
function openModal(content){const o=document.getElementById('modalOverlay'),m=document.getElementById('modal');if(o&&m){m.innerHTML=content;o.classList.add('active')}}
function closeModal(e){if(e&&e.target&&e.target.id!=='modalOverlay'&&!e.target.classList.contains('modal-close')&&!e.target.closest('.modal-footer button'))return;const o=document.getElementById('modalOverlay');if(o)o.classList.remove('active')}
function forceCloseModal(){const o=document.getElementById('modalOverlay');if(o)o.classList.remove('active')}

// ============ MODE & GUIDED DEMO ============
function toggleMode(){
  freeMode=!freeMode;
  if(freeMode){guidedMode=false;document.getElementById('guidedBtn')?.classList.remove('active')}
  document.getElementById('modeBtn')?.classList.toggle('free',freeMode);
  updateModeIndicator();
  showToast(freeMode?'üîì Free exploration mode - no guided steps':'üéØ Demo mode restored','info');
}

function toggleGuidedDemo(){
  guidedMode=!guidedMode;
  document.getElementById('guidedBtn')?.classList.toggle('active',guidedMode);
  if(guidedMode){freeMode=false;guidedStep=0;document.getElementById('modeBtn')?.classList.remove('free');showToast('üéì Guided demo activated','info');pushNotif('Follow the purple highlights to see the full flow','info')}
  else{showToast('Guided demo disabled','info')}
  updateModeIndicator();render();
}

function advanceGuidedStep(){
  if(!guidedMode||freeMode)return;
  guidedStep++;
  if(guidedStep>=GUIDED_STEPS.length){guidedMode=false;document.getElementById('guidedBtn')?.classList.remove('active');updateModeIndicator();showToast('üéâ Demo complete!','success');return}
  const step=GUIDED_STEPS[guidedStep];
  showToast('Step '+(guidedStep+1)+'/'+GUIDED_STEPS.length+': '+step.action,'info');
  if(step.role!==currentRole){currentRole=step.role;const sel=document.getElementById('roleSelect');if(sel)sel.value=step.role}
  currentView=step.view;
  render();
}

function replayFullDemo(){resetDemo();loadScenario('A');guidedMode=true;freeMode=false;guidedStep=0;document.getElementById('guidedBtn')?.classList.add('active');document.getElementById('modeBtn')?.classList.remove('free');updateModeIndicator();showToast('üé¨ Starting guided investor demo...','info');pushNotif('üéì Guided demo started - follow the highlights','info')}

function resetDemo(){
  resetDemoTx();
  txHistory=[];swipeIndex=0;guidedStep=0;notifications=[];
  
  // Reset all users
  Object.keys(USERS).forEach(k=>{const u=USERS[k];u.dailyUsed=k==='aisha'?1200:k==='chidi'?800:k==='priya'?150:500;u.monthlyUsed=k==='aisha'?8500:k==='chidi'?4200:k==='priya'?900:15000;u.flagged=false});
  USERS.aisha.score=87;USERS.aisha.tier='gold';USERS.aisha.premium=true;
  USERS.chidi.score=68;USERS.chidi.tier='silver';USERS.chidi.premium=false;
  USERS.priya.score=42;USERS.priya.tier='bronze';USERS.priya.premium=false;
  USERS.platinum.score=95;USERS.platinum.tier='platinum';USERS.platinum.premium=true;
  
  // BUG-13 FIX: Reset all global state objects
  LP_STATE={
    AED_NGN:{available:125000,locked:45000,rate:431.5,util:0.265},
    USD_INR:{available:89000,locked:31000,rate:83.3,util:0.258},
    AED_PHP:{available:67000,locked:23000,rate:15.2,util:0.256},
    GBP_ZWL:{available:42000,locked:8000,rate:461,util:0.16},
    AED_GHS:{available:55000,locked:15000,rate:4.21,util:0.214}
  };
  
  // Reset LP profiles
  LP_PROFILES.kwame.revenue=18472;
  LP_PROFILES.kwame.positions={AED_NGN:{available:125000,locked:45000,rate:431.5,util:0.265},AED_GHS:{available:55000,locked:15000,rate:4.21,util:0.214},AED_KES:{available:42000,locked:8000,rate:42,util:0.16}};
  LP_PROFILES.jose.revenue=23150;
  LP_PROFILES.raj.revenue=31200;
  LP_PROFILES.chen.revenue=27800;
  
  // Reset Anchor profiles
  ANCHOR_PROFILES.mpesa.pending=3;ANCHOR_PROFILES.mpesa.completed=47;
  ANCHOR_PROFILES.gcash.pending=2;ANCHOR_PROFILES.gcash.completed=38;
  ANCHOR_PROFILES.upi.pending=1;ANCHOR_PROFILES.upi.completed=62;
  ANCHOR_PROFILES.mtn.pending=4;ANCHOR_PROFILES.mtn.completed=55;
  ANCHOR_PROFILES.ecocash.pending=1;ANCHOR_PROFILES.ecocash.completed=24;
  
  activeSenderId='aisha';activeLPId='kwame';activeAnchorId='mpesa';activeReceiverId='ghana';
  currentView='dashboard';
  showToast('Demo reset','info');
  render();
}

function resetDemoTx(){
  DEMO_TX=null;
  forceCloseModal();
}

// ============ SCENARIOS ============
function showScenarioModal(){
const html='<div class="modal-header"><span class="modal-title">üéØ Demo Scenarios</span><button class="modal-close" onclick="forceCloseModal()">‚úï</button></div><div class="modal-body">'+
Object.entries(SCENARIOS).map(([k,s])=>'<div class="glass-card" style="margin-bottom:12px;cursor:pointer" onclick="loadScenario(\''+k+'\');forceCloseModal()"><div style="font-weight:600;margin-bottom:4px">Scenario '+k+': '+s.name+'</div><div style="font-size:12px;color:var(--text2)">'+s.desc+'</div><div style="font-size:11px;color:var(--accent);margin-top:6px">'+CURRENCIES[s.corridor.from].flag+' '+s.corridor.from+' ‚Üí '+CURRENCIES[s.corridor.to].flag+' '+s.corridor.to+' | '+fmtCur(s.amount,s.corridor.from)+'</div></div>').join('')+
'</div><div class="modal-footer"><button class="btn btn-secondary" onclick="forceCloseModal()">Cancel</button></div>';
openModal(html);
}

function loadScenario(key){
  const s=SCENARIOS[key];if(!s)return;
  resetDemo();
  if(s.user&&USERS[s.user]){activeSenderId=s.user}
  const u=getActiveSender();
  DEMO_TX={
    id:'TX-'+Math.random().toString(36).substr(2,6).toUpperCase(),
    fromCur:s.corridor.from,toCur:s.corridor.to,amount:s.amount,
    recipient:s.recipient,status:'pending',
    scheduled:s.schedule!=='now',scheduledTime:s.schedule==='+2min'?new Date(Date.now()+120000):null,
    needByType:s.schedule==='now'?'immediate':'scheduled',
    premium:s.premium,timestamp:new Date()
  };
  pushNotif('üéØ Loaded Scenario '+key+': '+s.name,'info');
  showToast('Scenario '+key+' loaded: '+s.name,'success');
  currentRole='sender';currentView='send';
  render();
}

// ============ SENDER USER SWITCHING ============
function switchSenderUser(userId){
  if(!USERS[userId])return;
  activeSenderId=userId;
  // Update base currency if different
  if(DEMO_TX){DEMO_TX.fromCur=USERS[userId].baseCur}
  showToast('Switched to '+USERS[userId].name,'info');
  render();
}

// ============ SCORE & TIER FUNCTIONS ============
function simulateScoreChange(delta){
  const u=getActiveSender();
  u.score=Math.max(10,Math.min(100,u.score+delta));
  u.tier=getTierFromScore(u.score);
  showToast((delta>0?'üìà Score increased':'üìâ Score decreased')+' to '+u.score+' ('+u.tier.toUpperCase()+')',delta>0?'success':'warning');
  if(currentRole==='sender')render();
}

function applyFraudPenalty(userId){
  const u=USERS[userId]||getActiveSender();
  u.score=Math.max(10,u.score-4);
  u.tier=getTierFromScore(u.score);
  u.flagged=true; // FIX: Actually flag the user
  pushNotif('‚ö†Ô∏è FlowScore penalty applied: -4 points','warning','sender');
  pushNotif('üö® Fraud penalty applied to '+userId+' - account flagged','warning','admin');
  if(currentRole==='sender'||currentRole==='admin')render();
}

// ============ SETTLEMENT & INFO MODALS ============
function showSettlementModal(){
const steps=['<b>1. Sender Pays Locally</b><br>Sender pays via their local bank or card. Funds never cross borders.','<b>2. LP Takes FX Position</b><br>Liquidity Provider uses their own balance to fulfill, earning spread.','<b>3. Anchor Receives Instruction</b><br>Local Anchor partner gets payout instructions with receiver details.','<b>4. Receiver Gets Paid</b><br>Receiver gets local currency via mobile money/bank within minutes.','<b>5. FlowBridge Orchestrates</b><br>We match, verify, and settle - but never hold customer funds.'];
const html='<div class="modal-header"><span class="modal-title">‚ö° How Settlement Works</span><button class="modal-close" onclick="forceCloseModal()">‚úï</button></div><div class="modal-body"><div class="timeline">'+steps.map((s,i)=>'<div class="timeline-item"><div class="timeline-dot complete">‚úì</div><div class="timeline-content"><div style="font-size:13px">'+s+'</div></div></div>').join('')+'</div><div class="investor-highlight" style="margin-top:20px"><div class="title">üí° Key Insight</div><div style="font-size:13px">Traditional remittances: 3-5 days, multiple intermediaries.<br>FlowBridge: < 5 minutes using local liquidity pools.</div></div></div><div class="modal-footer"><button class="btn btn-primary" onclick="forceCloseModal()">Got it</button></div>';
openModal(html);
}

function showSettlementTraceModal(){
  if(!DEMO_TX){showToast('No active transaction to trace','warning');return}
  const tx=DEMO_TX;
  const legs=[
    {title:'Sender ‚Üí Local PSP',desc:'Funds collected via local payment method',status:tx.status!=='pending'?'complete':'active',time:tx.timestamp?.toLocaleTimeString()},
    {title:'FlowBridge Matching',desc:'Order matched with counterparty via FlowSwipe',status:['matched','lp_funded','payout_processing','completed'].includes(tx.status)?'complete':tx.status==='pending'?'active':'pending',time:tx.matchTime?.toLocaleTimeString()},
    {title:'LP FX Position',desc:'Liquidity provider locks funds for settlement',status:['lp_funded','payout_processing','completed'].includes(tx.status)?'complete':tx.status==='matched'?'active':'pending',time:tx.lpTime?.toLocaleTimeString()},
    {title:'Anchor Payout',desc:'Local anchor triggers payout to receiver',status:['payout_processing','completed'].includes(tx.status)?'complete':tx.status==='lp_funded'?'active':'pending',time:tx.payoutTime?.toLocaleTimeString()},
    {title:'Receiver Credited',desc:'Funds available to recipient',status:tx.status==='completed'?'complete':tx.status==='payout_processing'?'active':'pending',time:tx.completedTime?.toLocaleTimeString()}
  ];
  const html='<div class="modal-header"><span class="modal-title">üîç Settlement Trace: '+tx.id+'</span><button class="modal-close" onclick="forceCloseModal()">‚úï</button></div><div class="modal-body">'+
  legs.map(l=>'<div class="settlement-leg"><div class="status '+l.status+'">'+(l.status==='complete'?'‚úì':l.status==='active'?'‚óè':'‚óã')+'</div><div class="content"><div class="title">'+l.title+'</div><div class="desc">'+l.desc+'</div>'+(l.time?'<div class="time">'+l.time+'</div>':'')+'</div></div>').join('')+
  '<div class="investor-highlight"><div class="title">Transaction Summary</div><div style="font-size:12px">Amount: '+fmtCur(tx.amount,tx.fromCur)+' ‚Üí '+fmt(tx.amount*getRate(tx.fromCur,tx.toCur),0)+' '+tx.toCur+'<br>Status: '+tx.status.replace(/_/g,' ')+(tx.scheduled?' (Scheduled)':'')+'</div></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="forceCloseModal()">Close</button></div>';
  openModal(html);
}

// ============ CORRIDOR DRILL-DOWN ============
function showCorridorDetailModal(corridorIdx){
  const c=TOP_CORRIDORS[corridorIdx];if(!c)return;
  const key=c.from+'_'+c.to;
  const recentTx=CORRIDOR_TX_HISTORY[key]||[
    {id:'TX-SYN1',amount:Math.round(c.avgSize*0.9),status:'completed',time:'10:45 AM'},
    {id:'TX-SYN2',amount:Math.round(c.avgSize*1.1),status:'completed',time:'10:22 AM'},
    {id:'TX-SYN3',amount:Math.round(c.avgSize),status:'completed',time:'09:58 AM'}
  ];
  const html='<div class="modal-header"><span class="modal-title">'+CURRENCIES[c.from].flag+' '+c.name+' '+CURRENCIES[c.to].flag+'</span><button class="modal-close" onclick="forceCloseModal()">‚úï</button></div><div class="modal-body"><div class="corridor-detail-grid"><div class="corridor-stat"><div class="value" style="color:var(--green)">'+c.vol+'</div><div class="label">Total Volume</div></div><div class="corridor-stat"><div class="value">'+fmt(c.txCount,0)+'</div><div class="label">Transactions</div></div><div class="corridor-stat"><div class="value">$'+fmt(c.avgSize,0)+'</div><div class="label">Avg Size</div></div><div class="corridor-stat"><div class="value" style="color:var(--green)">$'+fmt(c.revenue,0)+'</div><div class="label">Revenue</div></div></div>'+
  '<div style="margin-bottom:12px"><div style="display:flex;justify-content:space-between;margin-bottom:8px"><span style="font-weight:600">Exchange Rate</span><span style="color:var(--green);font-family:JetBrains Mono">'+fmt(getRate(c.from,c.to),2)+' '+c.to+'</span></div>'+(c.fraudFlags?'<div style="display:flex;justify-content:space-between"><span style="color:var(--yellow)">‚ö†Ô∏è Fraud Flags</span><span>'+c.fraudFlags+'</span></div>':'')+'</div>'+
  '<div style="font-weight:600;margin-bottom:8px">Recent Transactions</div><div class="mini-tx-list">'+recentTx.map(t=>'<div class="mini-tx"><span>'+t.id+'</span><span>'+fmtCur(t.amount,c.from)+'</span><span class="badge badge-'+(t.status==='completed'?'success':t.status==='flagged'?'warning':'info')+'">'+t.status+'</span></div>').join('')+'</div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="forceCloseModal()">Close</button><button class="btn btn-primary" onclick="forceCloseModal();showToast(\'Corridor report exported\',\'success\')">üìä Export</button></div>';
  openModal(html);
}

// ============ LIQUIDITY MODALS ============
function showAddLiquidityModal(){
const pairs=Object.keys(LP_STATE);
const html='<div class="modal-header"><span class="modal-title">üí∞ Add Liquidity</span><button class="modal-close" onclick="forceCloseModal()">‚úï</button></div><div class="modal-body"><div class="liquidity-modal"><div class="form-group"><label class="form-label">Currency Pair</label><select class="form-select" id="liqPair">'+pairs.map(p=>'<option value="'+p+'">'+p.replace('_',' ‚Üí ')+'</option>').join('')+'</select></div><div class="form-group"><label class="form-label">Amount (USD equivalent)</label><input type="number" class="form-input" id="liqAmount" value="10000" min="1000" step="1000"></div></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="forceCloseModal()">Cancel</button><button class="btn btn-success" onclick="addLiquidity()">Add Liquidity</button></div>';
openModal(html);
}

function addLiquidity(){
  const pair=document.getElementById('liqPair')?.value;
  const amt=parseInt(document.getElementById('liqAmount')?.value)||10000;
  
  // VALIDATION: Check minimum amount
  if(amt<1000){
    showToast('‚ùå Minimum liquidity amount is $1,000','error');
    return;
  }
  
  // VALIDATION: Check maximum reasonable amount
  if(amt>1000000){
    showToast('‚ùå Maximum liquidity amount is $1,000,000','error');
    return;
  }
  
  if(LP_STATE[pair]){
    LP_STATE[pair].available+=amt;
    LP_STATE[pair].util=LP_STATE[pair].locked/(LP_STATE[pair].available+LP_STATE[pair].locked);
  }
  forceCloseModal();
  showToast('üí∞ Added $'+fmt(amt,0)+' liquidity to '+pair.replace('_',' ‚Üí '),'success');
  pushNotif('Liquidity position updated for '+pair.replace('_',' ‚Üí '),'success','lp');
  if(currentRole==='lp')render();
}

function showWithdrawModal(){
const pairs=Object.keys(LP_STATE);
const html='<div class="modal-header"><span class="modal-title">üí∏ Withdraw Liquidity</span><button class="modal-close" onclick="forceCloseModal()">‚úï</button></div><div class="modal-body"><div class="liquidity-modal"><div class="form-group"><label class="form-label">Currency Pair</label><select class="form-select" id="withdrawPair">'+pairs.map(p=>'<option value="'+p+'">'+p.replace('_',' ‚Üí ')+' (Avail: $'+fmt(LP_STATE[p].available,0)+')</option>').join('')+'</select></div><div class="form-group"><label class="form-label">Amount (USD equivalent)</label><input type="number" class="form-input" id="withdrawAmount" value="5000" min="1000" step="1000"></div></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="forceCloseModal()">Cancel</button><button class="btn btn-danger" onclick="withdrawLiquidity()">Withdraw</button></div>';
openModal(html);
}

function withdrawLiquidity(){
  const pair=document.getElementById('withdrawPair')?.value;
  const amt=parseInt(document.getElementById('withdrawAmount')?.value)||5000;
  
  // VALIDATION: Check if pair exists
  if(!LP_STATE[pair]){
    showToast('‚ùå Invalid currency pair','error');
    forceCloseModal();
    return;
  }
  
  const maxAvail=LP_STATE[pair].available;
  
  // VALIDATION: Check if amount is valid
  if(amt<=0){
    showToast('‚ùå Withdrawal amount must be greater than 0','error');
    return;
  }
  
  // VALIDATION: Check if sufficient funds available
  if(amt>maxAvail){
    showToast('‚ùå Insufficient available liquidity. Max: $'+fmt(maxAvail,0),'error');
    return;
  }
  
  const actual=Math.min(amt,maxAvail);
  LP_STATE[pair].available-=actual;
  LP_STATE[pair].util=LP_STATE[pair].locked/(LP_STATE[pair].available+LP_STATE[pair].locked)||0;
  forceCloseModal();
  showToast('üí∏ Withdrew $'+fmt(actual,0)+' from '+pair.replace('_',' ‚Üí '),'success');
  pushNotif('Liquidity withdrawn from '+pair.replace('_',' ‚Üí '),'info','lp');
  if(currentRole==='lp')render();
}

// ============ FRAUD & REVIEW MODALS ============
function showFraudReviewModal(tx){
const html='<div class="modal-header"><span class="modal-title">üîç Fraud Review: '+(tx?.id||'TX-XXX')+'</span><button class="modal-close" onclick="forceCloseModal()">‚úï</button></div><div class="modal-body"><div class="glass-card" style="margin-bottom:16px"><div style="font-weight:600;margin-bottom:8px">Pattern Analysis</div><div style="font-size:12px;color:var(--text2);margin-bottom:12px">Repeated bilateral volume between same counterparties</div><div style="font-size:11px;margin-bottom:4px">Counterparty 1 (USR-X847)</div><div class="fraud-bar"><div class="fraud-bar-fill" style="width:83%"></div></div><div style="font-size:10px;color:var(--text2);text-align:right">83% of volume</div><div style="font-size:11px;margin-bottom:4px;margin-top:8px">Counterparty 2 (USR-Y293)</div><div class="fraud-bar"><div class="fraud-bar-fill" style="width:17%"></div></div><div style="font-size:10px;color:var(--text2);text-align:right">17% of volume</div></div><div class="glass-card"><div style="font-weight:600;margin-bottom:8px">Risk Signals</div><div style="font-size:12px">‚Ä¢ 12 transactions in 48 hours<br>‚Ä¢ Amounts within 5% variance<br>‚Ä¢ Same corridor both directions<br>‚Ä¢ No other counterparties</div></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="forceCloseModal();showToast(\'Transaction marked as clean\',\'success\')">Mark as Clean</button><button class="btn btn-danger" onclick="forceCloseModal();showToast(\'Transaction escalated to compliance\',\'warning\')">Escalate</button></div>';
openModal(html);
}

function simulateCollusionPattern(){
const tx1={id:'TX-COL1',from:'USR-X847',to:'USR-Y293',amount:5000,fromCur:'AED',toCur:'NGN',corridor:'AED‚ÜíNGN',status:'flagged',pattern:'bilateral',concentration:83,timestamp:new Date()};
const tx2={id:'TX-COL2',from:'USR-Y293',to:'USR-X847',amount:4800,fromCur:'AED',toCur:'NGN',corridor:'AED‚ÜíNGN',status:'flagged',pattern:'bilateral',concentration:83,timestamp:new Date(Date.now()-60000)};
txHistory.unshift(tx1,tx2);
pushNotif('üö® Collusion pattern detected: bilateral volume spike','warning','admin');
pushNotif('‚ö†Ô∏è 2 transactions flagged for review','warning','admin');
applyFraudPenalty('USR-X847');
showToast('üî¥ Collusion simulation complete','warning');
render(); // BUG-14 FIX: Always call render after state change
}

// ============ DETAIL MODALS ============
function showTxDetailModal(tx){
if(!tx)return;
const rate=getRate(tx.fromCur||'AED',tx.toCur||'NGN');
const html='<div class="modal-header"><span class="modal-title">üìã Transaction Details</span><button class="modal-close" onclick="forceCloseModal()">‚úï</button></div><div class="modal-body"><div class="glass-card" style="margin-bottom:12px"><div style="display:flex;justify-content:space-between;margin-bottom:8px"><span style="color:var(--text2)">Transaction ID</span><span style="font-family:JetBrains Mono">'+(tx.id||'TX-XXX')+'</span></div><div style="display:flex;justify-content:space-between;margin-bottom:8px"><span style="color:var(--text2)">Status</span><span class="badge badge-'+(tx.status==='completed'?'success':tx.status==='flagged'?'danger':'info')+'">'+(tx.status||'pending')+'</span></div><div style="display:flex;justify-content:space-between;margin-bottom:8px"><span style="color:var(--text2)">Amount</span><span>'+fmtCur(tx.amount||500,tx.fromCur||'AED')+'</span></div><div style="display:flex;justify-content:space-between;margin-bottom:8px"><span style="color:var(--text2)">Receives</span><span>'+fmt((tx.amount||500)*rate,0)+' '+(tx.toCur||'NGN')+'</span></div><div style="display:flex;justify-content:space-between;margin-bottom:8px"><span style="color:var(--text2)">Corridor</span><span>'+(tx.fromCur||'AED')+' ‚Üí '+(tx.toCur||'NGN')+'</span></div><div style="display:flex;justify-content:space-between"><span style="color:var(--text2)">Time</span><span>'+(tx.timestamp?.toLocaleString()||'Just now')+'</span></div></div>'+(tx.recipient?'<div class="glass-card"><div style="font-weight:600;margin-bottom:8px">Recipient</div><div style="font-size:12px">'+tx.recipient.name+' ‚Ä¢ '+tx.recipient.method+'<br>'+tx.recipient.account+'</div></div>':'')+'</div><div class="modal-footer"><button class="btn btn-secondary" onclick="forceCloseModal()">Close</button><button class="btn btn-primary" onclick="forceCloseModal();showToast(\'Receipt downloaded\',\'success\')">üì• Receipt</button></div>';
openModal(html);
}

function showPayoutDetailModal(payout){
const html='<div class="modal-header"><span class="modal-title">üí≥ Payout Details</span><button class="modal-close" onclick="forceCloseModal()">‚úï</button></div><div class="modal-body"><div class="glass-card" style="margin-bottom:12px"><div style="display:flex;justify-content:space-between;margin-bottom:8px"><span style="color:var(--text2)">Payout ID</span><span style="font-family:JetBrains Mono">'+(payout?.id||'PAY-XXX')+'</span></div><div style="display:flex;justify-content:space-between;margin-bottom:8px"><span style="color:var(--text2)">Amount</span><span style="font-weight:700;color:var(--green)">‚Çµ'+fmt(payout?.amount||0,0)+'</span></div><div style="display:flex;justify-content:space-between;margin-bottom:8px"><span style="color:var(--text2)">Recipient</span><span>'+(payout?.recipient||'Unknown')+'</span></div><div style="display:flex;justify-content:space-between;margin-bottom:8px"><span style="color:var(--text2)">Status</span><span class="badge badge-'+(payout?.status==='completed'?'success':'warning')+'">'+(payout?.status||'pending')+'</span></div><div style="display:flex;justify-content:space-between"><span style="color:var(--text2)">Commission</span><span style="color:var(--green)">$'+fmt((payout?.amount||0)*0.004,2)+'</span></div></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="forceCloseModal()">Close</button><button class="btn btn-primary" onclick="forceCloseModal();showToast(\'Payout exported\',\'success\')">üìä Export</button></div>';
openModal(html);
}

function showLimitInfoModal(){
const u=getActiveSender();
const lim=getLimit(u.tier);
const html='<div class="modal-header"><span class="modal-title">üìä Why Is My Limit Low?</span><button class="modal-close" onclick="forceCloseModal()">‚úï</button></div><div class="modal-body"><p style="margin-bottom:16px;color:var(--text2)">Your transaction limits are based on your FlowScore and membership tier.</p><div class="glass-card" style="margin-bottom:12px"><div style="font-weight:600;margin-bottom:8px">Your Current Status</div><div style="display:flex;justify-content:space-between;margin-bottom:6px"><span>FlowScore</span><span style="color:var(--green)">'+u.score+'/100</span></div><div style="display:flex;justify-content:space-between;margin-bottom:6px"><span>Tier</span><span class="badge badge-'+u.tier+'">'+u.tier.toUpperCase()+'</span></div><div style="display:flex;justify-content:space-between;margin-bottom:6px"><span>Per Transaction</span><span>'+fmtCur(lim.perTx,'USD')+'</span></div><div style="display:flex;justify-content:space-between"><span>Daily Limit</span><span>'+fmtCur(lim.daily,'USD')+'</span></div></div><div class="glass-card"><div style="font-weight:600;margin-bottom:8px">How to Increase Limits</div><div style="font-size:12px">‚Ä¢ Complete more transactions successfully<br>‚Ä¢ Verify additional identity documents<br>‚Ä¢ Maintain low fraud risk patterns<br>‚Ä¢ Upgrade to Premium membership</div></div></div><div class="modal-footer"><button class="btn btn-primary" onclick="forceCloseModal()">Got it</button></div>';
openModal(html);
}

// ============ MATCH & COMPLETION MODALS ============
function showMatchSummaryModal(card){
const savings=DEMO_TX?calculateSavings(DEMO_TX.amount,DEMO_TX.fromCur,DEMO_TX.toCur):0;
// FIX: Use DEMO_TX currencies instead of card currencies for correct display
const yourReceive=DEMO_TX?DEMO_TX.amount*getRate(DEMO_TX.fromCur,DEMO_TX.toCur):card.amount*card.rate;
const receiveCur=DEMO_TX?DEMO_TX.toCur:card.to;
const html='<div class="match-summary"><div class="match-icon">üéâ</div><div class="match-title">It\'s a Match!</div><div class="match-detail">You matched with '+card.name+' for optimal settlement</div><div class="match-stats"><div class="match-stat"><div class="match-stat-label">Your Send</div><div class="match-stat-value">'+(DEMO_TX?fmtCur(DEMO_TX.amount,DEMO_TX.fromCur):'500 AED')+'</div></div><div class="match-stat"><div class="match-stat-label">They Receive</div><div class="match-stat-value">'+fmt(yourReceive,0)+' '+receiveCur+'</div></div><div class="match-stat"><div class="match-stat-label">Combined Score</div><div class="match-stat-value" style="color:var(--green)">'+(getActiveSender().score+card.score)+'</div></div><div class="match-stat"><div class="match-stat-label">Settlement</div><div class="match-stat-value">< 5 min</div></div></div>'+(savings>0?'<div class="savings-highlight" style="margin-top:16px"><div class="amount">+'+fmtCur(savings,receiveCur)+'</div><div class="label">You save vs traditional transfer</div></div>':'')+'</div><div class="modal-footer"><button class="btn btn-secondary" onclick="forceCloseModal()">Close</button><button class="btn btn-primary" onclick="forceCloseModal();setView(\'dashboard\')">View Progress</button></div>';
openModal(html);
}

function showCompletionModal(){
const tx=DEMO_TX;if(!tx)return;
const rate=getRate(tx.fromCur,tx.toCur),tradRate=getTradRate(tx.fromCur,tx.toCur),savings=calculateSavings(tx.amount,tx.fromCur,tx.toCur);
const recv=tx.amount*rate;
const html='<div class="match-summary"><div class="match-icon">üéâ</div><div class="match-title">Transfer Complete!</div><div class="match-detail">'+(tx.recipient?.name||'Recipient')+' received '+fmt(recv,0)+' '+(tx.toCur||'GHS')+'</div><div class="match-stats"><div class="match-stat"><div class="match-stat-label">You Sent</div><div class="match-stat-value">'+fmtCur(tx.amount,tx.fromCur)+'</div></div><div class="match-stat"><div class="match-stat-label">They Got</div><div class="match-stat-value">'+fmt(recv,0)+' '+tx.toCur+'</div></div><div class="match-stat"><div class="match-stat-label">FlowBridge Rate</div><div class="match-stat-value" style="color:var(--green)">'+fmt(rate,2)+'</div></div><div class="match-stat"><div class="match-stat-label">Bank Rate</div><div class="match-stat-value" style="color:var(--red);text-decoration:line-through">'+fmt(tradRate,2)+'</div></div></div>'+(savings>0?'<div class="savings-highlight" style="margin-top:16px"><div class="amount">+'+fmt(savings,0)+' '+tx.toCur+'</div><div class="label">More than bank would give!</div></div>':'')+'<div class="revenue-breakdown"><div style="font-size:11px;color:var(--text2);margin-bottom:8px">Platform Revenue Breakdown</div><div class="revenue-row"><span class="label">FX Spread (1.2%)</span><span class="value">$'+fmt(tx.amount*0.012,2)+'</span></div><div class="revenue-row"><span class="label">LP Fee</span><span class="value">$'+fmt(tx.amount*0.008,2)+'</span></div><div class="revenue-row"><span class="label">Anchor Fee</span><span class="value">$'+fmt(tx.amount*0.004,2)+'</span></div></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="forceCloseModal()">Close</button><button class="btn btn-primary" onclick="forceCloseModal();showToast(\'Receipt downloaded\',\'success\')">üì• Download Receipt</button></div>';
openModal(html);
}

function showQuoteSubmitModal(txId,amount,fromCur,toCur,baseRate){
const corridor=fromCur+'-'+toCur;
const band=PRICING_BANDS[corridor]||PRICING_BANDS.default;
const minRate=baseRate*(1+band.minDeltaPct/100);
const maxRate=baseRate*(1+band.maxDeltaPct/100);
const html='<div class="modal-header"><div class="modal-title">üí∞ Submit Quote</div><button class="modal-close" onclick="forceCloseModal()">‚úï</button></div><div style="padding:16px 0"><div style="background:var(--bg3);padding:12px;border-radius:10px;margin-bottom:16px"><div style="font-size:11px;color:var(--text2);margin-bottom:4px">REQUEST</div><div style="font-weight:600">'+fromCur+' ‚Üí '+toCur+'</div><div style="font-size:12px;color:var(--text2)">'+fmtCur(amount,fromCur)+' ‚Ä¢ Base: '+fmt(baseRate,2)+'</div></div><div class="glass-card" style="margin-bottom:16px;padding:12px;background:rgba(88,166,255,0.05)"><div style="font-size:11px;color:var(--accent);margin-bottom:6px">üìä ALLOWED PRICING RANGE</div><div style="font-size:12px;color:var(--text2)">FlowBridge rate: '+fmt(baseRate,2)+' '+toCur+'</div><div style="font-size:12px;color:var(--text2);margin-top:4px">Your range: '+fmt(minRate,2)+' to '+fmt(maxRate,2)+' '+toCur+'</div><div style="font-size:10px;color:var(--text3);margin-top:6px">Allowed: '+band.minDeltaPct+'% to +'+band.maxDeltaPct+'% vs FlowBridge</div></div><div class="form-group"><label class="form-label">Your Rate (1 '+fromCur+' = ? '+toCur+')</label><div style="display:flex;gap:8px;align-items:flex-end"><input type="number" id="quoteRate" class="form-input" step="0.01" placeholder="Enter your rate" value="'+baseRate+'" min="'+minRate+'" max="'+maxRate+'" onchange="validateLPRate(this,'+minRate+','+maxRate+','+baseRate+')" style="flex:1"><button type="button" class="btn btn-sm btn-secondary" onclick="document.getElementById(\'quoteRate\').value='+baseRate+';validateLPRate(document.getElementById(\'quoteRate\'),'+minRate+','+maxRate+','+baseRate+')" title="Reset to baseline (0% delta)">‚Ü∫ Reset</button></div></div><div id="rateFeedback" style="font-size:11px;margin-top:-8px;margin-bottom:12px"></div><div class="form-group"><label class="form-label">Liquidity Available</label><input type="number" id="quoteLiquidity" class="form-input" value="'+amount+'" placeholder="Amount you can provide"></div><div class="form-group"><label class="form-label">Settlement Time</label><select id="quoteSettlement" class="form-select"><option value="instant">‚ö° Instant (< 5 min)</option><option value="fast">üöÄ Fast (< 30 min)</option><option value="standard">‚è±Ô∏è Standard (< 2 hrs)</option></select></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="forceCloseModal()">Cancel</button><button class="btn btn-primary" onclick="submitLPQuote(\''+txId+'\')">Submit Quote</button></div>';
openModal(html);
}

function validateLPRate(input,minRate,maxRate,baseRate){
  const rate=parseFloat(input.value);
  const feedback=document.getElementById('rateFeedback');
  if(!feedback)return;
  
  if(rate<minRate){
    feedback.innerHTML='<span style="color:var(--red)">‚ö†Ô∏è Rate too low! Minimum: '+fmt(minRate,2)+'</span>';
    input.style.borderColor='var(--red)';
  }else if(rate>maxRate){
    feedback.innerHTML='<span style="color:var(--red)">‚ö†Ô∏è Rate too high! Maximum: '+fmt(maxRate,2)+'</span>';
    input.style.borderColor='var(--red)';
  }else{
    const deltaPct=((rate/baseRate-1)*100);
    const color=deltaPct>=0?'var(--green)':'var(--yellow)';
    feedback.innerHTML='<span style="color:'+color+'">‚úì Valid rate ('+fmt(deltaPct,2)+'% vs FlowBridge)</span>';
    input.style.borderColor='var(--green)';
  }
}

// ============ MOBILE MENU ============
function toggleMobileMenu(){
  const overlay=document.getElementById('mobileMenuOverlay');
  const menu=document.getElementById('mobileMenu');
  if(!overlay||!menu)return;
  
  const isActive=overlay.classList.contains('active');
  if(isActive){
    overlay.classList.remove('active');
    menu.classList.remove('active');
  }else{
    // Render mobile menu content
    renderMobileMenu();
    overlay.classList.add('active');
    menu.classList.add('active');
  }
}

function renderMobileMenu(){
  const content=document.getElementById('mobileMenuContent');
  if(!content)return;
  
  // Reuse sidebar content for mobile menu
  const sb=document.getElementById('sidebar');
  if(sb){
    content.innerHTML=sb.innerHTML;
    
    // Update onclick handlers to close menu after navigation
    const navButtons=content.querySelectorAll('.nav-btn');
    navButtons.forEach(btn=>{
      btn.addEventListener('click',()=>{
        toggleMobileMenu();
      });
    });
  }
}

// ============ NAVIGATION ============
function switchRole(role){currentRole=role;currentView='dashboard';const sel=document.getElementById('roleSelect');if(sel)sel.value=role;render();pushNotif('Switched to '+role.charAt(0).toUpperCase()+role.slice(1)+' view','info')}
function setView(view){currentView=view;render()}
function render(){renderSidebar();renderContent();renderNotifications()}

// ============ TRANSACTION FUNCTIONS ============
function updateSendAmount(val){
  const u=getActiveSender(),lim=getLimit(u.tier);
  if(!DEMO_TX)DEMO_TX={amount:parseInt(val),fromCur:u.baseCur||'AED',toCur:'NGN',status:'pending'};
  else DEMO_TX.amount=parseInt(val);
  render();
}
function updateFromCurrency(cur){
  const u=getActiveSender();
  if(!DEMO_TX)DEMO_TX={amount:500,fromCur:cur,toCur:'NGN',status:'pending'};
  else DEMO_TX.fromCur=cur;
  render();
}
function updateToCurrency(cur){
  const u=getActiveSender();
  if(!DEMO_TX)DEMO_TX={amount:500,fromCur:u.baseCur||'AED',toCur:cur,status:'pending'};
  else DEMO_TX.toCur=cur;
  render();
}
function setAmountMode(mode){amountMode=mode;if(!DEMO_TX){const u=getActiveSender();DEMO_TX={amount:500,fromCur:u.baseCur||"AED",toCur:"NGN",status:"pending",amountMode:mode,receiveAmount:null,scheduled:false,pricingCollapsed:true}}else{const rate=getRate(DEMO_TX.fromCur,DEMO_TX.toCur);if(mode==='receive'&&!DEMO_TX.receiveAmount){DEMO_TX.receiveAmount=Math.round(DEMO_TX.amount*rate)}else if(mode==='send'&&DEMO_TX.receiveAmount){DEMO_TX.amount=Math.round(DEMO_TX.receiveAmount/rate)}DEMO_TX.amountMode=mode}render()}
function updateFromCurrency(cur){const u=getActiveSender();if(!DEMO_TX)DEMO_TX={amount:500,fromCur:cur,toCur:"NGN",status:"pending"};else DEMO_TX.fromCur=cur;render()}
function updateSendAmountInput(val){const num=parseFloat(val)||0;const u=getActiveSender(),lim=getLimit(u.tier);if(!DEMO_TX){DEMO_TX={amount:num,fromCur:u.baseCur||"AED",toCur:"NGN",status:"pending",amountMode:"send"}}else{DEMO_TX.amount=num}if(DEMO_TX.amount<0)DEMO_TX.amount=0;if(DEMO_TX.amount>lim.perTx)DEMO_TX.amount=lim.perTx;render()}
function updateReceiveAmountInput(val){const num=parseFloat(val)||0;if(!DEMO_TX)return;DEMO_TX.receiveAmount=num;const rate=getRate(DEMO_TX.fromCur,DEMO_TX.toCur);if(rate>0){DEMO_TX.amount=Math.round(num/rate)}render()}
function togglePricingBreakdown(){pricingCollapsed=!pricingCollapsed;render()}
function toggleRecipientSection(){recipientCollapsed=!recipientCollapsed;render()}
function selectRecipient(id){
  const r=RECIPIENTS.find(x=>x.id===id);
  if(r){
    const u=getActiveSender();
    // BUG FIX 1: Auto-set corridor based on recipient's country/currency
    const fromCur=u.baseCur||'AED';
    const toCur=r.cur||'NGN';
    if(!DEMO_TX)DEMO_TX={amount:500,fromCur:fromCur,toCur:toCur,status:'pending'};
    DEMO_TX.recipient=r;
    DEMO_TX.toCur=toCur;
    DEMO_TX.fromCur=fromCur;
    // Set corridor string for reference
    DEMO_TX.corridor=fromCur+'‚Üí'+toCur;
    showToast('Corridor set to '+fromCur+' ‚Üí '+toCur+' for '+r.name,'info');
    render();
  }
}
function setSchedule(scheduled){
  const u=getActiveSender();
  if(!DEMO_TX)DEMO_TX={amount:500,fromCur:u.baseCur||'AED',toCur:'NGN',status:'pending'};
  DEMO_TX.scheduled=scheduled;
  DEMO_TX.needByType=scheduled?'scheduled':'immediate';
  DEMO_TX.scheduledTime=scheduled?new Date(Date.now()+120000):null;
  render();
}

function updateScheduleDate(dateStr){
  if(!DEMO_TX)return;
  const dt=new Date(dateStr);
  if(dt&&!isNaN(dt.getTime())){
    DEMO_TX.scheduledTime=dt;
    DEMO_TX.needByDate=dateStr;
    render();
  }
}

function showInviteRecipientModal(){
  const html='<div class="modal-header"><span class="modal-title">üì® Invite New Recipient</span><button class="modal-close" onclick="forceCloseModal()">‚úï</button></div><div class="modal-body"><div class="form-group"><label class="form-label">Recipient Name</label><input type="text" class="form-input" id="inviteName" placeholder="Enter full name"></div><div class="form-group"><label class="form-label">Country</label><select class="form-select" id="inviteCountry"><option value="Ghana">üá¨üá≠ Ghana</option><option value="Philippines">üáµüá≠ Philippines</option><option value="India">üáÆüá≥ India</option><option value="Nigeria">üá≥üá¨ Nigeria</option><option value="Kenya">üá∞üá™ Kenya</option><option value="Zimbabwe">üáøüáº Zimbabwe</option></select></div><div class="form-group"><label class="form-label">Mobile Number</label><input type="text" class="form-input" id="invitePhone" placeholder="+xxx xxx xxx xxxx"></div><div class="form-group"><label class="form-label">Payout Method</label><select class="form-select" id="inviteMethod"><option value="Mobile Money">Mobile Money</option><option value="Bank Transfer">Bank Transfer</option><option value="Cash Pickup">Cash Pickup</option></select></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="forceCloseModal()">Cancel</button><button class="btn btn-primary" onclick="inviteNewRecipient()">Send Invite</button></div>';
  openModal(html);
}

function inviteNewRecipient(){
  const name=document.getElementById('inviteName')?.value;
  const country=document.getElementById('inviteCountry')?.value;
  const phone=document.getElementById('invitePhone')?.value;
  const method=document.getElementById('inviteMethod')?.value;
  if(!name||!phone){showToast('Please fill all required fields','error');return}
  const newR={id:'RCP-'+Math.random().toString(36).substr(2,6).toUpperCase(),name,country,flag:country==='Ghana'?'üá¨üá≠':country==='Philippines'?'üáµüá≠':country==='India'?'üáÆüá≥':country==='Nigeria'?'üá≥üá¨':country==='Kenya'?'üá∞üá™':'üáøüáº',method,account:phone,cur:country==='Ghana'?'GHS':country==='Philippines'?'PHP':country==='India'?'INR':country==='Nigeria'?'NGN':country==='Kenya'?'KES':'ZWL',pending:true};
  RECIPIENTS.push(newR);
  forceCloseModal();
  showToast('‚úâÔ∏è Invite sent to '+name,'success');
  pushNotif('üì® Invited '+name+' to FlowBridge','info','sender');
  pushNotif('üì® New user invitation sent','info','admin');
  render();
}

function switchLP(lpId){
  if(!LP_PROFILES[lpId])return;
  activeLPId=lpId;
  showToast('Switched to '+LP_PROFILES[lpId].name,'info');
  render();
}

function switchAnchor(anchorId){
  if(!ANCHOR_PROFILES[anchorId])return;
  activeAnchorId=anchorId;
  showToast('Switched to '+ANCHOR_PROFILES[anchorId].name,'info');
  render();
}

// BUG FIX 3: Add receiver switching function
function switchReceiver(receiverId){
  if(!RECEIVER_PROFILES[receiverId])return;
  activeReceiverId=receiverId;
  showToast('Switched to '+RECEIVER_PROFILES[receiverId].name,'info');
  render();
}

function toggleUserAsLP(){
  const u=getActiveSender();
  u.canProvideLiquidity=!u.canProvideLiquidity;
  if(u.canProvideLiquidity){
    u.lpCorridors=['AED_GHS','AED_NGN'];
    showToast('‚úÖ You can now provide liquidity as peer LP','success');
    pushNotif('üë§ '+u.name+' enabled as ad-hoc liquidity provider','info','admin');
  }else{
    u.lpCorridors=[];
    showToast('Peer LP mode disabled','info');
  }
  render();
}

function pushStatusNotifications(oldStatus,newStatus,txId){
  const statusMsgs={
    'pending‚Üímatched':'üéâ Transaction matched!',
    'matched‚Üílp_funded':'üí∞ Liquidity provider funded the trade',
    'lp_funded‚Üípayout_processing':'üí≥ Anchor processing payout',
    'payout_processing‚Üícompleted':'‚úÖ Transfer completed successfully'
  };
  const key=oldStatus+'‚Üí'+newStatus;
  if(statusMsgs[key]){
    pushNotif(statusMsgs[key]+' ('+txId+')','success','sender');
    pushNotif(statusMsgs[key]+' ('+txId+')','info','admin');
  }
}

// ============ ACTIVE TRANSACTION HELPER ============
function getActiveTx(){
  if(ACTIVE_TX_ID){
    const found=txHistory.find(t=>t.id===ACTIVE_TX_ID);
    if(found)return found;
  }
  return DEMO_TX;
}

// ============ LP REQUEST & QUOTE FUNCTIONS ============
function createLPRequest(txData){
  const request={
    id:'REQ-'+Math.random().toString(36).substr(2,6).toUpperCase(),
    txId:txData.id,
    amount:txData.amount,
    fromCur:txData.fromCur,
    toCur:txData.toCur,
    corridor:txData.fromCur+'-'+txData.toCur,
    sender:txData.sender,
    status:'pending',
    createdAt:new Date(),
    quotes:[]
  };
  LP_REQUESTS.unshift(request);
  pushNotif('üì§ Quote request sent to LPs','info','sender');
  pushNotif('üì• New quote request: '+request.corridor+' $'+fmt(request.amount,0),'info','lp');
  return request;
}

function submitLPQuote(reqId){
  const rate=parseFloat(document.getElementById('quoteRate')?.value);
  const liquidity=parseFloat(document.getElementById('quoteLiquidity')?.value);
  const settlement=document.getElementById('quoteSettlement')?.value;
  
  if(!rate||rate<=0){showToast('Please enter a valid rate','error');return}
  if(!liquidity||liquidity<=0){showToast('Please enter liquidity amount','error');return}
  
  const request=LP_REQUESTS.find(r=>r.id===reqId);
  if(!request){showToast('Request not found','error');return}
  
  // ENFORCE PRICING LIMITS
  const corridor=request.corridor;
  const band=PRICING_BANDS[corridor]||PRICING_BANDS.default;
  const baseRate=request.baseRate;
  const minRate=baseRate*(1+band.minDeltaPct/100);
  const maxRate=baseRate*(1+band.maxDeltaPct/100);
  
  if(rate<minRate||rate>maxRate){
    showToast('Rate outside allowed range ('+fmt(minRate,2)+' to '+fmt(maxRate,2)+')','error');
    return;
  }
  
  const lpProfile=LP_PROFILES[activeLPId];
  
  // Create quote matching SWIPE card format
  const quote={
    id:request.corridor+'_'+activeLPId+'_'+Date.now(),
    requestId:reqId,
    lpId:activeLPId,
    lpName:lpProfile.name,
    lpProfileId:activeLPId,
    corridor:request.corridor,
    from:request.fromCur,
    to:request.toCur,
    name:lpProfile.name.split(' ')[0]+' '+(lpProfile.name.split(' ')[1]||'').charAt(0)+'.',
    flag:lpProfile.avatar,
    city:lpProfile.homeCountry,
    proximity:'Partner LP',
    lpType:lpProfile.region+' Provider',
    reliability:85+Math.floor(Math.random()*10),
    settlement:settlement==='instant'?'2 min':settlement==='fast'?'15 min':'60 min',
    lpRate:rate,
    fbRate:request.baseRate,
    rateDeltaPct:((rate/request.baseRate-1)*100),
    score:75+Math.floor(Math.random()*15),
    avatar:['#3b82f6','#a855f7','#14b8a6','#f59e0b'][Math.floor(Math.random()*4)],
    badgeHint:'Live quote',
    amount:request.amount,
    liquidity:liquidity,
    createdAt:new Date()
  };
  
  LP_QUOTES.push(quote);
  request.quotes.push(quote.id);
  request.status='quoted';
  
  // Check if we have enough quotes (e.g., 2+) to show sender
  const quotesForRequest=LP_QUOTES.filter(q=>q.requestId===reqId);
  if(quotesForRequest.length>=2){
    // Notify sender that quotes are ready
    pushNotif('‚úÖ '+quotesForRequest.length+' quotes received! View in FlowSwipe','success','sender');
    
    // Update transaction status if it exists
    if(DEMO_TX&&DEMO_TX.id===request.txId){
      DEMO_TX.status='quotes_ready';
      DEMO_TX.availableQuotes=quotesForRequest.length;
    }
  }
  
  forceCloseModal();
  showToast('‚úÖ Quote submitted successfully','success');
  pushNotif('üí∞ Quote received for '+request.corridor,'success','sender');
  pushNotif('üìä Your quote was submitted for '+reqId,'success','lp');
  render();
}

function submitSend(amt,from,to){
  const u=getActiveSender(),lim=getLimit(u.tier);
  
  // VALIDATION: Check if amount is valid
  if(!amt||amt<=0){
    showToast('‚ùå Please enter a valid amount','error');
    return;
  }
  
  // BUG-10 FIX: Validate currency matches user's base currency
  if(from!==u.baseCur){
    showToast('‚ö†Ô∏è Currency mismatch: You can only send from your base currency ('+u.baseCur+')','error');
    return;
  }
  
  // FIX: Convert amount to USD for limit comparison
  const amtUSD=from==='USD'?amt:amt*getRate(from,'USD');
  const dailyUsedUSD=u.dailyUsed*(u.baseCur==='USD'?1:getRate(u.baseCur,'USD'));
  const monthlyUsedUSD=(u.monthlyUsed||0)*(u.baseCur==='USD'?1:getRate(u.baseCur,'USD'));
  
  // Validate limits in USD equivalent
  if(amtUSD>lim.perTx){showToast('Amount exceeds per-transaction limit of '+fmtCur(lim.perTx,'USD')+' ('+fmtCur(amt,from)+' = $'+fmt(amtUSD,2)+')','error');return}
  if(amtUSD+dailyUsedUSD>lim.daily){showToast('Would exceed daily limit of '+fmtCur(lim.daily,'USD'),'error');return}
  if(amtUSD+monthlyUsedUSD>lim.monthly){showToast('Would exceed monthly limit of '+fmtCur(lim.monthly,'USD'),'error');return}
  // Check if user is flagged
  if(u.flagged){showToast('Account flagged for review - transfers temporarily restricted','error');return}
  
  // NEW MULTI-TX FLOW: Create transaction and add to history immediately
  const newTx={
    id:'TX-'+Math.random().toString(36).substr(2,6).toUpperCase(),
    amount:amt,fromCur:from,toCur:to,
    recipient:DEMO_TX?.recipient||RECIPIENTS[0],
    status:'awaiting_lp_quotes',
    scheduled:DEMO_TX?.scheduled||false,
    needByType:DEMO_TX?.scheduled?'scheduled':'immediate',
    scheduledTime:DEMO_TX?.scheduledTime,
    premium:u.premium,
    timestamp:new Date(),
    sender:u.id
  };
  
  // Add to history immediately (non-blocking)
  txHistory.unshift(newTx);
  
  // Update usage
  u.dailyUsed+=amt;
  u.monthlyUsed=(u.monthlyUsed||0)+amt;
  
  // Create LP request
  const baseRate=getRate(from,to);
  const request={
    id:'REQ-'+Math.random().toString(36).substr(2,6).toUpperCase(),
    txId:newTx.id,
    amount:amt,
    fromCur:from,
    toCur:to,
    corridor:from+'-'+to,
    sender:u.id,
    baseRate:baseRate,
    status:'pending',
    createdAt:new Date(),
    quotes:[]
  };
  LP_REQUESTS.unshift(request);
  
  // Keep DEMO_TX as the active transaction so FlowSwipe can access it
  DEMO_TX=newTx;
  
  // FIX 2: Reset swipeIndex when creating new transaction
  swipeIndex=0;
  
  pushNotif('üì§ Transfer '+newTx.id+' submitted - finding best match...','success','sender');
  pushNotif('üì• New quote request: '+from+'‚Üí'+to+' '+fmtCur(amt,from),'info','lp');
  showToast('‚úÖ Transfer submitted! You can create another.','success');
  
  // Redirect to dashboard to see active transfers
  currentView='dashboard';
  render();
  if(guidedMode&&guidedStep===0&&!freeMode)advanceGuidedStep();
}

function swipePass(){
  // FIX 1: Use getActiveTx() for consistency
  const tx=getActiveTx();
  if(!tx){
    showToast('No active transaction','warning');
    return;
  }

  // Get the current filtered swipe list
  let filteredSwipe=SWIPE;
  let usingLiveQuotes=false;

  if(tx.id){
    const liveQuotes=LP_QUOTES.filter(q=>q.requestId&&LP_REQUESTS.find(r=>r.id===q.requestId&&r.txId===tx.id));
    if(liveQuotes.length>0){
      filteredSwipe=liveQuotes;
      usingLiveQuotes=true;
    }
  }

  if(!usingLiveQuotes&&tx.fromCur&&tx.toCur){
    const targetCorridor=tx.fromCur+'-'+tx.toCur;
    filteredSwipe=SWIPE.filter(card=>card.corridor===targetCorridor);
    if(filteredSwipe.length===0){
      filteredSwipe=SWIPE.filter(card=>card.to===tx.toCur);
    }
  }

  swipeIndex++;
  
  // FIX 2: Clamp swipeIndex to prevent overflow
  if(swipeIndex>=filteredSwipe.length){
    swipeIndex=filteredSwipe.length; // Clamp at max
    pushNotif('No more quotes available','info','sender');
  }else{
    pushNotif('Passed on match opportunity','info','sender');
  }
  render();
}

function swipeMatch(){
  // FIX 4: Properly accept LP quote and update transaction status
  let filteredSwipe=SWIPE;
  let usingLiveQuotes=false;
  let activeTxId=ACTIVE_TX_ID||DEMO_TX?.id;

  if(activeTxId){
    const liveQuotes=LP_QUOTES.filter(q=>q.requestId&&LP_REQUESTS.find(r=>r.id===q.requestId&&r.txId===activeTxId));
    if(liveQuotes.length>0){
      filteredSwipe=liveQuotes;
      usingLiveQuotes=true;
    }
  }

  if(!usingLiveQuotes&&DEMO_TX&&DEMO_TX.fromCur&&DEMO_TX.toCur){
    const targetCorridor=DEMO_TX.fromCur+'-'+DEMO_TX.toCur;
    filteredSwipe=SWIPE.filter(card=>card.corridor===targetCorridor);
    if(filteredSwipe.length===0){
      filteredSwipe=SWIPE.filter(card=>card.to===DEMO_TX.toCur);
    }
  }

  const card=filteredSwipe[swipeIndex];
  if(!card||!DEMO_TX)return;
  
  // PROPERLY ACCEPT THE QUOTE
  DEMO_TX.status='matched';
  DEMO_TX.matchedWith=card;
  DEMO_TX.matchedLpId=card.lpId||card.lpProfileId;
  DEMO_TX.appliedRate=card.lpRate||card.fbRate;
  DEMO_TX.matchedQuoteId=card.id;
  DEMO_TX.matchTime=new Date();
  
  // Update the LP request if using live quotes
  if(usingLiveQuotes){
    const request=LP_REQUESTS.find(r=>r.txId===activeTxId);
    if(request){
      request.status='matched';
      request.selectedQuoteId=card.id;
    }
  }
  
  swipeIndex++;
  
  // Send notifications to ALL roles
  pushNotif('üéâ Matched with '+card.name+'! Rate: '+fmt(DEMO_TX.appliedRate,2),'success','sender');
  pushNotif('üì• New order from '+getActiveSender().name,'info','lp');
  pushNotif('üìã Match detected: '+DEMO_TX.id+' ‚Üí LP','info','admin');
  
  showMatchSummaryModal(card);
  
  if(guidedMode&&guidedStep===1&&!freeMode)advanceGuidedStep();
  
  render();
}

function lpAcceptOrder(){
  if(!DEMO_TX)return;
  
  // FIXED: Always update status to lp_funded
  DEMO_TX.status='lp_funded';
  DEMO_TX.lpTime=new Date();
  
  // FEATURE: Generate 6-digit payout code
  DEMO_TX.payoutCode=Math.floor(100000+Math.random()*900000).toString();
  
  // FIXED: Update LP liquidity bars consistently
  const pair=DEMO_TX.fromCur+'_'+DEMO_TX.toCur;
  const lpProfile=LP_PROFILES[activeLPId];
  if(lpProfile&&lpProfile.positions[pair]){
    lpProfile.positions[pair].locked+=DEMO_TX.amount;
    lpProfile.positions[pair].available=Math.max(0,lpProfile.positions[pair].available-DEMO_TX.amount);
    lpProfile.positions[pair].util=lpProfile.positions[pair].locked/(lpProfile.positions[pair].available+lpProfile.positions[pair].locked)||0;
  }
  if(LP_STATE[pair]){
    LP_STATE[pair].locked+=DEMO_TX.amount;
    LP_STATE[pair].available=Math.max(0,LP_STATE[pair].available-DEMO_TX.amount);
    LP_STATE[pair].util=LP_STATE[pair].locked/(LP_STATE[pair].available+LP_STATE[pair].locked)||0;
  }
  
  // FIXED: Increment LP revenue correctly
  const revenue=DEMO_TX.amount*0.008;
  LP_REVENUE+=revenue;
  if(lpProfile)lpProfile.revenue+=revenue;
  
  // FIXED: Notify ALL roles
  pushNotif('‚úÖ Order '+DEMO_TX.id+' funded','success','lp');
  pushNotif('üí∞ LP funded your transfer!','success','sender');
  pushNotif('üì• New payout ready: '+DEMO_TX.id,'info','anchor');
  pushNotif('üìã LP accepted order '+DEMO_TX.id,'info','admin');
  pushNotif('üí∞ Payment processing...','info','receiver');
  
  showToast('Order funded successfully!','success');
  
  // FIXED: Advance guided demo
  if(guidedMode&&guidedStep===2&&!freeMode)advanceGuidedStep();
  
  // FIXED: Force render
  render();
}

function anchorProcessPayout(){
  if(!DEMO_TX)return;
  
  // FEATURE: Show code verification modal if payout code exists
  if(DEMO_TX.payoutCode){
    showPayoutCodeVerificationModal();
  }else{
    // Legacy flow without code
    anchorVerifyAndCompletePayout();
  }
}

function showPayoutCodeVerificationModal(){
  const html='<div class="modal-header"><span class="modal-title">üîê Verify Payout Code</span><button class="modal-close" onclick="forceCloseModal()">‚úï</button></div><div class="modal-body"><div class="glass-card" style="margin-bottom:16px"><div style="font-weight:600;margin-bottom:8px">Transaction Details</div><div style="font-size:12px;line-height:1.8"><div>ID: '+DEMO_TX.id+'</div><div>Amount: '+fmt((DEMO_TX.amount||500)*getRate(DEMO_TX.fromCur||'AED',DEMO_TX.toCur||'GHS'),0)+' '+(DEMO_TX.toCur||'GHS')+'</div><div>Recipient: '+(DEMO_TX.recipient?.name||'Kofi')+'</div></div></div><div class="form-group"><label class="form-label">6-Digit Payout Code</label><input type="text" class="form-input" id="payoutCodeInput" placeholder="000000" maxlength="6" pattern="[0-9]{6}" style="font-size:24px;font-family:JetBrains Mono;letter-spacing:8px;text-align:center"></div><div style="font-size:11px;color:var(--text2);text-align:center;margin-top:8px">üì± The recipient must present this code to receive funds</div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="forceCloseModal()">Cancel</button><button class="btn btn-success" onclick="verifyPayoutCode()">Verify & Release Funds</button></div>';
  openModal(html);
}

function verifyPayoutCode(){
  const inputCode=document.getElementById('payoutCodeInput')?.value;
  if(!inputCode||inputCode.length!==6){
    showToast('Please enter a 6-digit code','error');
    return;
  }
  if(inputCode!==DEMO_TX.payoutCode){
    showToast('‚ùå Invalid code - payout denied','error');
    pushNotif('‚ö†Ô∏è Failed payout verification attempt for '+DEMO_TX.id,'warning','admin');
    return;
  }
  // Code verified successfully
  forceCloseModal();
  showToast('‚úÖ Code verified - releasing funds','success');
  anchorVerifyAndCompletePayout();
}

function anchorVerifyAndCompletePayout(){
  if(!DEMO_TX)return;
  
  // Set status to payout_processing
  DEMO_TX.status='payout_processing';
  DEMO_TX.payoutTime=new Date();
  
  // Update anchor state consistently
  const anchorProfile=ANCHOR_PROFILES[activeAnchorId];
  if(anchorProfile){
    anchorProfile.pending=Math.max(0,anchorProfile.pending-1);
  }
  if(ANCHOR_STATE.ghana){
    ANCHOR_STATE.ghana.pending=Math.max(0,ANCHOR_STATE.ghana.pending-1);
  }
  
  // Send notifications to all roles
  pushNotif('üí≥ Processing payout for '+(DEMO_TX.recipient?.name||'Kofi'),'info','anchor');
  pushNotif('üì§ Your funds are being paid out!','success','sender');
  pushNotif('üí∞ Incoming payment processing...','info','receiver');
  pushNotif('üìã Payout initiated for '+DEMO_TX.id,'info','admin');
  
  showToast('Payout processing...','info');
  
  // Advance guided demo
  if(guidedMode&&guidedStep===3&&!freeMode)advanceGuidedStep();
  
  render();
  
  // After 2s, set to completed
  setTimeout(()=>{completeTransaction()},2000);
}

function completeTransaction(){
  if(!DEMO_TX)return;
  
  // FIXED: Set status to completed
  DEMO_TX.status='completed';
  DEMO_TX.completedTime=new Date();
  
  // FIXED: Update sender score
  const u=getActiveSender();
  if(u){
    u.score=Math.min(100,u.score+2);
    u.tier=getTierFromScore(u.score);
  }
  
  // FIXED: Increment anchor revenue and completed count
  const revenue=DEMO_TX.amount*0.004;
  ANCHOR_REVENUE+=revenue;
  const anchorProfile=ANCHOR_PROFILES[activeAnchorId];
  if(anchorProfile){
    anchorProfile.completed++;
    anchorProfile.commission+=revenue;
  }
  if(ANCHOR_STATE.ghana){
    ANCHOR_STATE.ghana.completed++;
  }
  
  // FIXED: Record revenue
  recordTxRevenue(DEMO_TX);
  
  // BUG-11 FIX: Use full object spread to capture all properties
  const txCopy={...DEMO_TX};
  txHistory.unshift(txCopy);
  
  // FIXED: Notify all roles
  pushNotif('üéâ Transfer complete!','success','sender');
  pushNotif('‚úÖ Payout delivered','success','anchor');
  pushNotif('üí∞ Funds received!','success','receiver');
  pushNotif('üìä Transaction '+DEMO_TX.id+' settled','info','admin');
  
  showCompletionModal();
  
  // FIXED: Advance guided demo
  if(guidedMode&&guidedStep===4&&!freeMode)advanceGuidedStep();
  
  // FIXED: Force render to update receiver timeline
  render();
}

function recordTxRevenue(tx){
  if(!tx)return;
  const amt=tx.amount||500,spread=0.012,lpCut=0.008,anchorCut=0.004;
  BUSINESS_METRICS.revenueTotal+=amt*spread;
  BUSINESS_METRICS.revenueFX+=amt*spread*0.6;
  BUSINESS_METRICS.revenueLP+=amt*lpCut;
  BUSINESS_METRICS.revenueAnchor+=amt*anchorCut;
  BUSINESS_METRICS.totalVolume+=amt;
  BUSINESS_METRICS.txCount++;
  const savings=calculateSavings(amt,tx.fromCur||'AED',tx.toCur||'NGN');
  TOTAL_SAVINGS+=savings;
  updateSavingsTicker();
}

// ============ RENDER SIDEBAR ============
function renderSidebar(){
const sb=document.getElementById('sidebar');if(!sb)return;
let user,nav='';
const gp=guidedMode?'<div class="guided-progress">üéì <span class="step">Step '+(guidedStep+1)+'/'+GUIDED_STEPS.length+'</span> '+GUIDED_STEPS[guidedStep]?.action+'</div>':'';

if(currentRole==='sender'){
  user=getActiveSender();
  nav='<div class="nav-section">Dashboard</div><button class="nav-btn'+(currentView==='dashboard'?' active':'')+'" onclick="setView(\'dashboard\')"><span class="nav-btn-icon">üìä</span>Overview</button><button class="nav-btn'+(currentView==='send'?' active':'')+'" onclick="setView(\'send\')"><span class="nav-btn-icon">üí∏</span>Send Money</button><button class="nav-btn'+(currentView==='swipe'?' active':'')+'" onclick="setView(\'swipe\')"><span class="nav-btn-icon">üîÑ</span>FlowSwipe</button><button class="nav-btn'+(currentView==='history'?' active':'')+'" onclick="setView(\'history\')"><span class="nav-btn-icon">üìú</span>History'+(txHistory.length?'<span class="nav-btn-badge">'+txHistory.length+'</span>':'')+'</button><button class="nav-btn'+(currentView==='profile'?' active':'')+'" onclick="setView(\'profile\')"><span class="nav-btn-icon">üë§</span>Profile</button>';
}
else if(currentRole==='lp'){
  // BUG FIX 2: Use active LP profile instead of hardcoded
  const lpProfile=LP_PROFILES[activeLPId]||LP_PROFILES.kwame;
  user={name:lpProfile.name,avatar:lpProfile.avatar,tier:'provider',color:'#3fb950',premium:false};
// FIX 2: Add pending requests badge
const pendingCount=LP_REQUESTS.filter(r=>r.status==='pending').length;
  nav='<div class="nav-section">Operations</div><button class="nav-btn'+(currentView==='dashboard'?' active':'')+'" onclick="setView(\'dashboard\')"><span class="nav-btn-icon">üìä</span>Dashboard</button><button class="nav-btn'+(currentView==='orders'?' active':'')+'" onclick="setView(\'orders\')"><span class="nav-btn-icon">üìã</span>Order Book'+(pendingCount?'<span class="nav-btn-badge">'+pendingCount+'</span>':DEMO_TX&&DEMO_TX.status==='matched'?'<span class="nav-btn-badge">1</span>':'')+'</button><button class="nav-btn'+(currentView==='positions'?' active':'')+'" onclick="setView(\'positions\')"><span class="nav-btn-icon">üí∞</span>Positions</button><button class="nav-btn'+(currentView==='pricing'?' active':'')+'" onclick="setView(\'pricing\')"><span class="nav-btn-icon">üí≤</span>Corridor Pricing</button><button class="nav-btn'+(currentView==='profile'?' active':'')+'" onclick="setView(\'profile\')"><span class="nav-btn-icon">üè¢</span>Profile</button>';
}
else if(currentRole==='anchor'){
  // BUG FIX 2: Use active Anchor profile instead of hardcoded
  const anchorProfile=ANCHOR_PROFILES[activeAnchorId]||ANCHOR_PROFILES.mpesa;
  user={name:anchorProfile.name,avatar:anchorProfile.avatar,tier:'anchor',color:'#d29922',premium:false};
  nav='<div class="nav-section">Operations</div><button class="nav-btn'+(currentView==='dashboard'?' active':'')+'" onclick="setView(\'dashboard\')"><span class="nav-btn-icon">üìä</span>Dashboard</button><button class="nav-btn'+(currentView==='payouts'?' active':'')+'" onclick="setView(\'payouts\')"><span class="nav-btn-icon">üí≥</span>Payouts'+(DEMO_TX&&DEMO_TX.status==='lp_funded'?'<span class="nav-btn-badge">1</span>':'')+'</button><button class="nav-btn'+(currentView==='history'?' active':'')+'" onclick="setView(\'history\')"><span class="nav-btn-icon">üìú</span>History</button><button class="nav-btn'+(currentView==='profile'?' active':'')+'" onclick="setView(\'profile\')"><span class="nav-btn-icon">üîê</span>Profile</button>';
}
else if(currentRole==='receiver'){
  // BUG FIX 3: Use active receiver profile instead of hardcoded
  const receiverProfile=RECEIVER_PROFILES[activeReceiverId]||RECEIVER_PROFILES.ghana;
  user={name:receiverProfile.name,avatar:receiverProfile.avatar,tier:'recipient',color:'#a371f7',premium:false};
  nav='<div class="nav-section">My Money</div><button class="nav-btn'+(currentView==='dashboard'?' active':'')+'" onclick="setView(\'dashboard\')"><span class="nav-btn-icon">üìä</span>Incoming</button><button class="nav-btn'+(currentView==='history'?' active':'')+'" onclick="setView(\'history\')"><span class="nav-btn-icon">üìú</span>History</button><button class="nav-btn'+(currentView==='profile'?' active':'')+'" onclick="setView(\'profile\')"><span class="nav-btn-icon">üë§</span>Profile</button>';
}
else if(currentRole==='admin'){
  user={name:'Admin Panel',avatar:'‚öôÔ∏è',tier:'admin',color:'#f85149',premium:false};
  const openIssues=ISSUES.filter(i=>i.status==='open').length;
  nav='<div class="nav-section">Platform</div><button class="nav-btn'+(currentView==='dashboard'?' active':'')+'" onclick="setView(\'dashboard\')"><span class="nav-btn-icon">üìä</span>Overview</button><button class="nav-btn'+(currentView==='transactions'?' active':'')+'" onclick="setView(\'transactions\')"><span class="nav-btn-icon">üìã</span>Transactions</button><button class="nav-btn'+(currentView==='issues'?' active':'')+'" onclick="setView(\'issues\')"><span class="nav-btn-icon">üö©</span>Issues'+(openIssues?'<span class="nav-btn-badge">'+openIssues+'</span>':'')+'</button><button class="nav-btn'+(currentView==='revenue'?' active':'')+'" onclick="setView(\'revenue\')"><span class="nav-btn-icon">üí∞</span>Revenue</button><button class="nav-btn'+(currentView==='corridors'?' active':'')+'" onclick="setView(\'corridors\')"><span class="nav-btn-icon">üåç</span>Corridors</button><button class="nav-btn'+(currentView==='pricing'?' active':'')+'" onclick="setView(\'pricing\')"><span class="nav-btn-icon">üí≤</span>Pricing Controls</button><button class="nav-btn'+(currentView==='fraud'?' active':'')+'" onclick="setView(\'fraud\')"><span class="nav-btn-icon">üõ°Ô∏è</span>Fraud</button>';
}

const tierBadge=user.tier==='provider'?'badge-success':user.tier==='anchor'?'badge-warning':user.tier==='admin'?'badge-danger':user.tier==='recipient'?'badge-info':'badge-'+user.tier;
sb.innerHTML=gp+'<div class="sidebar-header"><div class="sidebar-avatar" style="background:'+user.color+'">'+user.avatar+'</div><div class="sidebar-name">'+user.name+'</div><div class="sidebar-role">'+currentRole+'</div><div class="sidebar-badges"><span class="badge '+tierBadge+'">'+user.tier+'</span>'+(user.premium?'<span class="badge badge-premium">‚≠ê Premium</span>':'')+'</div></div><nav class="sidebar-nav">'+nav+'</nav>';
}

// ============ RENDER CONTENT ROUTER ============
function renderContent(){
const c=document.getElementById('content');if(!c)return;
try{
if(currentRole==='sender'){
  if(currentView==='dashboard')c.innerHTML=renderSenderDash();
  else if(currentView==='send')c.innerHTML=renderSendMoney();
  else if(currentView==='swipe')c.innerHTML=renderSwipeView();
  else if(currentView==='history')c.innerHTML=renderSenderHistory();
  else if(currentView==='profile')c.innerHTML=renderSenderProfile();
  else c.innerHTML=renderSenderDash();
}
else if(currentRole==='lp'){
  if(currentView==='dashboard')c.innerHTML=renderLPDash();
  else if(currentView==='orders')c.innerHTML=renderLPOrders();
  else if(currentView==='positions')c.innerHTML=renderLPPositions();
  else if(currentView==='pricing')c.innerHTML=renderLPPricing();
  else if(currentView==='profile')c.innerHTML=renderLPProfile();
  else c.innerHTML=renderLPDash();
}
else if(currentRole==='anchor'){
  if(currentView==='dashboard')c.innerHTML=renderAnchorDash();
  else if(currentView==='payouts')c.innerHTML=renderAnchorPayouts();
  else if(currentView==='history')c.innerHTML=renderAnchorHistory();
  else if(currentView==='pricing')c.innerHTML=renderAnchorPricing();
  else if(currentView==='profile')c.innerHTML=renderAnchorProfile();
  else c.innerHTML=renderAnchorDash();
}
else if(currentRole==='receiver'){
  if(currentView==='dashboard')c.innerHTML=renderReceiverDash();
  else if(currentView==='history')c.innerHTML=renderReceiverHistory();
  else if(currentView==='profile')c.innerHTML=renderReceiverProfile();
  else c.innerHTML=renderReceiverDash();
}
else if(currentRole==='admin'){
  if(currentView==='dashboard')c.innerHTML=renderAdminDash();
  else if(currentView==='transactions')c.innerHTML=renderAdminTx();
  else if(currentView==='issues')c.innerHTML=renderAdminIssues();
  else if(currentView==='revenue')c.innerHTML=renderAdminRevenue();
  else if(currentView==='corridors')c.innerHTML=renderAdminCorridors();
  else if(currentView==='pricing')c.innerHTML=renderAdminPricing();
  else if(currentView==='fraud')c.innerHTML=renderAdminFraud();
  else c.innerHTML=renderAdminDash();
}

}catch(e){console.error('Render error:',e);c.innerHTML='<div class="card"><div class="empty-state"><div class="empty-icon">‚ö†Ô∏è</div><div class="empty-title">Render Error</div></div></div>'}
}

// ============ SENDER VIEWS ============
function renderSenderDash(){
const u=getActiveSender(),lim=getLimit(u.tier),pct=Math.round((u.score/100)*339),offset=339-pct;
const hl=guidedMode&&guidedStep===0&&!freeMode?' guided-highlight':'';

// User selector
const userSelector='<div class="user-selector">'+Object.entries(USERS).map(([k,usr])=>'<div class="user-pill'+(k===activeSenderId?' active':'')+'" onclick="switchSenderUser(\''+k+'\')"><span class="avatar">'+usr.avatar+'</span><span>'+usr.name.split(' ')[0]+'</span><span class="badge badge-'+usr.tier+'" style="padding:2px 6px;font-size:8px">'+usr.tier.charAt(0).toUpperCase()+'</span></div>').join('')+'</div>';

// FEATURE: Show pending LP quote requests
const myRequests=LP_REQUESTS.filter(r=>r.sender===u.id&&r.status==='pending');
const myQuoted=LP_REQUESTS.filter(r=>r.sender===u.id&&r.status==='quoted');
const pendingSection=(myRequests.length||myQuoted.length)?'<div class="card" style="margin-bottom:16px"><div class="card-header"><div class="card-title">üìã Your Active Transfers</div></div>'+myQuoted.map(req=>{const quotes=LP_QUOTES.filter(q=>q.requestId===req.id);return'<div class="tx-row" style="border-color:var(--green);background:rgba(63,185,80,0.05)" onclick="ACTIVE_TX_ID=\''+req.txId+'\';setView(\'swipe\');showToast(\'Viewing '+quotes.length+' quotes for '+req.corridor+'\',\'info\')"><div class="tx-icon" style="background:rgba(63,185,80,0.15)">‚úÖ</div><div class="tx-info"><div class="tx-title">'+req.id+' <span class="badge badge-success">'+quotes.length+' quotes ready</span></div><div class="tx-detail">'+req.corridor+' ‚Ä¢ '+fmtCur(req.amount,req.fromCur)+'</div></div><div class="tx-amount"><button class="btn btn-sm btn-success" onclick="event.stopPropagation();ACTIVE_TX_ID=\''+req.txId+'\';setView(\'swipe\')">View Quotes</button></div></div>'}).join('')+myRequests.map(req=>'<div class="tx-row"><div class="tx-icon" style="background:rgba(88,166,255,0.1)">‚è≥</div><div class="tx-info"><div class="tx-title">'+req.id+' <span class="badge badge-warning">Awaiting quotes</span></div><div class="tx-detail">'+req.corridor+' ‚Ä¢ '+fmtCur(req.amount,req.fromCur)+'</div></div></div>').join('')+'</div>':'';

return userSelector+pendingSection+'<div class="score-section'+hl+'"><div class="score-ring"><svg viewBox="0 0 120 120"><circle class="bg" cx="60" cy="60" r="54"/><circle class="progress" cx="60" cy="60" r="54" style="stroke-dashoffset:'+offset+'"/></svg><div class="score-inner"><div class="score-num">'+u.score+'</div><div class="score-lbl">FlowScore</div></div></div><div class="score-info"><div class="score-title">'+u.tier.charAt(0).toUpperCase()+u.tier.slice(1)+' Member</div><div class="score-sub">Per TX: '+fmtCur(lim.perTx,'USD')+' ‚Ä¢ Daily: '+fmtCur(lim.daily,'USD')+' ‚Ä¢ Used: '+fmtCur(u.dailyUsed,'USD')+'</div><div class="score-actions"><button class="btn btn-primary" onclick="setView(\'send\')">üí∏ Send Money</button><button class="btn btn-secondary" onclick="setView(\'swipe\')">üîÑ FlowSwipe</button></div><div class="score-controls"><button class="score-ctrl-btn" onclick="simulateScoreChange(-10)">üìâ Lower Score</button><button class="score-ctrl-btn" onclick="simulateScoreChange(10)">üìà Raise Score</button><button class="score-ctrl-btn" onclick="const u=getActiveSender();u.premium=!u.premium;render();showToast(u.premium?\'Premium enabled\':\'Premium disabled\')">‚≠ê Toggle Premium</button></div><div class="tier-bar"><div class="tier-item'+(u.tier==='bronze'?' active':'')+'"><div class="tier-name">Bronze</div><div class="tier-limit">$'+fmt(TIER_LIMITS.bronze.perTx,0)+'/tx</div></div><div class="tier-item'+(u.tier==='silver'?' active':'')+'"><div class="tier-name">Silver</div><div class="tier-limit">$'+fmt(TIER_LIMITS.silver.perTx,0)+'/tx</div></div><div class="tier-item'+(u.tier==='gold'?' active':'')+'"><div class="tier-name">Gold</div><div class="tier-limit">$'+fmt(TIER_LIMITS.gold.perTx,0)+'/tx</div></div><div class="tier-item'+(u.tier==='platinum'?' active':'')+'"><div class="tier-name">Platinum</div><div class="tier-limit">$'+fmt(TIER_LIMITS.platinum.perTx,0)+'/tx</div></div></div></div></div>'+renderSenderTimeline();
}

function renderSenderTimeline(){
  // Show most recent active transaction from history
  const u=getActiveSender();
  const myTxs=txHistory.filter(t=>t.sender===u.id&&t.status!=='completed');
  
  if(!myTxs.length)return'<div class="card"><div class="card-header"><div class="card-title">üìç Recent Activity</div></div><div class="empty-state"><div class="empty-icon">üí∏</div><div class="empty-title">No active transfers</div><div class="empty-text">Start a new transfer or try FlowSwipe</div></div></div>';
  
  const tx=myTxs[0]; // Show most recent
  
  // Unified status steps matching the workflow
  const steps=[
    {label:'Transfer Created',status:'awaiting_lp_quotes',done:true,time:tx.timestamp?.toLocaleTimeString()},
    {label:'LP Quotes Received',status:'quotes_ready',done:['quotes_ready','lp_selected','matched','lp_funded','payout_in_progress','payout_processing','completed'].includes(tx.status)},
    {label:'LP Selected',status:'lp_selected',done:['lp_selected','matched','lp_funded','payout_in_progress','payout_processing','completed'].includes(tx.status)},
    {label:'LP Funded',status:'lp_funded',done:['lp_funded','payout_in_progress','payout_processing','completed'].includes(tx.status)},
    {label:'Payout Processing',status:'payout_in_progress',done:['payout_in_progress','payout_processing','completed'].includes(tx.status)},
    {label:'Transfer Complete',status:'completed',done:tx.status==='completed'}
  ];
  
  const activeIdx=steps.findIndex(s=>!s.done);
  
  return'<div class="card"><div class="card-header"><div class="card-title">üìç Transfer: '+tx.id+'</div><span class="badge badge-info">'+tx.status.replace(/_/g,' ')+'</span>'+(tx.scheduled?'<span class="badge badge-scheduled">Scheduled</span>':'')+'</div><div class="timeline">'+steps.map((s,i)=>'<div class="timeline-item"><div class="timeline-dot '+(s.done?'complete':i===activeIdx?'active':'pending')+'">'+(s.done?'‚úì':i+1)+'</div><div class="timeline-content"><div class="timeline-title">'+s.label+'</div>'+(s.time?'<div class="timeline-time">'+s.time+'</div>':'')+'</div></div>').join('')+'</div><div style="display:flex;gap:8px;margin-top:16px;flex-wrap:wrap"><div class="info-link" onclick="showSettlementModal()">‚ÑπÔ∏è How settlement works</div>'+(tx.status!=='completed'?'<div class="info-link" onclick="showIssueModal(\'sender\')" style="color:var(--yellow)">üö© Flag Issue</div>':'')+'</div></div>';
}

function renderSendMoney(){
const u=getActiveSender(),lim=getLimit(u.tier);
const fromCur=DEMO_TX?.fromCur||u.baseCur||'AED';
const toCur=DEMO_TX?.toCur||'NGN',amt=DEMO_TX?.amount||500;
const rate=getRate(fromCur,toCur),recv=amt*rate,tradRate=getTradRate(fromCur,toCur),savings=calculateSavings(amt,fromCur,toCur);
const hl=guidedMode&&guidedStep===0&&!freeMode?' guided-highlight':'';

// Calculate pricing breakdown for selected corridor
const corridor=TOP_CORRIDORS.find(c=>c.from===fromCur&&c.to===toCur);
const tier=corridor?.tier||2;
const amtUSDforPricing=fromCur==='USD'?amt:amt*getRate(fromCur,'USD');
const pricing=calculatePricing(tier,amtUSDforPricing);
const pricingBreakdown='<div class="glass-card" style="margin-top:12px;padding:12px"><div style="font-weight:600;margin-bottom:8px;font-size:12px">üí∞ Pricing Breakdown (Tier '+tier+')</div><div class="revenue-breakdown"><div class="revenue-row"><span class="label">LP Fee</span><span class="value">$'+fmt(pricing.lpFee,2)+'</span></div><div class="revenue-row"><span class="label">Anchor Fee</span><span class="value">$'+fmt(pricing.anchorFee,2)+'</span></div><div class="revenue-row"><span class="label">FlowBridge Margin</span><span class="value">$'+fmt(pricing.fbMargin,2)+'</span></div><div class="revenue-row" style="border-top:1px solid var(--border);padding-top:8px;margin-top:4px"><span class="label" style="font-weight:600">Total Fee</span><span class="value" style="font-weight:700">$'+fmt(pricing.totalFee,2)+'</span></div><div class="revenue-row"><span class="label">Effective Cost</span><span class="value">'+fmt(pricing.effCostPct,3)+'%</span></div></div><div style="font-size:10px;color:var(--green);margin-top:8px">‚úì Still 5-10x cheaper than Western Union</div></div>';

// FX-based limit validation
const amtUSD=fromCur==='USD'?amt:amt*getRate(fromCur,'USD');
const dailyUsedUSD=u.dailyUsed*(u.baseCur==='USD'?1:getRate(u.baseCur,'USD'));

const overLimit=amtUSD>lim.perTx;
const overDaily=(amtUSD+dailyUsedUSD)>lim.daily;
const limitMsg=overLimit?'<div class="form-error" id="limitWarning">‚ö†Ô∏è Exceeds per-transaction limit of '+fmtCur(lim.perTx,'USD')+' (sending '+fmtCur(amt,fromCur)+' ‚âà $'+fmt(amtUSD,2)+') <a onclick="showLimitInfoModal()">Why?</a></div>':overDaily?'<div class="form-error" id="limitWarning">‚ö†Ô∏è Would exceed daily limit of '+fmtCur(lim.daily,'USD')+' (total: $'+fmt(amtUSD+dailyUsedUSD,2)+') <a onclick="showLimitInfoModal()">Why?</a></div>':'';
const trustMsg=u.score>=75&&!overLimit&&!overDaily?'<div class="form-hint">‚úì Trusted user: higher limits unlocked</div>':u.score<50?'<div class="form-error">Your current risk tier limits you to '+fmtCur(lim.perTx,'USD')+' per transaction <a onclick="showLimitInfoModal()">Why?</a></div>':'';

// FIX 1: Add datetime-local input for scheduling
const scheduleInput=DEMO_TX?.scheduled?'<div class="form-group"><label class="form-label">Schedule Date & Time</label><input type="datetime-local" class="form-input" value="'+(DEMO_TX.needByDate||'')+'" onchange="updateScheduleDate(this.value)"></div>':'';

// FIX 3: Add "+ Invite New" button
const inviteBtn='<button class="btn btn-sm btn-secondary" onclick="showInviteRecipientModal()" style="width:100%;margin-top:8px">+ Invite New Recipient</button>';

// Change #2: Collapsed Recipient Selection
const selectedRecipient=DEMO_TX?.recipient||null;
const recipientHeader='<div style="cursor:pointer;display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--bg3);border-radius:8px;margin-bottom:'+(recipientCollapsed?'16px':'8px')+'" onclick="toggleRecipientSection()"><div style="display:flex;align-items:center;gap:10px">'+(selectedRecipient?'<span style="font-size:20px">'+selectedRecipient.flag+'</span><div><div style="font-weight:600;font-size:13px">'+selectedRecipient.name+'</div><div style="font-size:11px;color:var(--text2)">'+selectedRecipient.method+' ‚Ä¢ '+selectedRecipient.account+'</div></div>':'<span>üë§ Select Recipient</span>')+'</div><span>'+(recipientCollapsed?'‚ñº':'‚ñ≤')+'</span></div>';
const recipientList=recipientCollapsed?'':RECIPIENTS.slice(0,4).map(r=>'<div class="recipient-card'+(DEMO_TX?.recipient?.id===r.id?' selected':'')+'" onclick="selectRecipient(\''+r.id+'\');recipientCollapsed=true;render()"><div class="recipient-avatar" style="background:var(--bg4)">'+r.flag+'</div><div class="recipient-info"><div class="recipient-name">'+r.name+(r.pending?' <span class="badge badge-warning" style="font-size:9px">Pending</span>':'')+'</div><div class="recipient-detail">'+r.method+' ‚Ä¢ '+r.account+'</div></div></div>').join('')+(recipientCollapsed?'':inviteBtn);

// FIX 5: Add peer-LP toggle

// UI Enhancements
const mode=DEMO_TX?.amountMode||amountMode||'send';
const modeToggle='<div class="form-group"><label class="form-label">Amount Mode</label><div class="grid-2"><label class="schedule-option'+(mode==='send'?' active':'')+'"><input type="radio" name="amountMode" '+(mode==='send'?'checked':'')+' onclick="setAmountMode(\'send\')"><span>üì§ I want to SEND</span></label><label class="schedule-option'+(mode==='receive'?' active':'')+'"><input type="radio" name="amountMode" onclick="setAmountMode(\'receive\')"><span>üì• Receiver gets</span></label></div></div>';

// Mode-specific amounts and labels
const primaryAmount=mode==='send'?amt:Math.round(recv);
const primaryCur=mode==='send'?fromCur:toCur;
const secondaryAmount=mode==='send'?recv:amt;
const secondaryCur=mode==='send'?toCur:fromCur;
const primaryLabel=mode==='send'?'YOU SEND ('+fromCur+')':'RECEIVER GETS ('+toCur+')';
const secondaryLabel=mode==='send'?toCur+' received':'You need to send';

// Get currency metadata for inline pill
const primaryCurMeta=CURRENCY_META[primaryCur]||{flag:'üåç',symbol:'$'};
const secondaryCurMeta=CURRENCY_META[secondaryCur]||{flag:'üåç',symbol:'$'};

// Unified amount field with inline currency pill
const unifiedAmountField=mode==='send'?'<div style="position:relative"><input type="number" class="form-input" value="'+amt+'" min="100" max="'+lim.perTx+'" step="50" onchange="updateSendAmountInput(this.value)" style="font-size:40px;font-weight:700;text-align:center;padding:20px 120px 20px 20px;background:var(--bg3);border-radius:14px;margin-bottom:8px;font-family:inherit" placeholder="0"><div style="position:absolute;right:20px;top:50%;transform:translateY(-50%);background:var(--bg4);border:1px solid var(--border);border-radius:20px;padding:8px 16px;display:flex;align-items:center;gap:8px;font-size:18px;font-weight:600"><span>'+primaryCurMeta.flag+'</span><span>'+primaryCur+'</span></div></div>':'<div style="position:relative"><input type="number" class="form-input" value="'+Math.round(recv)+'" min="0" step="100" onchange="updateReceiveAmountInput(this.value)" style="font-size:40px;font-weight:700;text-align:center;padding:20px 120px 20px 20px;background:var(--bg3);border-radius:14px;margin-bottom:8px;font-family:inherit" placeholder="0"><div style="position:absolute;right:20px;top:50%;transform:translateY(-50%);background:var(--bg4);border:1px solid var(--border);border-radius:20px;padding:8px 16px;display:flex;align-items:center;gap:8px;font-size:18px;font-weight:600"><span>'+primaryCurMeta.flag+'</span><span>'+primaryCur+'</span></div></div>';
const currencyLabel='<div style="text-align:center;font-size:11px;color:var(--text2);margin-top:-4px;margin-bottom:16px">'+primaryCur+' ‚Ä¢ '+(CURRENCIES[primaryCur]?.name||'Currency')+'</div>';

const fromCurSelector='<div class="form-group"><label class="form-label">From Currency</label><select class="form-select" onchange="updateFromCurrency(this.value)"><option value="AED"'+(fromCur==='AED'?' selected':'')+ '>üá¶üá™ UAE Dirham (AED)</option><option value="USD"'+(fromCur==='USD'?' selected':'')+'>üá∫üá∏ US Dollar (USD)</option><option value="GBP"'+(fromCur==='GBP'?' selected':'')+'>üá¨üáß British Pound (GBP)</option><option value="EUR"'+(fromCur==='EUR'?' selected':'')+'>üá™üá∫ Euro (EUR)</option></select></div>';


const pricingHeader='<div style="cursor:pointer;display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--bg3);border-radius:8px;margin-top:12px" onclick="togglePricingBreakdown()"><span style="font-weight:600">üí∞ Total Fees: $'+fmt(pricing.totalFee,2)+' ('+fmt(pricing.effCostPct,2)+'%)</span><span>'+(pricingCollapsed?'‚ñº':'‚ñ≤')+'</span></div>';
const pricingDetails=pricingCollapsed?'':'<div class="glass-card" style="padding:12px;margin-top:4px"><div class="revenue-breakdown"><div class="revenue-row"><span class="label">LP Fee</span><span class="value">$'+fmt(pricing.lpFee,2)+'</span></div><div class="revenue-row"><span class="label">Anchor Fee</span><span class="value">$'+fmt(pricing.anchorFee,2)+'</span></div><div class="revenue-row"><span class="label">FlowBridge Margin</span><span class="value">$'+fmt(pricing.fbMargin,2)+'</span></div></div><div style="font-size:10px;color:var(--green);margin-top:8px">‚úì Still 5-10x cheaper than Western Union</div></div>';

const peerLPSection='<div class="glass-card" style="margin-top:12px;padding:12px"><div style="display:flex;align-items:center;justify-content:space-between"><div><div style="font-weight:600;font-size:12px">Peer Liquidity Provider</div><div style="font-size:10px;color:var(--text2)">Provide liquidity in your corridors</div></div><label style="cursor:pointer"><input type="checkbox" '+(u.canProvideLiquidity?'checked':'')+' onchange="toggleUserAsLP()" style="width:auto;cursor:pointer"></label></div>'+(u.canProvideLiquidity?'<div style="font-size:10px;color:var(--green);margin-top:6px">‚úì Active in: '+(u.lpCorridors||[]).join(', ')+'</div>':'')+'</div>';

// NEW: Show "Finding best match..." state if awaiting quotes
const buttonText=DEMO_TX&&DEMO_TX.status==='awaiting_lp_quotes'?'üîç Finding best match...':'üîé Find best match';
const buttonDisabled=overLimit||overDaily||(DEMO_TX&&DEMO_TX.status==='awaiting_lp_quotes');

return'<div class="card'+hl+'"><div class="card-header"><div class="card-title">üí∏ Send Money</div><span style="font-size:11px;color:var(--text2)">Sending as '+u.name+'</span></div><div class="send-form">'+modeToggle+fromCurSelector+'<div class="form-group"><label class="form-label">'+primaryLabel+'</label>'+unifiedAmountField+currencyLabel+'<input type="range" min="100" max="'+lim.perTx+'" step="50" value="'+amt+'" style="width:100%" onchange="updateSendAmount(this.value)">'+limitMsg+trustMsg+'</div><div class="form-group"><label class="form-label">To Country</label><select class="form-select" onchange="updateToCurrency(this.value)"><option value="NGN"'+(toCur==='NGN'?' selected':'')+'>üá≥üá¨ Nigeria (NGN)</option><option value="GHS"'+(toCur==='GHS'?' selected':'')+'>üá¨üá≠ Ghana (GHS)</option><option value="INR"'+(toCur==='INR'?' selected':'')+'>üáÆüá≥ India (INR)</option><option value="PHP"'+(toCur==='PHP'?' selected':'')+'>üáµüá≠ Philippines (PHP)</option><option value="KES"'+(toCur==='KES'?' selected':'')+'>üá∞üá™ Kenya (KES)</option><option value="ZWL"'+(toCur==='ZWL'?' selected':'')+'>üáøüáº Zimbabwe (ZWL)</option><option value="MXN"'+(toCur==='MXN'?' selected':'')+'>üá≤üáΩ Mexico (MXN)</option></select></div><div class="rate-info"><span>Exchange Rate</span><span class="rate-value">1 '+fromCur+' = '+fmt(rate,2)+' '+toCur+'</span></div><div class="receive-amount"><span class="receive-flag">'+(CURRENCIES[secondaryCur]?.flag||'üåç')+'</span><div><div class="receive-value">'+fmt(secondaryAmount,2)+'</div><div class="receive-currency">'+secondaryLabel+'</div></div></div>'+pricingHeader+pricingDetails+'<div class="competitor-compare"><div class="title">Rate Comparison</div><div class="competitor-row best"><span class="name">‚ö° FlowBridge</span><span class="rate">'+fmt(rate,2)+' '+toCur+'</span></div><div class="competitor-row"><span class="name">Wise</span><span class="rate">'+fmt(rate*0.988,2)+' '+toCur+'</span></div><div class="competitor-row"><span class="name">Western Union</span><span class="rate">'+fmt(rate*0.955,2)+' '+toCur+'</span></div><div class="competitor-row worst"><span class="name">Bank Wire</span><span class="rate">'+fmt(tradRate,2)+' '+toCur+'</span></div></div><div class="speed-compare"><div class="speed-item highlight"><div class="label">FlowBridge</div><div class="time">< 5 min</div></div><div class="speed-item"><div class="label">Traditional</div><div class="time">2-3 days</div></div></div>'+(savings>0?'<div class="savings-highlight"><div class="amount">+'+fmtCur(savings,toCur)+'</div><div class="label">You save vs bank wire</div></div>':'')+'<div class="form-group" style="margin-top:16px"><label class="form-label">Recipient</label>'+recipientHeader+recipientList+'</div><div class="form-group"><label class="form-label">Schedule</label><div class="grid-2"><label class="schedule-option'+((!DEMO_TX?.scheduled)?' active':'')+'"><input type="radio" name="schedule" checked onclick="setSchedule(false)"><span>üöÄ Send Now</span></label><label class="schedule-option'+((DEMO_TX?.scheduled)?' active':'')+'"><input type="radio" name="schedule" onclick="setSchedule(true)"><span>‚è∞ Schedule</span></label></div></div>'+scheduleInput+peerLPSection+'<button class="btn btn-primary btn-lg" style="width:100%"'+(buttonDisabled?' disabled':'')+' onclick="submitSend('+amt+',\''+fromCur+'\',\''+toCur+'\')">'+buttonText+'</button></div></div>';
}

function renderSwipeView(){
// FIX 1: Use getActiveTx() for consistency
const tx=getActiveTx();
if(!tx)return'<div class="card"><div class="empty-state"><div class="empty-icon">üí∏</div><div class="empty-title">No active transaction</div><div class="empty-text">Create a transfer to see LP quotes</div></div></div>';

// FEATURE: Use LP_QUOTES if available for active transaction, otherwise use default SWIPE
let filteredSwipe=SWIPE;
let usingLiveQuotes=false;

// Check if we have LP quotes for the current transaction
if(tx.id){
  const liveQuotes=LP_QUOTES.filter(q=>q.requestId&&LP_REQUESTS.find(r=>r.id===q.requestId&&r.txId===tx.id));
  if(liveQuotes.length>0){
    filteredSwipe=liveQuotes;
    usingLiveQuotes=true;
  }
}

// If no live quotes, filter by corridor from tx
if(!usingLiveQuotes&&tx.fromCur&&tx.toCur){
  const targetCorridor=tx.fromCur+'-'+tx.toCur;
  filteredSwipe=SWIPE.filter(card=>card.corridor===targetCorridor);
  if(filteredSwipe.length===0){
    // Fallback: show similar corridors (same toCur)
    filteredSwipe=SWIPE.filter(card=>card.to===tx.toCur);
  }
}

if(swipeIndex>=filteredSwipe.length)return'<div class="card"><div class="empty-state"><div class="empty-icon">‚ú®</div><div class="empty-title">All caught up!</div><div class="empty-text">'+(usingLiveQuotes?'No more quotes available for this transaction':(DEMO_TX&&DEMO_TX.fromCur&&DEMO_TX.toCur?'No more matches for '+DEMO_TX.fromCur+' ‚Üí '+DEMO_TX.toCur+' corridor':'Check back later for new matches'))+'</div><button class="btn btn-secondary" onclick="swipeIndex=0;render()">Reset Cards</button></div></div>';
const cards=filteredSwipe.slice(swipeIndex,swipeIndex+3).reverse();
const hl=guidedMode&&guidedStep===1&&!freeMode?' guided-highlight':'';
const corridorMsg=DEMO_TX&&DEMO_TX.fromCur&&DEMO_TX.toCur?' <span class="badge badge-info" style="margin-left:8px">'+DEMO_TX.fromCur+' ‚Üí '+DEMO_TX.toCur+'</span>':'';

// Get FlowBridge benchmark rate for comparison
const baseRate=DEMO_TX?getRate(DEMO_TX.fromCur,DEMO_TX.toCur):430;
const sendAmount=DEMO_TX?DEMO_TX.amount:500;

// Enhanced LP cards with rich metadata display
return'<div class="card'+hl+'"><div class="card-header"><div class="card-title">üîÑ FlowSwipe'+corridorMsg+'</div><span class="badge badge-info">'+filteredSwipe.length+' matches</span></div><div class="swipe-container" id="swipeContainer">'+cards.map((card,i)=>{
  const zIdx=cards.length-i,scale=1-i*0.03,yOff=i*8;
  
  // Compute LP-specific rate (from card data or calculate)
  const lpRate=card.lpRate||(baseRate*(1+(card.rateDeltaPct||0)/100));
  const receiveAmount=sendAmount*lpRate;
  
  // Calculate vs FlowBridge comparison
  const deltaPct=baseRate>0?((lpRate/baseRate-1)*100):0;
  const spreadColor=deltaPct>0?'var(--green)':deltaPct<0?'var(--red)':'var(--text2)';
  const spreadSign=deltaPct>=0?'+':'';
  
  // Reliability badge color
  const reliabilityPct=card.reliability||90;
  const reliabilityColor=reliabilityPct>=90?'var(--green)':reliabilityPct>=80?'var(--accent)':'var(--yellow)';
  
  // Badge hint display
  const badgeHtml=card.badgeHint?'<span class="badge badge-info" style="font-size:9px;margin-left:6px">'+card.badgeHint+'</span>':'';
  
  return'<div class="swipe-card" id="card-'+card.id+'" style="z-index:'+zIdx+';transform:scale('+scale+') translateY('+yOff+'px)" data-id="'+card.id+'"><div class="header"><div class="user-info"><div class="avatar" style="background:'+card.avatar+'">'+card.name.charAt(0)+'</div><div><div class="name">'+card.name+badgeHtml+'</div><div class="location">'+card.flag+' '+card.city+'</div></div></div><span class="badge badge-success">'+card.score+' score</span></div><div class="amount-section"><div style="font-size:12px;color:var(--text2);margin-bottom:8px">You send '+fmtCur(sendAmount,card.from||card.corridor.split('-')[0])+'</div><div class="amount" style="color:var(--green)">‚Üí '+fmtAmount(receiveAmount)+' '+(card.to||card.corridor.split('-')[1])+'</div><div style="font-size:11px;color:var(--text2);margin-top:8px;display:flex;align-items:center;justify-content:center;gap:4px"><span>'+card.from+' ‚Üí '+card.to+'</span><span style="color:'+spreadColor+';font-weight:600">'+spreadSign+fmt(deltaPct,2)+'% vs FlowBridge</span></div></div><div class="details"><div class="detail-item"><div class="detail-label">LP Rate</div><div class="detail-value" style="font-family:JetBrains Mono;font-size:12px;color:var(--green)">'+fmt(lpRate,3)+' '+(card.to||card.corridor.split('-')[1])+' / '+(card.from||card.corridor.split('-')[0])+'</div></div><div class="detail-item"><div class="detail-label">'+card.lpType+'</div><div class="detail-value" style="font-size:10px">'+card.proximity+'</div></div><div class="detail-item"><div class="detail-label">Reliability</div><div class="detail-value" style="color:'+reliabilityColor+'">'+reliabilityPct+'%</div></div><div class="detail-item"><div class="detail-label">Settlement</div><div class="detail-value">'+card.settlement+'</div></div></div><div style="margin-top:12px;padding:10px;background:var(--bg4);border-radius:8px;font-size:11px"><div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="color:var(--text2)">City:</span><span style="color:var(--text)">'+card.city+'</span></div><div style="display:flex;justify-content:space-between"><span style="color:var(--text2)">Type:</span><span style="color:var(--text)">'+card.lpType+'</span></div></div></div>'
}).join('')+'</div><div class="swipe-actions"><button class="swipe-btn pass" onclick="swipePass()">‚úï</button><button class="swipe-btn match" onclick="swipeMatch()">‚úì</button></div><div class="swipe-hint">‚Üê Swipe left to pass ‚Ä¢ Swipe right to match ‚Üí</div></div>';
}

function renderSenderHistory(){
const items=txHistory.filter(t=>!t.pattern);
if(!items.length&&!DEMO_TX)return'<div class="card"><div class="card-header"><div class="card-title">üìú Transaction History</div><button class="btn btn-sm btn-secondary" onclick="showToast(\'History exported\',\'success\')">üìä Export</button></div><div class="empty-state"><div class="empty-icon">üìã</div><div class="empty-title">No transactions yet</div><div class="empty-text">Your completed transfers will appear here</div></div></div>';
const all=DEMO_TX?[DEMO_TX,...items]:items;
return'<div class="card"><div class="card-header"><div class="card-title">üìú Transaction History</div><span class="badge badge-info">'+all.length+' transfers</span><button class="btn btn-sm btn-secondary" onclick="showToast(\'History exported\',\'success\')">üìä Export</button></div>'+all.map(tx=>'<div class="tx-row" onclick="showTxDetailModal({id:\''+tx.id+'\',amount:'+tx.amount+',fromCur:\''+tx.fromCur+'\',toCur:\''+(tx.toCur||'NGN')+'\',status:\''+(tx.status||'pending')+'\',timestamp:new Date(\''+tx.timestamp+'\')})"><div class="tx-icon" style="background:rgba(88,166,255,0.1)">'+(CURRENCIES[tx.toCur]?.flag||'üí∏')+'</div><div class="tx-info"><div class="tx-title">'+tx.id+' <span class="badge badge-'+(tx.status==='completed'?'success':'info')+'">'+tx.status+'</span>'+(tx.scheduled?' <span class="badge badge-scheduled">Scheduled</span>':'')+'</div><div class="tx-detail">'+(tx.fromCur||'AED')+' ‚Üí '+(tx.toCur||'NGN')+' ‚Ä¢ '+(tx.timestamp?.toLocaleString()||'Just now')+'</div></div><div class="tx-amount"><div class="tx-value">'+fmtCur(tx.amount||500,tx.fromCur||'AED')+'</div><div class="tx-status">‚Üí '+fmt((tx.amount||500)*getRate(tx.fromCur||'AED',tx.toCur||'NGN'),0)+' '+(tx.toCur||'NGN')+'</div></div></div>').join('')+'</div>';
}

function renderSenderProfile(){
const u=getActiveSender();
const lim=getLimit(u.tier);
return'<div class="card"><div class="card-header"><div class="card-title">üë§ Sender Profile</div><span class="kyc-status kyc-verified">‚úì KYC Verified</span></div><div class="profile-header"><div class="profile-avatar" style="background:'+u.color+'">'+u.avatar+'</div><div class="profile-info"><div class="profile-name">'+u.name+'</div><div class="profile-meta">'+u.id+' ‚Ä¢ '+u.email+' ‚Ä¢ Dubai, UAE</div><div class="profile-badges"><span class="badge badge-'+u.tier+'">'+u.tier.toUpperCase()+' Tier</span><span class="badge badge-info">FlowScore: '+u.score+'</span>'+(u.premium?'<span class="badge badge-premium">‚≠ê Premium</span>':'')+'</div></div><button class="btn btn-secondary btn-sm" onclick="showToast(\'KYC details viewed\',\'info\')">View KYC Details</button></div><div class="grid-2"><div class="glass-card"><div style="font-weight:600;margin-bottom:12px">Personal Information</div><div style="font-size:13px;line-height:1.8;color:var(--text2)"><div style="display:flex;justify-content:space-between;margin-bottom:6px"><span>Full Name:</span><span style="color:var(--text)">'+u.name+'</span></div><div style="display:flex;justify-content:space-between;margin-bottom:6px"><span>Email:</span><span style="color:var(--text)">'+u.email+'</span></div><div style="display:flex;justify-content:space-between;margin-bottom:6px"><span>Base Currency:</span><span style="color:var(--text)">'+u.baseCur+'</span></div><div style="display:flex;justify-content:space-between;margin-bottom:6px"><span>Tier:</span><span style="color:var(--text)">'+u.tier.toUpperCase()+'</span></div><div style="display:flex;justify-content:space-between"><span>Member Since:</span><span style="color:var(--text)">Jan 2024</span></div></div></div><div class="glass-card"><div style="font-weight:600;margin-bottom:12px">Account Status</div><div style="font-size:13px;line-height:1.8;color:var(--text2)"><div style="display:flex;justify-content:space-between;margin-bottom:6px"><span>FlowScore:</span><span style="color:var(--green)">'+u.score+'/100</span></div><div style="display:flex;justify-content:space-between;margin-bottom:6px"><span>Daily Limit:</span><span style="color:var(--text)">'+fmtCur(lim.daily,'USD')+'</span></div><div style="display:flex;justify-content:space-between;margin-bottom:6px"><span>Daily Used:</span><span style="color:var(--text)">'+fmtCur(u.dailyUsed,'USD')+'</span></div><div style="display:flex;justify-content:space-between;margin-bottom:6px"><span>Monthly Used:</span><span style="color:var(--text)">'+fmtCur(u.monthlyUsed||0,'USD')+'</span></div><div style="display:flex;justify-content:space-between"><span>Premium:</span><span style="color:'+(u.premium?'var(--green)':'var(--text2)')+'">'+(u.premium?'Active':'Inactive')+'</span></div></div></div></div><div style="margin-top:16px"><div style="font-weight:600;margin-bottom:12px;font-size:14px">üìÑ Verified Documents</div><div class="doc-item"><div class="doc-info"><div class="doc-icon">ü™™</div><div class="doc-details"><div class="doc-name">Emirates ID</div><div class="doc-meta">Verified on Dec 1, 2024 ‚Ä¢ Expires: Dec 2027</div></div></div><span class="badge badge-success">Verified</span></div><div class="doc-item"><div class="doc-info"><div class="doc-icon">üõÇ</div><div class="doc-details"><div class="doc-name">Passport</div><div class="doc-meta">Verified on Dec 1, 2024 ‚Ä¢ Expires: Aug 2029</div></div></div><span class="badge badge-success">Verified</span></div><div class="doc-item"><div class="doc-info"><div class="doc-icon">üè†</div><div class="doc-details"><div class="doc-name">Proof of Address</div><div class="doc-meta">Utility Bill ‚Ä¢ Verified on Dec 1, 2024</div></div></div><span class="badge badge-success">Verified</span></div><div class="doc-item"><div class="doc-info"><div class="doc-icon">ü§≥</div><div class="doc-details"><div class="doc-name">Selfie Verification</div><div class="doc-meta">Biometric match ‚Ä¢ Verified on Dec 1, 2024</div></div></div><span class="badge badge-success">Verified</span></div></div></div>';
}

function renderLPProfile(){
const lpProfile=LP_PROFILES[activeLPId];
return'<div class="card"><div class="card-header"><div class="card-title">üè¢ LP Profile</div><span class="kyc-status kyc-verified">‚úì Business Verified</span></div><div class="profile-header"><div class="profile-avatar" style="background:#3fb950">'+lpProfile.avatar+'</div><div class="profile-info"><div class="profile-name">'+lpProfile.name+'</div><div class="profile-meta">LP-'+lpProfile.region.toUpperCase()+'-001 ‚Ä¢ '+lpProfile.region+' Region</div><div class="profile-badges"><span class="badge badge-success">Liquidity Provider</span><span class="badge badge-info">$'+fmt(Object.values(lpProfile.positions).reduce((a,p)=>a+p.available+p.locked,0),0)+' Liquidity</span><span class="badge" style="background:var(--green);color:#fff">Active</span></div></div><button class="btn btn-secondary btn-sm" onclick="showToast(\'Business details viewed\',\'info\')">Business Details</button></div><div class="grid-2"><div class="glass-card"><div style="font-weight:600;margin-bottom:12px">Business Information</div><div style="font-size:13px;line-height:1.8;color:var(--text2)"><div style="display:flex;justify-content:space-between;margin-bottom:6px"><span>Entity Name:</span><span style="color:var(--text)">'+lpProfile.name+'</span></div><div style="display:flex;justify-content:space-between;margin-bottom:6px"><span>Region:</span><span style="color:var(--text)">'+lpProfile.region+'</span></div><div style="display:flex;justify-content:space-between;margin-bottom:6px"><span>Corridors:</span><span style="color:var(--text)">'+Object.keys(lpProfile.positions).length+'</span></div><div style="display:flex;justify-content:space-between;margin-bottom:6px"><span>Total Liquidity:</span><span style="color:var(--text)">$'+fmt(Object.values(lpProfile.positions).reduce((a,p)=>a+p.available+p.locked,0),0)+'</span></div><div style="display:flex;justify-content:space-between"><span>Partner Since:</span><span style="color:var(--text)">Apr 2022</span></div></div></div><div class="glass-card"><div style="font-weight:600;margin-bottom:12px">Compliance Status</div><div style="font-size:13px;line-height:1.8;color:var(--text2)"><div style="display:flex;justify-content:space-between;margin-bottom:6px"><span>AML Screening:</span><span class="badge badge-success">Passed</span></div><div style="display:flex;justify-content:space-between;margin-bottom:6px"><span>License Status:</span><span class="badge badge-success">Active</span></div><div style="display:flex;justify-content:space-between;margin-bottom:6px"><span>Last Audit:</span><span style="color:var(--text)">Nov 2024</span></div><div style="display:flex;justify-content:space-between;margin-bottom:6px"><span>Total Revenue:</span><span style="color:var(--green)">$'+fmt(lpProfile.revenue,0)+'</span></div><div style="display:flex;justify-content:space-between"><span>Active Since:</span><span style="color:var(--text)">Apr 2022</span></div></div></div></div><div style="margin-top:16px"><div style="font-weight:600;margin-bottom:12px;font-size:14px">üìã Business Documents</div><div class="doc-item"><div class="doc-info"><div class="doc-icon">üè¢</div><div class="doc-details"><div class="doc-name">Business Registration Certificate</div><div class="doc-meta">Verified on Apr 15, 2024 ‚Ä¢ Valid</div></div></div><span class="badge badge-success">Verified</span></div><div class="doc-item"><div class="doc-info"><div class="doc-icon">üìú</div><div class="doc-details"><div class="doc-name">Financial Services License</div><div class="doc-meta">Regulatory Authority ‚Ä¢ Verified on Apr 15, 2024</div></div></div><span class="badge badge-success">Verified</span></div><div class="doc-item"><div class="doc-info"><div class="doc-icon">üë•</div><div class="doc-details"><div class="doc-name">Director Identification</div><div class="doc-meta">Directors verified ‚Ä¢ Last updated Apr 2024</div></div></div><span class="badge badge-success">Verified</span></div><div class="doc-item"><div class="doc-info"><div class="doc-icon">üíº</div><div class="doc-details"><div class="doc-name">Proof of Funds</div><div class="doc-meta">Bank statements ‚Ä¢ Verified on Nov 2024</div></div></div><span class="badge badge-success">Verified</span></div></div></div>';
}

function renderAnchorProfile(){
const anchorProfile=ANCHOR_PROFILES[activeAnchorId];
return'<div class="card"><div class="card-header"><div class="card-title">üîê Anchor Profile</div><span class="kyc-status kyc-verified">‚úì Regulatory Approved</span></div><div class="profile-header"><div class="profile-avatar" style="background:#d29922">'+anchorProfile.avatar+'</div><div class="profile-info"><div class="profile-name">'+anchorProfile.name+'</div><div class="profile-meta">ANC-'+anchorProfile.country.substring(0,2).toUpperCase()+'-001 ‚Ä¢ '+anchorProfile.country+'</div><div class="profile-badges"><span class="badge badge-warning">Anchor Partner</span><span class="badge badge-info">'+anchorProfile.completed+' Completed</span><span class="badge" style="background:var(--green);color:#fff">Active</span></div></div></div><div class="grid-2"><div class="glass-card"><div style="font-weight:600;margin-bottom:12px">Partner Information</div><div style="font-size:13px;line-height:1.8;color:var(--text2)"><div style="display:flex;justify-content:space-between;margin-bottom:6px"><span>Legal Entity:</span><span style="color:var(--text)">'+anchorProfile.name+'</span></div><div style="display:flex;justify-content:space-between;margin-bottom:6px"><span>Country:</span><span style="color:var(--text)">'+anchorProfile.country+'</span></div><div style="display:flex;justify-content:space-between;margin-bottom:6px"><span>Currency:</span><span style="color:var(--text)">'+anchorProfile.currency+'</span></div><div style="display:flex;justify-content:space-between;margin-bottom:6px"><span>Coverage:</span><span style="color:var(--text)">Nationwide</span></div><div style="display:flex;justify-content:space-between"><span>Partner Since:</span><span style="color:var(--text)">May 2023</span></div></div></div><div class="glass-card"><div style="font-weight:600;margin-bottom:12px">Operational Metrics</div><div style="font-size:13px;line-height:1.8;color:var(--text2)"><div style="display:flex;justify-content:space-between;margin-bottom:6px"><span>Pending Payouts:</span><span style="color:var(--yellow)">'+anchorProfile.pending+'</span></div><div style="display:flex;justify-content:space-between;margin-bottom:6px"><span>Completed Today:</span><span style="color:var(--green)">'+anchorProfile.completed+'</span></div><div style="display:flex;justify-content:space-between;margin-bottom:6px"><span>Balance:</span><span style="color:var(--text)">'+CURRENCIES[anchorProfile.currency].symbol+fmt(anchorProfile.balance,0)+'</span></div><div style="display:flex;justify-content:space-between;margin-bottom:6px"><span>Commission Earned:</span><span style="color:var(--green)">$'+fmt(anchorProfile.commission,0)+'</span></div><div style="display:flex;justify-content:space-between"><span>Success Rate:</span><span style="color:var(--green)">99.8%</span></div></div></div></div><div style="margin-top:16px"><div style="font-weight:600;margin-bottom:12px;font-size:14px">üîê Compliance Documents</div><div class="doc-item"><div class="doc-info"><div class="doc-icon">üèõÔ∏è</div><div class="doc-details"><div class="doc-name">Central Bank License</div><div class="doc-meta">Central Bank ‚Ä¢ Valid until 2027</div></div></div><span class="badge badge-success">Active</span></div><div class="doc-item"><div class="doc-info"><div class="doc-icon">‚úÖ</div><div class="doc-details"><div class="doc-name">AML/CFT Certification</div><div class="doc-meta">Verified on Oct 2024 ‚Ä¢ Annual renewal</div></div></div><span class="badge badge-success">Current</span></div><div class="doc-item"><div class="doc-info"><div class="doc-icon">üìä</div><div class="doc-details"><div class="doc-name">Audit Report 2024</div><div class="doc-meta">Independent Auditor ‚Ä¢ Submitted Nov 2024</div></div></div><span class="badge badge-success">Approved</span></div></div></div>';
}

function renderReceiverProfile(){
const receiverProfile=RECEIVER_PROFILES[activeReceiverId];
return'<div class="card"><div class="card-header"><div class="card-title">üë§ Receiver Profile</div><span class="kyc-status kyc-verified">‚úì Identity Verified</span></div><div class="profile-header"><div class="profile-avatar" style="background:#a371f7">'+receiverProfile.avatar+'</div><div class="profile-info"><div class="profile-name">'+receiverProfile.name+'</div><div class="profile-meta">RCV-'+receiverProfile.country.substring(0,2).toUpperCase()+'-001 ‚Ä¢ '+receiverProfile.country+'</div><div class="profile-badges"><span class="badge badge-info">Receiver</span><span class="badge badge-success">'+receiverProfile.method+'</span></div></div></div><div class="grid-2"><div class="glass-card"><div style="font-weight:600;margin-bottom:12px">Personal Information</div><div style="font-size:13px;line-height:1.8;color:var(--text2)"><div style="display:flex;justify-content:space-between;margin-bottom:6px"><span>Full Name:</span><span style="color:var(--text)">'+receiverProfile.name+'</span></div><div style="display:flex;justify-content:space-between;margin-bottom:6px"><span>Country:</span><span style="color:var(--text)">'+receiverProfile.country+'</span></div><div style="display:flex;justify-content:space-between;margin-bottom:6px"><span>Currency:</span><span style="color:var(--text)">'+receiverProfile.currency+'</span></div><div style="display:flex;justify-content:space-between;margin-bottom:6px"><span>Payment Method:</span><span style="color:var(--text)">'+receiverProfile.method+'</span></div><div style="display:flex;justify-content:space-between"><span>Account Balance:</span><span style="color:var(--green)">'+CURRENCIES[receiverProfile.currency].symbol+fmt(receiverProfile.balance,0)+'</span></div></div></div><div class="glass-card"><div style="font-weight:600;margin-bottom:12px">Receiving History</div><div style="font-size:13px;line-height:1.8;color:var(--text2)"><div style="display:flex;justify-content:space-between;margin-bottom:6px"><span>Total Received:</span><span style="color:var(--green)">'+CURRENCIES[receiverProfile.currency].symbol+fmt(receiverProfile.balance,0)+'</span></div><div style="display:flex;justify-content:space-between;margin-bottom:6px"><span>Transactions:</span><span style="color:var(--text)">'+txHistory.filter(t=>t.status==='completed').length+'</span></div><div style="display:flex;justify-content:space-between;margin-bottom:6px"><span>Avg Amount:</span><span style="color:var(--text)">'+CURRENCIES[receiverProfile.currency].symbol+'500</span></div><div style="display:flex;justify-content:space-between;margin-bottom:6px"><span>Last Received:</span><span style="color:var(--text)">3 days ago</span></div><div style="display:flex;justify-content:space-between"><span>Status:</span><span class="badge badge-success">Active</span></div></div></div></div><div style="margin-top:16px"><div style="font-weight:600;margin-bottom:12px;font-size:14px">üìÑ Identity Documents</div><div class="doc-item"><div class="doc-info"><div class="doc-icon">ü™™</div><div class="doc-details"><div class="doc-name">National ID</div><div class="doc-meta">Verified on Sep 15, 2024</div></div></div><span class="badge badge-success">Verified</span></div><div class="doc-item"><div class="doc-info"><div class="doc-icon">üì±</div><div class="doc-details"><div class="doc-name">Mobile Number Verification</div><div class="doc-meta">Registered SIM ‚Ä¢ Verified Sep 2024</div></div></div><span class="badge badge-success">Verified</span></div><div class="doc-item"><div class="doc-info"><div class="doc-icon">üè¶</div><div class="doc-details"><div class="doc-name">'+receiverProfile.method+' Account</div><div class="doc-meta">'+receiverProfile.country+' ‚Ä¢ Active</div></div></div><span class="badge badge-success">Active</span></div></div></div>';
}

// ============ LP VIEWS ============
function renderLPDash(){
const lpProfile=LP_PROFILES[activeLPId];
const totalAvail=Object.values(lpProfile.positions).reduce((a,p)=>a+p.available,0),totalLocked=Object.values(lpProfile.positions).reduce((a,p)=>a+p.locked,0);
// FIX 2: Add LP profile switcher
const lpSelector='<div class="user-selector">'+Object.entries(LP_PROFILES).map(([k,lp])=>'<div class="user-pill'+(k===activeLPId?' active':'')+'" onclick="switchLP(\''+k+'\')"><span class="avatar">'+lp.avatar+'</span><span>'+lp.name+'</span></div>').join('')+'</div>';
return lpSelector+'<div class="grid-4"><div class="stat-card green"><div class="stat-icon">üí∞</div><div class="stat-value">$'+fmt(totalAvail+totalLocked,0)+'</div><div class="stat-label">Total Liquidity</div><div class="stat-change up">+12%</div></div><div class="stat-card"><div class="stat-icon">üîí</div><div class="stat-value">$'+fmt(totalLocked,0)+'</div><div class="stat-label">Currently Locked</div></div><div class="stat-card yellow"><div class="stat-icon">üìä</div><div class="stat-value">'+fmt(totalLocked/(totalAvail+totalLocked)*100,1)+'%</div><div class="stat-label">Utilization</div></div><div class="stat-card purple"><div class="stat-icon">‚≠ê</div><div class="stat-value">$'+fmt(lpProfile.revenue,0)+'</div><div class="stat-label">Revenue Earned</div></div></div><div class="card"><div class="card-header"><div class="card-title">üìã Active Positions</div><div style="display:flex;gap:8px"><button class="btn btn-sm btn-success" onclick="showAddLiquidityModal()">+ Add</button><button class="btn btn-sm btn-secondary" onclick="showWithdrawModal()">Withdraw</button></div></div>'+Object.entries(lpProfile.positions).slice(0,3).map(([pair,pos])=>'<div class="position-card" onclick="showToast(\''+pair.replace(/_/g,' ‚Üí ')+': '+Math.round(pos.util*100)+'% utilized\',\'info\')"><div class="position-header"><span class="position-pair">'+pair.replace(/_/g,' ‚Üí ')+'</span><span class="position-util">'+fmt(pos.util*100,0)+'% utilized</span></div><div class="position-bar"><div class="position-fill" style="width:'+pos.util*100+'%;background:linear-gradient(90deg,var(--accent),var(--green))"></div></div><div style="display:flex;justify-content:space-between;font-size:12px;color:var(--text2);margin-top:8px"><span>Available: $'+fmt(pos.available,0)+'</span><span>Locked: $'+fmt(pos.locked,0)+'</span></div></div>').join('')+'</div><div class="investor-highlight"><div class="title">üí° LP Opportunity</div><div class="value">$'+fmt(lpProfile.revenue,0)+' earned</div><div class="sub">Avg 1.2% yield per completed transaction ‚Ä¢ Low risk, high liquidity</div></div>';
}

function renderLPOrders(){
// NEW: Show incoming quote requests at the top
const lpProfile=LP_PROFILES[activeLPId];
let pendingRequests=LP_REQUESTS.filter(r=>r.status==='pending');
const quotedRequests=LP_REQUESTS.filter(r=>r.status==='quoted');
const showDemo=DEMO_TX&&['matched','pending'].includes(DEMO_TX.status);
const orders=[{id:'ORD-4521',corridor:'AED‚ÜíNGN',amount:2500,rate:431.5,score:85},{id:'ORD-4520',corridor:'USD‚ÜíINR',amount:1800,rate:83.2,score:78},{id:'ORD-4519',corridor:'AED‚ÜíPHP',amount:1200,rate:15.2,score:82},{id:'ORD-4518',corridor:'GBP‚ÜíZWL',amount:600,rate:461,score:74},{id:'ORD-4517',corridor:'AED‚ÜíGHS',amount:900,rate:4.21,score:80}];
const hl=guidedMode&&guidedStep===2&&!freeMode?' guided-highlight':'';

// Get unique corridors this LP can serve
const lpCorridors=['ALL',...new Set(lpProfile.supportedCorridors.map(c=>c.replace('_','-')))];

// Filter requests by corridor if not ALL
if(LP_CORRIDOR_FILTER!=='ALL'){
  pendingRequests=pendingRequests.filter(r=>r.corridor===LP_CORRIDOR_FILTER);
}

// Corridor filter dropdown
const corridorFilter='<div class="form-group" style="max-width:200px"><label class="form-label">Filter by Corridor</label><select class="form-select" onchange="LP_CORRIDOR_FILTER=this.value;render()">'+lpCorridors.map(c=>'<option value="'+c+'"'+(LP_CORRIDOR_FILTER===c?' selected':'')+'>'+c+'</option>').join('')+'</select></div>';

// NEW: Incoming quote requests section
const requestsSection=pendingRequests.length||LP_REQUESTS.filter(r=>r.status==='pending').length?'<div class="card" style="border-color:var(--purple);background:rgba(163,113,247,0.05)"><div class="card-header"><div class="card-title">üì• Incoming Quote Requests</div><span class="badge badge-new">'+pendingRequests.length+' '+(LP_CORRIDOR_FILTER!=='ALL'?'filtered':'new')+'</span></div>'+corridorFilter+(pendingRequests.length?pendingRequests.map(req=>'<div class="order-item new"><div class="order-corridor">'+(CURRENCIES[req.fromCur]?.flag||'üåç')+' ‚Üí '+(CURRENCIES[req.toCur]?.flag||'üåç')+'</div><div class="order-details"><div class="order-amount">'+fmtCur(req.amount,req.fromCur)+' ‚Ä¢ '+req.id+'</div><div class="order-rate">Base: '+fmt(req.baseRate,2)+' '+req.toCur+' <span class="badge badge-info" style="font-size:9px">'+req.corridor+'</span></div></div><div style="text-align:right;font-size:11px"><div style="color:var(--text2)">'+new Date(req.createdAt).toLocaleTimeString()+'</div></div><button class="btn btn-sm btn-primary" onclick="showQuoteSubmitModal(\''+req.id+'\','+req.amount+',\''+req.fromCur+'\',\''+req.toCur+'\','+req.baseRate+')">Submit Quote</button></div>').join(''):'<div style="padding:20px;text-align:center;color:var(--text2)">No requests for '+LP_CORRIDOR_FILTER+'</div>')+'</div>':'';

return requestsSection+'<div class="card'+hl+'"><div class="card-header"><div class="card-title">üìã Matched Orders</div><span class="badge badge-info">'+(showDemo?orders.length+1:orders.length)+' orders</span><button class="btn btn-sm btn-secondary" onclick="showToast(\'Order book exported\',\'success\')">üìä Export</button></div>'+(showDemo?'<div class="order-item highlight new"><div class="order-corridor">'+(CURRENCIES[DEMO_TX.fromCur]?.flag||'üåç')+' ‚Üí '+(CURRENCIES[DEMO_TX.toCur]?.flag||'üåç')+'</div><div class="order-details"><div class="order-amount">'+fmtCur(DEMO_TX.amount,DEMO_TX.fromCur)+' ‚Ä¢ '+DEMO_TX.id+'</div><div class="order-rate">Rate: '+fmt(getRate(DEMO_TX.fromCur,DEMO_TX.toCur),2)+' '+(DEMO_TX.premium?'<span class="badge badge-premium">Priority</span>':'')+' '+(DEMO_TX.scheduled?'<span class="badge badge-scheduled">Scheduled</span>':'')+'</div></div><div class="order-score"><div class="order-score-value">'+getActiveSender().score+'</div><div class="order-score-label">score</div></div><div style="display:flex;gap:6px"><button class="btn btn-sm btn-success" onclick="lpAcceptOrder()">Accept</button>'+(DEMO_TX.status!=='completed'?'<button class="btn btn-sm" style="background:var(--bg3);color:var(--yellow);border:1px solid var(--border)" onclick="event.stopPropagation();showIssueModal(\'lp\')">üö©</button>':'')+'</div></div>':'')+orders.map(o=>'<div class="order-item" onclick="showToast(\'Order '+o.id+': '+o.corridor+', $'+o.amount+'\',\'info\')"><div class="order-corridor">'+o.corridor.split('‚Üí').map(c=>CURRENCIES[c.trim()]?.flag||'üåç').join(' ‚Üí ')+'</div><div class="order-details"><div class="order-amount">$'+fmt(o.amount,0)+' ‚Ä¢ '+o.id+'</div><div class="order-rate">Rate: '+fmt(o.rate,2)+'</div></div><div class="order-score"><div class="order-score-value">'+o.score+'</div><div class="order-score-label">score</div></div><button class="btn btn-sm btn-secondary" onclick="event.stopPropagation();showToast(\'Accepted order '+o.id+'\',\'success\')">Accept</button></div>').join('')+'</div>';
}

function renderLPPositions(){
return'<div class="card"><div class="card-header"><div class="card-title">üí∞ Liquidity Positions</div><div style="display:flex;gap:8px"><button class="btn btn-sm btn-success" onclick="showAddLiquidityModal()">+ Add Liquidity</button><button class="btn btn-sm btn-secondary" onclick="showWithdrawModal()">Withdraw</button><button class="btn btn-sm btn-secondary" onclick="showToast(\'Positions exported\',\'success\')">üìä Export</button></div></div>'+Object.entries(LP_STATE).map(([pair,pos])=>'<div class="position-card" onclick="showToast(\''+pair.replace(/_/g,' ‚Üí ')+': $'+fmt(pos.available,0)+' available\',\'info\')"><div class="position-header"><span class="position-pair">'+pair.replace(/_/g,' ‚Üí ')+'</span><span class="position-util">'+fmt(pos.util*100,0)+'% utilized</span></div><div class="position-bar"><div class="position-fill" style="width:'+pos.util*100+'%;background:linear-gradient(90deg,var(--accent),var(--green))"></div></div><div style="display:flex;justify-content:space-between;font-size:12px;color:var(--text2);margin-top:8px"><span>Available: $'+fmt(pos.available,0)+'</span><span>Locked: $'+fmt(pos.locked,0)+'</span><span>Rate: '+fmt(pos.rate,2)+'</span></div></div>').join('')+'</div>';
}

function renderLPPricing(){
// FIX 1: Add corridor filter
const lpProfile=LP_PROFILES[activeLPId];
const lpCorridors=['ALL',...new Set(lpProfile.supportedCorridors.map(c=>c.replace('_','-')))];
const corridorFilter='<div class="form-group" style="max-width:200px"><label class="form-label">Filter by Corridor</label><select id="lpCorridorFilter" class="form-select form-select-sm" onchange="LP_CORRIDOR_FILTER=this.value;render()">'+lpCorridors.map(c=>'<option value="'+c+'"'+(LP_CORRIDOR_FILTER===c?' selected':'')+'>'+c+'</option>').join('')+'</select></div>';

// Filter corridors based on selection
let filteredCorridors=TOP_CORRIDORS;
if(LP_CORRIDOR_FILTER!=='ALL'){
  filteredCorridors=TOP_CORRIDORS.filter(c=>(c.from+'-'+c.to)===LP_CORRIDOR_FILTER);
}

return'<div class="card"><div class="card-header"><div class="card-title">üí≤ Corridor Pricing</div><button class="btn btn-sm btn-secondary" onclick="showToast(\'Pricing exported\',\'success\')">üìä Export</button></div>'+corridorFilter+'<div style="overflow-x:auto"><table style="width:100%;border-collapse:collapse"><thead><tr style="border-bottom:2px solid var(--border)"><th style="text-align:left;padding:12px;font-size:11px;color:var(--text2)">CORRIDOR</th><th style="text-align:center;padding:12px;font-size:11px;color:var(--text2)">TIER</th><th style="text-align:right;padding:12px;font-size:11px;color:var(--text2)">LP FEE</th><th style="text-align:right;padding:12px;font-size:11px;color:var(--text2)">ANCHOR FEE</th><th style="text-align:right;padding:12px;font-size:11px;color:var(--text2)">FB MARGIN</th><th style="text-align:right;padding:12px;font-size:11px;color:var(--text2)">TOTAL</th></tr></thead><tbody>'+(filteredCorridors.length?filteredCorridors.map(c=>{const p=corridorPricing[c.tier];return'<tr style="border-bottom:1px solid var(--border)"><td style="padding:12px"><div style="font-weight:600">'+c.from+' ‚Üí '+c.to+'</div><div style="font-size:11px;color:var(--text2)">'+c.name+'</div></td><td style="text-align:center;padding:12px"><span class="badge badge-'+(c.tier===1?'success':c.tier===2?'info':c.tier===3?'warning':'danger')+'">Tier '+c.tier+'</span></td><td style="text-align:right;padding:12px;color:var(--green)">$'+fmt(p.lp,2)+'</td><td style="text-align:right;padding:12px;color:var(--green)">$'+fmt(p.anchor,2)+'</td><td style="text-align:right;padding:12px;color:var(--accent)">$'+fmt(p.fb,2)+'</td><td style="text-align:right;padding:12px;font-weight:600">$'+fmt(p.lp+p.anchor+p.fb,2)+'</td></tr>'}).join(''):'<tr><td colspan="6" style="padding:20px;text-align:center;color:var(--text2)">No corridors match filter</td></tr>')+'</tbody></table></div></div><div class="investor-highlight"><div class="title">üí° LP Earning Potential</div><div class="value">$'+fmt(LP_PROFILES[activeLPId].revenue,0)+' earned</div><div class="sub">Earn '+fmt(corridorPricing[2].lp,2)+' per avg transaction ‚Ä¢ Scale with volume</div></div>';
}

// ============ ANCHOR VIEWS ============
function renderAnchorDash(){
const anchorProfile=ANCHOR_PROFILES[activeAnchorId];
// FIX 2: Add Anchor profile switcher
const anchorSelector='<div class="user-selector">'+Object.entries(ANCHOR_PROFILES).map(([k,anc])=>'<div class="user-pill'+(k===activeAnchorId?' active':'')+'" onclick="switchAnchor(\''+k+'\')"><span class="avatar">'+anc.avatar+'</span><span>'+anc.name+'</span></div>').join('')+'</div>';
return anchorSelector+'<div class="grid-4"><div class="stat-card yellow"><div class="stat-icon">‚è≥</div><div class="stat-value">'+anchorProfile.pending+'</div><div class="stat-label">Pending Payouts</div></div><div class="stat-card green"><div class="stat-icon">‚úÖ</div><div class="stat-value">'+anchorProfile.completed+'</div><div class="stat-label">Completed Today</div></div><div class="stat-card"><div class="stat-icon">üí∞</div><div class="stat-value">'+CURRENCIES[anchorProfile.currency].symbol+fmt(anchorProfile.balance,0)+'</div><div class="stat-label">'+anchorProfile.currency+' Balance</div></div><div class="stat-card purple"><div class="stat-icon">‚≠ê</div><div class="stat-value">$'+fmt(anchorProfile.commission,0)+'</div><div class="stat-label">Revenue Earned</div></div></div><div class="card"><div class="card-header"><div class="card-title">üìç Service Area</div><button class="btn btn-sm btn-secondary" onclick="showToast(\'Service area details\',\'info\')">View Details</button></div><div class="glass-card"><div style="display:flex;align-items:center;gap:12px"><span style="font-size:32px">'+anchorProfile.avatar+'</span><div><div style="font-weight:600">'+anchorProfile.country+' - '+anchorProfile.name+'</div><div style="font-size:12px;color:var(--text2)">Mobile Money ‚Ä¢ Bank Transfer ‚Ä¢ Cash Pickup</div></div></div></div></div><div class="investor-highlight"><div class="title">üí° Anchor Economics</div><div class="value">$'+fmt(anchorProfile.commission,0)+' earned</div><div class="sub">0.4% fee per payout ‚Ä¢ $'+fmt(anchorProfile.commission,0)+' commission today ‚Ä¢ Low overhead, high volume</div></div>';
}

function renderAnchorPayouts(){
const showDemo=DEMO_TX&&DEMO_TX.status==='lp_funded';
const payouts=[{id:'PAY-891',amount:8500,cur:'GHS',method:'Mobile Money',recipient:'Kwame A.',status:'ready'},{id:'PAY-890',amount:12300,cur:'GHS',method:'Bank Transfer',recipient:'Ama K.',status:'pending'}];
const hl=guidedMode&&guidedStep===3&&!freeMode?' guided-highlight':'';
return'<div class="card'+hl+'"><div class="card-header"><div class="card-title">üí≥ Pending Payouts</div><span class="badge badge-warning">'+(showDemo?payouts.length+1:payouts.length)+' pending</span><button class="btn btn-sm btn-secondary" onclick="showToast(\'Payouts exported\',\'success\')">üìä Export</button></div>'+(showDemo?'<div class="payout-card ready"><div class="payout-header"><span class="payout-amount">‚Çµ'+fmt((DEMO_TX.amount||500)*getRate(DEMO_TX.fromCur||'AED',DEMO_TX.toCur||'GHS'),0)+'</span><span class="badge badge-success">Ready</span>'+(DEMO_TX.scheduled?'<span class="badge badge-scheduled">Scheduled</span>':'')+'</div><div class="payout-details"><div><span class="payout-label">TX ID: </span>'+DEMO_TX.id+'</div><div><span class="payout-label">Recipient: </span>'+(DEMO_TX.recipient?.name||'Kofi Mensah')+'</div><div><span class="payout-label">Method: </span>'+(DEMO_TX.recipient?.method||'Mobile Money')+'</div><div><span class="payout-label">LP: </span>Apex Liquidity</div></div><button class="btn btn-success" style="width:100%;margin-top:12px" onclick="anchorProcessPayout()">Process Payout</button></div>':'')+payouts.map(p=>'<div class="payout-card '+(p.status==='ready'?'ready':'pending')+'" onclick="showPayoutDetailModal({id:\''+p.id+'\',amount:'+p.amount+',recipient:\''+p.recipient+'\',status:\''+p.status+'\'})"><div class="payout-header"><span class="payout-amount">‚Çµ'+fmt(p.amount,0)+'</span><span class="badge badge-'+(p.status==='ready'?'success':'warning')+'">'+p.status+'</span></div><div class="payout-details"><div><span class="payout-label">ID: </span>'+p.id+'</div><div><span class="payout-label">To: </span>'+p.recipient+'</div><div><span class="payout-label">Method: </span>'+p.method+'</div></div><button class="btn btn-sm btn-'+(p.status==='ready'?'success':'secondary')+'" style="width:100%;margin-top:12px" onclick="event.stopPropagation();showToast(\'Processing '+p.id+'\',\'info\')">'+(p.status==='ready'?'Process':'Pending LP')+'</button></div>').join('')+'</div>';
}

function renderAnchorHistory(){
const history=[{id:'PAY-889',amount:15200,recipient:'Yaw B.',status:'completed',time:'10:45 AM'},{id:'PAY-888',amount:8900,recipient:'Akua M.',status:'completed',time:'10:32 AM'},{id:'PAY-DELAY',amount:22000,recipient:'Manual Review',status:'delayed',time:'09:15 AM'},{id:'PAY-887',amount:11500,recipient:'Kofi D.',status:'completed',time:'09:28 AM'}];
return'<div class="card"><div class="card-header"><div class="card-title">üìú Payout History</div><span class="badge badge-info">'+history.length+' today</span><button class="btn btn-sm btn-secondary" onclick="showToast(\'History exported\',\'success\')">üìä Export</button></div>'+history.map(h=>'<div class="tx-row'+(h.status==='delayed'?' suspicious':'')+'" onclick="showPayoutDetailModal({id:\''+h.id+'\',amount:'+h.amount+',recipient:\''+h.recipient+'\',status:\''+h.status+'\'})"><div class="tx-icon" style="background:'+(h.status==='completed'?'rgba(63,185,80,0.1)':h.status==='delayed'?'rgba(210,153,34,0.1)':'rgba(88,166,255,0.1)')+'">üá¨üá≠</div><div class="tx-info"><div class="tx-title">'+h.id+' <span class="badge badge-'+(h.status==='completed'?'success':h.status==='delayed'?'warning':'info')+'">'+h.status+'</span></div><div class="tx-detail">To: '+h.recipient+' ‚Ä¢ '+h.time+'</div></div><div class="tx-amount"><div class="tx-value">‚Çµ'+fmt(h.amount,0)+'</div></div></div>').join('')+'</div>';
}

function renderAnchorPricing(){
const anchorProfile=ANCHOR_PROFILES[activeAnchorId];
const supportedCorridors=TOP_CORRIDORS.filter(c=>anchorProfile.supportedCorridors.includes(c.from+'_'+c.to));
return'<div class="card"><div class="card-header"><div class="card-title">üí≤ Corridor Pricing</div><button class="btn btn-sm btn-secondary" onclick="showToast(\'Pricing exported\',\'success\')">üìä Export</button></div><div style="overflow-x:auto"><table style="width:100%;border-collapse:collapse"><thead><tr style="border-bottom:2px solid var(--border)"><th style="text-align:left;padding:12px;font-size:11px;color:var(--text2)">CORRIDOR</th><th style="text-align:center;padding:12px;font-size:11px;color:var(--text2)">TIER</th><th style="text-align:right;padding:12px;font-size:11px;color:var(--text2)">LP FEE</th><th style="text-align:right;padding:12px;font-size:11px;color:var(--text2)">ANCHOR FEE</th><th style="text-align:right;padding:12px;font-size:11px;color:var(--text2)">FB MARGIN</th><th style="text-align:right;padding:12px;font-size:11px;color:var(--text2)">TOTAL</th></tr></thead><tbody>'+supportedCorridors.map(c=>{const p=corridorPricing[c.tier];return'<tr style="border-bottom:1px solid var(--border)"><td style="padding:12px"><div style="font-weight:600">'+c.from+' ‚Üí '+c.to+'</div><div style="font-size:11px;color:var(--text2)">'+c.name+'</div></td><td style="text-align:center;padding:12px"><span class="badge badge-'+(c.tier===1?'success':c.tier===2?'info':c.tier===3?'warning':'danger')+'">Tier '+c.tier+'</span></td><td style="text-align:right;padding:12px;color:var(--text2)">$'+fmt(p.lp,2)+'</td><td style="text-align:right;padding:12px;color:var(--green)">$'+fmt(p.anchor,2)+'</td><td style="text-align:right;padding:12px;color:var(--accent)">$'+fmt(p.fb,2)+'</td><td style="text-align:right;padding:12px;font-weight:600">$'+fmt(p.lp+p.anchor+p.fb,2)+'</td></tr>'}).join('')+'</tbody></table></div></div><div class="investor-highlight"><div class="title">üí° Anchor Commission Model</div><div class="value">$'+fmt(anchorProfile.commission,0)+' earned</div><div class="sub">Earn $'+fmt(corridorPricing[2].anchor,2)+' per avg payout ‚Ä¢ High volume, low overhead</div></div>';
}

// ============ RECEIVER VIEWS ============
function renderReceiverDash(){
const showIncoming=DEMO_TX&&['lp_funded','payout_processing','completed'].includes(DEMO_TX.status);
const status=DEMO_TX?.status;
const hl=guidedMode&&guidedStep===4&&!freeMode?' guided-highlight':'';

// BUG FIX 3: Add receiver profile switcher
const receiverProfile=RECEIVER_PROFILES[activeReceiverId]||RECEIVER_PROFILES.ghana;
const receiverSelector='<div class="user-selector">'+Object.entries(RECEIVER_PROFILES).map(([k,rec])=>'<div class="user-pill'+(k===activeReceiverId?' active':'')+'" onclick="switchReceiver(\''+k+'\')"><span class="avatar">'+rec.avatar+'</span><span>'+rec.name+'</span><span style="font-size:9px;color:var(--text2)"> ('+rec.country+')</span></div>').join('')+'</div>';

// FEATURE: Display payout code if available
const payoutCodeSection=DEMO_TX&&DEMO_TX.payoutCode&&['lp_funded','payout_processing'].includes(status)?'<div class="glass-card" style="margin-top:16px;padding:16px;background:linear-gradient(135deg,rgba(88,166,255,0.1),rgba(63,185,80,0.05))"><div style="font-weight:600;margin-bottom:8px;font-size:14px">üîê Payout Code</div><div style="font-size:32px;font-weight:700;font-family:JetBrains Mono;color:var(--accent);letter-spacing:8px;margin:12px 0">'+DEMO_TX.payoutCode+'</div><div style="font-size:11px;color:var(--text2)">Present this code to the Anchor to receive your funds</div></div>':'';

return receiverSelector+'<div class="card'+hl+'"><div class="card-header"><div class="card-title">üì• Incoming Funds</div></div>'+(showIncoming?'<div class="glass-card" style="text-align:center;padding:24px"><div style="font-size:48px;margin-bottom:16px">'+(status==='completed'?'‚úÖ':'‚è≥')+'</div><div style="font-size:28px;font-weight:700;margin-bottom:8px">'+fmt((DEMO_TX.amount||500)*getRate(DEMO_TX.fromCur||'AED',DEMO_TX.toCur||'GHS'),0)+' '+(DEMO_TX.toCur||'GHS')+'</div><div style="color:var(--text2);margin-bottom:16px">From: '+getActiveSender().name+'</div>'+(status==='completed'?'<div class="badge badge-success" style="font-size:14px;padding:8px 16px">‚úì Funds Received at '+DEMO_TX.completedTime?.toLocaleTimeString()+'</div>':status==='payout_processing'?'<div style="color:var(--yellow)">‚è≥ Your payout is being processed by '+receiverProfile.method+'...</div>':'<div style="color:var(--accent)">üí∞ Payment confirmed, awaiting payout...</div>')+payoutCodeSection+'<div class="timeline" style="text-align:left;margin-top:24px"><div class="timeline-item"><div class="timeline-dot complete">‚úì</div><div class="timeline-content"><div class="timeline-title">Payment Initiated</div></div></div><div class="timeline-item"><div class="timeline-dot '+(status!=='lp_funded'?'complete':'active')+'">‚úì</div><div class="timeline-content"><div class="timeline-title">Payout Processing</div></div></div><div class="timeline-item"><div class="timeline-dot '+(status==='completed'?'complete':'pending')+'">'+(status==='completed'?'‚úì':'3')+'</div><div class="timeline-content"><div class="timeline-title">Funds Available</div></div></div></div></div>':'<div class="empty-state"><div class="empty-icon">üì≠</div><div class="empty-title">No incoming transfers</div><div class="empty-text">You\'ll be notified when someone sends you money</div></div>')+'</div><div class="card"><div class="card-header"><div class="card-title">üí≥ Account Balance</div></div><div class="glass-card" style="padding:20px;text-align:center"><div style="font-size:32px;font-weight:700;color:var(--green);margin-bottom:8px">'+CURRENCIES[receiverProfile.currency].symbol+fmt(receiverProfile.balance,0)+'</div><div style="font-size:12px;color:var(--text2)">'+receiverProfile.method+' ‚Ä¢ '+receiverProfile.country+'</div></div></div>';
}

function renderReceiverHistory(){
const hist=txHistory.filter(t=>t.status==='completed'&&!t.pattern).slice(0,5);
if(!hist.length)return'<div class="card"><div class="card-header"><div class="card-title">üìú Received History</div></div><div class="empty-state"><div class="empty-icon">üìã</div><div class="empty-title">No history yet</div></div></div>';
return'<div class="card"><div class="card-header"><div class="card-title">üìú Received History</div><button class="btn btn-sm btn-secondary" onclick="showToast(\'History exported\',\'success\')">üìä Export</button></div>'+hist.map(tx=>'<div class="tx-row" onclick="showTxDetailModal({id:\''+tx.id+'\',amount:'+tx.amount+',fromCur:\''+tx.fromCur+'\',toCur:\''+(tx.toCur||'NGN')+'\',status:\'completed\'})"><div class="tx-icon" style="background:rgba(63,185,80,0.1)">üí∞</div><div class="tx-info"><div class="tx-title">'+tx.id+' <span class="badge badge-success">received</span></div><div class="tx-detail">From: '+getActiveSender().name+' ‚Ä¢ '+tx.completedTime?.toLocaleString()+'</div></div><div class="tx-amount"><div class="tx-value" style="color:var(--green)">+'+fmt(tx.amount*getRate(tx.fromCur,tx.toCur),0)+' '+tx.toCur+'</div></div></div>').join('')+'</div>';
}

// ============ ADMIN VIEWS ============
function renderAdminDash(){
const hl=guidedMode&&guidedStep===5&&!freeMode?' guided-highlight':'';
// FIX 4: Add Scheduled Transactions section
const scheduledTxs=[DEMO_TX,...txHistory].filter(t=>t&&t.scheduled&&t.status==='pending');
const scheduledSection=scheduledTxs.length?'<div class="card"><div class="card-header"><div class="card-title">‚è∞ Scheduled Transactions</div><span class="badge badge-scheduled">'+scheduledTxs.length+' scheduled</span></div>'+scheduledTxs.slice(0,3).map(tx=>'<div class="tx-row" onclick="showTxDetailModal({id:\''+tx.id+'\',amount:'+tx.amount+',fromCur:\''+tx.fromCur+'\',toCur:\''+(tx.toCur||'NGN')+'\',status:\''+tx.status+'\'})"><div class="tx-icon" style="background:rgba(88,166,255,0.1)">‚è∞</div><div class="tx-info"><div class="tx-title">'+tx.id+' <span class="badge badge-scheduled">Scheduled</span>'+(tx.premium?' <span class="badge badge-premium">Premium</span>':'')+'</div><div class="tx-detail">Execute: '+(tx.scheduledTime?new Date(tx.scheduledTime).toLocaleString():'Soon')+' ‚Ä¢ '+tx.fromCur+' ‚Üí '+tx.toCur+'</div></div><div class="tx-amount"><div class="tx-value">'+fmtCur(tx.amount||500,tx.fromCur||'AED')+'</div></div></div>').join('')+'</div>':'';
return'<div class="grid-4"><div class="stat-card green"><div class="stat-icon">üí∞</div><div class="stat-value">$'+fmt(BUSINESS_METRICS.totalVolume,0)+'</div><div class="stat-label">Total Volume</div><div class="stat-change up">+18%</div></div><div class="stat-card"><div class="stat-icon">üìä</div><div class="stat-value">'+fmt(BUSINESS_METRICS.txCount,0)+'</div><div class="stat-label">Transactions</div></div><div class="stat-card yellow"><div class="stat-icon">‚ö°</div><div class="stat-value">$'+fmt(BUSINESS_METRICS.avgTxSize,0)+'</div><div class="stat-label">Avg TX Size</div></div><div class="stat-card purple"><div class="stat-icon">üíµ</div><div class="stat-value">$'+fmt(BUSINESS_METRICS.revenueTotal,0)+'</div><div class="stat-label">Total Revenue</div></div></div>'+scheduledSection+'<div class="grid-2"><div class="card'+hl+'"><div class="card-header"><div class="card-title">üåç Top Corridors</div><button class="btn btn-sm btn-secondary" onclick="setView(\'corridors\')">View All</button></div>'+TOP_CORRIDORS.slice(0,4).map((c,i)=>'<div class="tx-row" onclick="showCorridorDetailModal('+i+')"><div class="tx-icon" style="background:rgba(88,166,255,0.1)">'+CURRENCIES[c.from].flag+'</div><div class="tx-info"><div class="tx-title">'+c.name+'</div><div class="tx-detail">'+c.from+' ‚Üí '+c.to+'</div></div><div class="tx-amount"><div class="tx-value">'+c.vol+'</div><div class="tx-status" style="color:var(--green)">'+fmt(getRate(c.from,c.to),2)+'</div></div></div>').join('')+'</div><div class="card"><div class="card-header"><div class="card-title">üìà Revenue Breakdown</div></div><div class="revenue-breakdown"><div class="revenue-row"><span class="label">FX Spread</span><span class="value">$'+fmt(BUSINESS_METRICS.revenueFX,0)+'</span></div><div class="revenue-row"><span class="label">Premium Fees</span><span class="value">$'+fmt(BUSINESS_METRICS.revenuePremium,0)+'</span></div><div class="revenue-row"><span class="label">LP Revenue Share</span><span class="value">$'+fmt(BUSINESS_METRICS.revenueLP,0)+'</span></div><div class="revenue-row"><span class="label">Anchor Revenue Share</span><span class="value">$'+fmt(BUSINESS_METRICS.revenueAnchor,0)+'</span></div></div><div class="investor-highlight"><div class="title">üí° Unit Economics</div><div class="value">1.5% take rate</div><div class="sub">$23 revenue per transaction avg ‚Ä¢ 67% gross margin</div></div></div></div>'+(DEMO_TX&&!DEMO_TX.scheduled?'<div class="card"><div class="card-header"><div class="card-title">üî¥ Live Transaction</div><span class="badge badge-new">'+DEMO_TX.status.replace(/_/g,' ')+'</span><button class="btn btn-sm btn-secondary" onclick="showSettlementTraceModal()">üîç Trace</button></div><div class="tx-row highlight" onclick="showTxDetailModal(DEMO_TX)"><div class="tx-icon" style="background:rgba(163,113,247,0.1)">'+(CURRENCIES[DEMO_TX.toCur]?.flag||'üí∏')+'</div><div class="tx-info"><div class="tx-title">'+DEMO_TX.id+' <span class="badge badge-info">'+DEMO_TX.status.replace(/_/g,' ')+'</span>'+(DEMO_TX.premium?' <span class="badge badge-premium">Premium</span>':'')+'</div><div class="tx-detail">'+(DEMO_TX.fromCur||'AED')+' ‚Üí '+(DEMO_TX.toCur||'NGN')+' ‚Ä¢ '+getActiveSender().name+' ‚Üí '+(DEMO_TX.recipient?.name||'Recipient')+'</div></div><div class="tx-amount"><div class="tx-value">'+fmtCur(DEMO_TX.amount||500,DEMO_TX.fromCur||'AED')+'</div><div class="tx-status">‚Üí '+fmt((DEMO_TX.amount||500)*getRate(DEMO_TX.fromCur||'AED',DEMO_TX.toCur||'NGN'),0)+' '+(DEMO_TX.toCur||'NGN')+'</div></div></div></div>':'');
}

function renderAdminTx(){
const flagged=txHistory.filter(t=>t.pattern==='bilateral');
const all=DEMO_TX?[DEMO_TX,...txHistory]:txHistory;
return'<div class="card"><div class="card-header"><div class="card-title">üìã All Transactions</div><span class="badge badge-info">'+(all.length||0)+' total</span>'+(flagged.length?'<span class="badge badge-danger" style="margin-left:8px">'+flagged.length+' flagged</span>':'')+'<button class="btn btn-sm btn-secondary" onclick="showToast(\'Transactions exported\',\'success\')">üìä Export</button></div>'+(all.length?all.map(tx=>'<div class="tx-row'+(tx.pattern==='bilateral'?' suspicious':'')+'" onclick="'+(tx.pattern==='bilateral'?'showFraudReviewModal({id:\''+tx.id+'\'})':'showTxDetailModal({id:\''+tx.id+'\',amount:'+(tx.amount||500)+',fromCur:\''+(tx.fromCur||'AED')+'\',toCur:\''+(tx.toCur||'NGN')+'\',status:\''+(tx.status||'pending')+'\'})') +'"><div class="tx-icon" style="background:'+(tx.pattern==='bilateral'?'rgba(248,81,73,0.1)':'rgba(88,166,255,0.1)')+'">'+(tx.pattern==='bilateral'?'‚ö†Ô∏è':(CURRENCIES[tx.toCur]?.flag||'üí∏'))+'</div><div class="tx-info"><div class="tx-title">'+tx.id+' <span class="badge badge-'+(tx.status==='completed'?'success':tx.status==='flagged'?'danger':'info')+'">'+(tx.status||'pending')+'</span>'+(tx.premium?' <span class="badge badge-premium">Premium</span>':'')+(tx.scheduled?' <span class="badge badge-scheduled">Scheduled</span>':'')+(tx.pattern==='bilateral'?' <span class="badge badge-collusion">Pattern Detected</span>':'')+'</div><div class="tx-detail">'+(tx.fromCur||tx.corridor||'AED‚ÜíNGN')+' ‚Ä¢ '+(tx.timestamp?.toLocaleString()||'Just now')+'</div></div><div class="tx-amount"><div class="tx-value">'+fmtCur(tx.amount||500,tx.fromCur||tx.cur||'AED')+'</div>'+(tx.pattern==='bilateral'?'<button class="btn btn-sm btn-danger" onclick="event.stopPropagation();showFraudReviewModal({id:\''+tx.id+'\'})">Review</button>':'')+'</div></div>').join(''):'<div class="empty-state"><div class="empty-icon">üìã</div><div class="empty-title">No transactions yet</div></div>')+'</div>';
}

function renderAdminIssues(){
  const openIssues  = ISSUES.filter(i => i.status === 'open');
  const closedIssues = ISSUES.filter(i => i.status !== 'open');

  const badgeClass = openIssues.length ? 'badge-danger' : 'badge-success';
  const badgeLabel = openIssues.length
    ? `${openIssues.length} open`
    : 'All clear';

  // If there are no issues at all, show a simple "all clear" card
  if (!ISSUES.length) {
    return `
      <div class="card">
        <div class="card-header">
          <div class="card-title">‚ûï Issues & Escalations</div>
          <span class="badge ${badgeClass}">${badgeLabel}</span>
        </div>
        <div class="card-body text-muted">
          No issues raised yet. All transactions are running smoothly.
        </div>
      </div>
    `;
  }

  const renderIssueRow = issue => {
    const created = issue.createdAt
      ? new Date(issue.createdAt).toLocaleString()
      : '';
    const statusClass =
      issue.status === 'open'
        ? 'badge-danger'
        : issue.status === 'under_review'
        ? 'badge-warning'
        : 'badge-success';

    return `
      <div class="flex items-center justify-between mb-2">
        <div>
          <div class="font-semibold text-sm">
            ${issue.reason || 'Issue'} ¬∑ ${issue.txId || ''}
          </div>
          <div class="text-xs text-muted">
            ${issue.raisedByRole || ''}${created ? ' ‚Ä¢ ' + created : ''}
          </div>
          ${issue.detail ? `<div class="text-xs mt-1">${issue.detail}</div>` : ''}
        </div>
        <div class="text-xs">
          <span class="badge ${statusClass}">${issue.status}</span>
        </div>
      </div>
    `;
  };

  const openBlock = openIssues.length
    ? `
      <h4 class="text-xs uppercase text-muted mb-1">Open</h4>
      ${openIssues.map(renderIssueRow).join('')}
    `
    : '';

  const closedBlock = closedIssues.length
    ? `
      <h4 class="text-xs uppercase text-muted mt-3 mb-1">Closed</h4>
      ${closedIssues.map(renderIssueRow).join('')}
    `
    : '';

  return `
    <div class="card">
      <div class="card-header">
        <div class="card-title">‚ûï Issues & Escalations</div>
        <span class="badge ${badgeClass}">${badgeLabel}</span>
      </div>
      <div class="card-body">
        ${openBlock}
        ${closedBlock}
      </div>
    </div>
  `;
}

function renderAdminRevenue(){
// Get filtered revenue data based on date range
const{breakdown,totalRevenue}=computeRevenueBreakdown();
const{from,to,mode}=getAdminRevenueDateRange();

// Date filter dropdown with CUSTOM option
const dateFilter='<div class="form-group" style="max-width:200px"><label class="form-label">Time Period</label><select class="form-select" onchange="ADMIN_REVENUE_RANGE=this.value;render()"><option value="LAST_7"'+(mode==='LAST_7'?' selected':'')+'>Last 7 Days</option><option value="LAST_30"'+(mode==='LAST_30'?' selected':'')+'>Last 30 Days</option><option value="LAST_90"'+(mode==='LAST_90'?' selected':'')+'>Last 90 Days</option><option value="MTD"'+(mode==='MTD'?' selected':'')+'>Month to Date</option><option value="YTD"'+(mode==='YTD'?' selected':'')+'>Year to Date</option><option value="ALL"'+(mode==='ALL'?' selected':'')+'>All Time</option><option value="CUSTOM"'+(mode==='CUSTOM'?' selected':'')+'>üìÖ Custom Range</option></select></div>';

// Custom date range inputs (shown only when CUSTOM is selected)
const customDateInputs=mode==='CUSTOM'?'<div class="grid-2" style="margin-top:12px"><div class="form-group" style="margin-bottom:0"><label class="form-label">From Date</label><input type="date" class="form-input" value="'+(ADMIN_REVENUE_CUSTOM_FROM||'')+'" onchange="setCustomRevenueDate(\'from\',this.value)"></div><div class="form-group" style="margin-bottom:0"><label class="form-label">To Date</label><input type="date" class="form-input" value="'+(ADMIN_REVENUE_CUSTOM_TO||'')+'" onchange="setCustomRevenueDate(\'to\',this.value)"></div></div>':'';

// Date range display
const dateDisplay=from?'<div style="font-size:11px;color:var(--text2);margin-top:8px">'+from.toLocaleDateString()+' - '+to.toLocaleDateString()+'</div>':'<div style="font-size:11px;color:var(--text2);margin-top:8px">All time data</div>';

// Calculate partner revenue shares
const totalPartnerRevenue=breakdown.lpSubscriptions+breakdown.anchorSubscriptions;
const lpSharePct=totalPartnerRevenue>0?(breakdown.lpSubscriptions/totalPartnerRevenue*100):50;
const anchorSharePct=totalPartnerRevenue>0?(breakdown.anchorSubscriptions/totalPartnerRevenue*100):50;

// Partner revenue split visualization
const partnerSplitCard='<div class="card"><div class="card-header"><div class="card-title">ü§ù Partner Revenue Split</div></div><div class="glass-card" style="margin-bottom:12px"><div style="font-weight:600;margin-bottom:12px;font-size:14px">Total Partner Revenue: $'+fmt(totalPartnerRevenue,2)+'</div><div style="margin-bottom:16px"><div style="display:flex;justify-content:space-between;margin-bottom:6px"><span style="font-size:12px">üè¶ LP Subscriptions</span><span style="font-size:12px;font-weight:600;color:var(--accent)">'+fmt(lpSharePct,1)+'%</span></div><div style="height:24px;background:var(--bg4);border-radius:8px;overflow:hidden"><div style="height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));width:'+lpSharePct+'%;transition:width 0.5s"></div></div><div style="font-size:11px;color:var(--text2);margin-top:4px;text-align:right">$'+fmt(breakdown.lpSubscriptions,2)+'</div></div><div><div style="display:flex;justify-content:space-between;margin-bottom:6px"><span style="font-size:12px">üè™ Anchor Subscriptions</span><span style="font-size:12px;font-weight:600;color:var(--yellow)">'+fmt(anchorSharePct,1)+'%</span></div><div style="height:24px;background:var(--bg4);border-radius:8px;overflow:hidden"><div style="height:100%;background:linear-gradient(90deg,var(--yellow),#f59e0b);width:'+anchorSharePct+'%;transition:width 0.5s"></div></div><div style="font-size:11px;color:var(--text2);margin-top:4px;text-align:right">$'+fmt(breakdown.anchorSubscriptions,2)+'</div></div></div><div class="investor-highlight"><div class="title">üíº Partner Economics</div><div class="value">Balanced ecosystem</div><div class="sub">LPs and Anchors each contribute to network liquidity and distribution ‚Ä¢ Subscription model ensures stable recurring revenue</div></div></div>';

return'<div class="card" style="margin-bottom:16px"><div class="card-header"><div class="card-title">üìÖ Revenue Period</div></div>'+dateFilter+customDateInputs+dateDisplay+'</div><div class="grid-4"><div class="stat-card green"><div class="stat-icon">üíµ</div><div class="stat-value">$'+fmt(totalRevenue,0)+'</div><div class="stat-label">Total Revenue</div></div><div class="stat-card"><div class="stat-icon">üí∞</div><div class="stat-value">$'+fmt(breakdown.transactionFees,0)+'</div><div class="stat-label">Transaction Fees</div></div><div class="stat-card yellow"><div class="stat-icon">üì±</div><div class="stat-value">$'+fmt(breakdown.lpSubscriptions+breakdown.anchorSubscriptions,0)+'</div><div class="stat-label">Subscriptions</div></div><div class="stat-card purple"><div class="stat-icon">‚≠ê</div><div class="stat-value">$'+fmt(breakdown.senderPremium,0)+'</div><div class="stat-label">Premium Fees</div></div></div><div class="grid-2"><div class="card"><div class="card-header"><div class="card-title">üìà Revenue Streams (6 Sources)</div><button class="btn btn-sm btn-secondary" onclick="showToast(\'Revenue report exported\',\'success\')">üìä Export</button></div><div class="revenue-breakdown" style="font-size:14px"><div class="revenue-row"><span class="label">üí∏ Transaction Fees (1.2%)</span><span class="value">$'+fmt(breakdown.transactionFees,2)+'</span></div><div class="revenue-row"><span class="label">üè¶ LP Subscriptions</span><span class="value">$'+fmt(breakdown.lpSubscriptions,2)+'</span></div><div class="revenue-row"><span class="label">üè™ Anchor Subscriptions</span><span class="value">$'+fmt(breakdown.anchorSubscriptions,2)+'</span></div><div class="revenue-row"><span class="label">‚≠ê Sender Premium ($5/tx)</span><span class="value">$'+fmt(breakdown.senderPremium,2)+'</span></div><div class="revenue-row"><span class="label">üè¢ Institutional API</span><span class="value">$'+fmt(breakdown.institutionalApi,2)+'</span></div><div class="revenue-row"><span class="label">üìä Data & Analytics</span><span class="value">$'+fmt(breakdown.dataAnalytics,2)+'</span></div><div class="revenue-row" style="border-top:2px solid var(--border);padding-top:12px;margin-top:8px"><span class="label" style="font-weight:700;font-size:15px">Total Revenue</span><span class="value" style="font-weight:700;font-size:16px;color:var(--green)">$'+fmt(totalRevenue,2)+'</span></div></div></div>'+partnerSplitCard+'</div><div class="investor-highlight"><div class="title">üí° Revenue Model</div><div class="value">Multi-stream monetization</div><div class="sub">Diversified revenue across transaction fees, subscriptions, and B2B services ‚Ä¢ Target: 3% blended take rate</div></div>';
}

function renderAdminCorridors(){
return'<div class="card"><div class="card-header"><div class="card-title">üåç Active Corridors</div><span class="badge badge-info">'+TOP_CORRIDORS.length+' corridors</span><button class="btn btn-sm btn-secondary" onclick="showToast(\'Corridor report exported\',\'success\')">üìä Export</button></div><div class="corridor-grid">'+TOP_CORRIDORS.map((c,i)=>'<div class="corridor-card" onclick="showCorridorDetailModal('+i+')"><div class="flags">'+CURRENCIES[c.from].flag+' ‚Üí '+CURRENCIES[c.to].flag+'</div><div class="route">'+c.name+'</div><div class="volume">Volume: '+c.vol+'</div><div class="rate">Rate: '+fmt(getRate(c.from,c.to),2)+' '+c.to+'</div>'+(c.fraudFlags?'<div style="color:var(--yellow);font-size:10px;margin-top:4px">‚ö†Ô∏è '+c.fraudFlags+' flags</div>':'')+'</div>').join('')+'</div></div>';
}

function renderAdminPricing(){
const rows=Object.keys(corridorPricing).map(tier=>{
const p=corridorPricing[tier];
const badgeClass=tier==1?'success':tier==2?'info':tier==3?'warning':'danger';
return'<tr style="border-bottom:1px solid var(--border)"><td style="text-align:center;padding:12px"><span class="badge badge-'+badgeClass+'">Tier '+tier+'</span></td><td style="text-align:right;padding:12px"><input type="number" value="'+p.lp+'" step="0.1" min="0" style="width:80px;padding:6px;background:var(--bg3);border:1px solid var(--border);border-radius:6px;color:var(--text);text-align:right" onchange="corridorPricing['+tier+'].lp=parseFloat(this.value);render()"></td><td style="text-align:right;padding:12px"><input type="number" value="'+p.anchor+'" step="0.1" min="0" style="width:80px;padding:6px;background:var(--bg3);border:1px solid var(--border);border-radius:6px;color:var(--text);text-align:right" onchange="corridorPricing['+tier+'].anchor=parseFloat(this.value);render()"></td><td style="text-align:right;padding:12px"><input type="number" value="'+p.fb+'" step="0.1" min="0" style="width:80px;padding:6px;background:var(--bg3);border:1px solid var(--border);border-radius:6px;color:var(--text);text-align:right" onchange="corridorPricing['+tier+'].fb=parseFloat(this.value);render()"></td><td style="text-align:right;padding:12px;font-weight:600;color:var(--green)">$'+fmt(p.lp+p.anchor+p.fb,2)+'</td></tr>';
}).join('');

// LP Pricing Bands section
const band=PRICING_BANDS.default;
const lpBandsSection='<div class="card" style="margin-top:16px"><div class="card-header"><div class="card-title">üéØ LP Pricing Bands</div><button class="btn btn-sm btn-secondary" onclick="PRICING_BANDS.default={minDeltaPct:-5,maxDeltaPct:2};render();showToast(\'LP bands reset to defaults\',\'success\')">Reset Bands</button></div><div class="glass-card"><div style="font-weight:600;margin-bottom:12px">Default LP Rate Limits (All Corridors)</div><div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px"><div><label style="font-size:11px;color:var(--text2);display:block;margin-bottom:6px">MIN DELTA (%)</label><input type="number" value="'+band.minDeltaPct+'" step="0.5" min="-20" max="0" style="width:100%;padding:10px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:16px;font-weight:600" onchange="PRICING_BANDS.default.minDeltaPct=parseFloat(this.value);render();showToast(\'Min delta updated to \'+this.value+\'%\',\'success\')"></div><div><label style="font-size:11px;color:var(--text2);display:block;margin-bottom:6px">MAX DELTA (%)</label><input type="number" value="'+band.maxDeltaPct+'" step="0.5" min="0" max="20" style="width:100%;padding:10px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:16px;font-weight:600" onchange="PRICING_BANDS.default.maxDeltaPct=parseFloat(this.value);render();showToast(\'Max delta updated to \'+this.value+\'%\',\'success\')"></div></div><div style="font-size:11px;color:var(--text2);padding:12px;background:var(--bg4);border-radius:8px"><strong>What this means:</strong><br>‚Ä¢ LPs can price '+band.minDeltaPct+'% <strong>below</strong> FlowBridge rate (discount to sender)<br>‚Ä¢ LPs can price up to +'+band.maxDeltaPct+'% <strong>above</strong> FlowBridge rate (markup)<br>‚Ä¢ Rates outside this range will be rejected</div><div style="margin-top:12px;font-size:11px;padding:12px;background:rgba(88,166,255,0.05);border:1px solid rgba(88,166,255,0.2);border-radius:8px;color:var(--accent)"><strong>üí° Example:</strong> If FlowBridge rate is 100 INR/AED, LPs can quote between '+fmt(100*(1+band.minDeltaPct/100),2)+' and '+fmt(100*(1+band.maxDeltaPct/100),2)+' INR/AED</div></div></div>';

return'<div class="card"><div class="card-header"><div class="card-title">üí≤ Pricing Controls</div><button class="btn btn-sm btn-secondary" onclick="Object.keys(corridorPricing).forEach(function(t){corridorPricing[t]=Object.assign({},defaultCorridorPricing[t])});render();showToast(\'Pricing reset to defaults\',\'success\')">Reset to Defaults</button></div><div style="overflow-x:auto"><table style="width:100%;border-collapse:collapse"><thead><tr style="border-bottom:2px solid var(--border)"><th style="text-align:center;padding:12px;font-size:11px;color:var(--text2)">TIER</th><th style="text-align:right;padding:12px;font-size:11px;color:var(--text2)">LP FEE ($)</th><th style="text-align:right;padding:12px;font-size:11px;color:var(--text2)">ANCHOR FEE ($)</th><th style="text-align:right;padding:12px;font-size:11px;color:var(--text2)">FB MARGIN ($)</th><th style="text-align:right;padding:12px;font-size:11px;color:var(--text2)">TOTAL ($)</th></tr></thead><tbody>'+rows+'</tbody></table></div></div>'+lpBandsSection+'<div class="card"><div class="card-header"><div class="card-title">üéØ Stress Test Simulator</div></div><div class="glass-card" style="margin-bottom:16px"><div style="font-weight:600;margin-bottom:12px">Dynamic Pricing Parameters</div><div style="margin-bottom:16px"><div style="display:flex;justify-content:space-between;margin-bottom:6px"><span style="font-size:12px">Liquidity Pressure Index (LPI)</span><span style="font-size:12px;color:var(--accent)" id="lpiValue">0.3</span></div><input type="range" min="0" max="1" step="0.05" value="0.3" style="width:100%" id="lpiSlider" onchange="document.getElementById(\'lpiValue\').textContent=this.value;updateStressSim()"><div style="font-size:10px;color:var(--text2);margin-top:4px">0 = High liquidity available | 1 = Liquidity constrained</div></div><div style="margin-bottom:16px"><div style="display:flex;justify-content:space-between;margin-bottom:6px"><span style="font-size:12px">Volatility Index (VIXc)</span><span style="font-size:12px;color:var(--accent)" id="vixValue">0.15</span></div><input type="range" min="0" max="0.3" step="0.01" value="0.15" style="width:100%" id="vixSlider" onchange="document.getElementById(\'vixValue\').textContent=this.value;updateStressSim()"><div style="font-size:10px;color:var(--text2);margin-top:4px">0 = Stable currency | 0.3 = High volatility</div></div><div style="margin-bottom:16px"><div style="display:flex;justify-content:space-between;margin-bottom:6px"><span style="font-size:12px">Risk Profile Score (RPS)</span><span style="font-size:12px;color:var(--accent)" id="rpsValue">0.2</span></div><input type="range" min="0" max="1" step="0.05" value="0.2" style="width:100%" id="rpsSlider" onchange="document.getElementById(\'rpsValue\').textContent=this.value;updateStressSim()"><div style="font-size:10px;color:var(--text2);margin-top:4px">0 = Low risk corridor | 1 = High risk</div></div></div><div id="stressResults"><div class="glass-card"><div style="font-weight:600;margin-bottom:8px">Tier 2 Stress Test Results</div><div class="revenue-breakdown"><div class="revenue-row"><span class="label">Base LP Fee</span><span class="value">$1.00</span></div><div class="revenue-row"><span class="label">Stressed LP Fee</span><span class="value" id="stressLp">$1.39</span></div><div class="revenue-row"><span class="label">Base Anchor Fee</span><span class="value">$1.00</span></div><div class="revenue-row"><span class="label">Stressed Anchor Fee</span><span class="value" id="stressAnchor">$1.39</span></div><div class="revenue-row" style="border-top:1px solid var(--border);padding-top:8px;margin-top:4px"><span class="label" style="font-weight:600">Multiplier</span><span class="value" id="stressMultiplier">1.39x</span></div></div></div></div></div><div class="investor-highlight"><div class="title">üí° Dynamic Pricing Model</div><div class="value">Real-time risk adjustment</div><div class="sub">Pricing automatically adjusts based on liquidity, volatility, and risk factors</div></div>';
}

function updateStressSim(){
const lpi=parseFloat(document.getElementById('lpiSlider')?.value)||0.3;
const vix=parseFloat(document.getElementById('vixSlider')?.value)||0.15;
const rps=parseFloat(document.getElementById('rpsSlider')?.value)||0.2;
const base=corridorPricing[2];
const stressed=simulateDynamicPricing(base,lpi,vix,rps);
document.getElementById('stressLp').textContent='$'+fmt(stressed.lp,2);
document.getElementById('stressAnchor').textContent='$'+fmt(stressed.anchor,2);
document.getElementById('stressMultiplier').textContent=fmt(stressed.multiplier,2)+'x';
}

function renderAdminFraud(){
const flagged=txHistory.filter(t=>t.pattern==='bilateral');
return'<div class="grid-3"><div class="stat-card green"><div class="stat-icon">üõ°Ô∏è</div><div class="stat-value">99.2%</div><div class="stat-label">Clean Transactions</div></div><div class="stat-card yellow"><div class="stat-icon">‚ö†Ô∏è</div><div class="stat-value">'+flagged.length+'</div><div class="stat-label">Flagged Patterns</div></div><div class="stat-card"><div class="stat-icon">üîç</div><div class="stat-value">$0</div><div class="stat-label">Fraud Losses</div></div></div><div class="card"><div class="card-header"><div class="card-title">üö® Fraud Controls</div><button class="btn btn-sm btn-danger" onclick="simulateCollusionPattern()">Simulate Collusion</button></div><div class="glass-card" style="margin-bottom:12px"><div style="font-weight:600;margin-bottom:8px">Anti-Gaming Measures</div><div style="font-size:12px;color:var(--text2)">‚Ä¢ Bilateral volume concentration monitoring<br>‚Ä¢ FlowScore penalties for suspicious patterns<br>‚Ä¢ Counterparty diversity requirements<br>‚Ä¢ Real-time pattern detection</div></div>'+(flagged.length?'<div style="font-weight:600;margin-bottom:12px">Flagged Transactions</div>'+flagged.map(tx=>'<div class="tx-row suspicious" onclick="showFraudReviewModal({id:\''+tx.id+'\'})"><div class="tx-icon" style="background:rgba(248,81,73,0.1)">‚ö†Ô∏è</div><div class="tx-info"><div class="tx-title">'+tx.id+' <span class="badge badge-collusion">Pattern Detected</span></div><div class="tx-detail">Concentration: '+(tx.concentration||83)+'% bilateral volume</div></div><div class="tx-amount"><button class="btn btn-sm btn-danger" onclick="event.stopPropagation();showFraudReviewModal({id:\''+tx.id+'\'})">Review</button></div></div>').join(''):'<div style="color:var(--text2);text-align:center;padding:20px">No flagged transactions</div>')+'</div>';
}

// ============ SCHEDULED TRANSFER EXECUTION ============
let scheduledCheckInterval=null;

function checkScheduledTransfers(){
  const now=new Date().getTime();
  const pending=[DEMO_TX,...txHistory].filter(t=>t&&t.scheduled&&t.status==='pending'&&t.scheduledTime);
  
  pending.forEach(tx=>{
    const schedTime=new Date(tx.scheduledTime).getTime();
    if(schedTime<=now){
      // Execute scheduled transaction
      if(tx===DEMO_TX){
        pushNotif('‚è∞ Scheduled transfer executing: '+tx.id,'info','sender');
        pushNotif('‚è∞ Scheduled transfer ready: '+tx.id,'info','admin');
        // Auto-advance to matching if in sender view
        if(currentRole==='sender')setView('swipe');
      }
    }
  });
}

function startScheduledMonitor(){
  if(scheduledCheckInterval)clearInterval(scheduledCheckInterval);
  scheduledCheckInterval=setInterval(checkScheduledTransfers,5000); // Check every 5 seconds
}

// ============ INITIALIZATION ============
document.addEventListener('DOMContentLoaded',()=>{
  render();
  updateSavingsTicker();
  updateModeIndicator();
  pushNotif('Welcome to FlowBridge Investor Demo v4','info');
  pushNotif('Try switching users or loading a scenario!','info');
  startScheduledMonitor(); // Start monitoring scheduled transfers
});

// Keyboard shortcuts help modal
function showKeyboardShortcutsModal(){
  const html='<div class="modal-header"><span class="modal-title">‚å®Ô∏è Keyboard Shortcuts</span><button class="modal-close" onclick="forceCloseModal()">‚úï</button></div><div class="modal-body"><div class="glass-card" style="margin-bottom:12px"><div style="font-weight:600;margin-bottom:12px">Navigation Shortcuts</div><div style="display:grid;gap:8px;font-size:13px"><div style="display:flex;justify-content:space-between;padding:8px;background:var(--bg4);border-radius:6px"><span>Switch to Sender</span><kbd class="kb-hint" style="padding:4px 8px;background:var(--bg3);border:1px solid var(--border);border-radius:4px">1</kbd></div><div style="display:flex;justify-content:space-between;padding:8px;background:var(--bg4);border-radius:6px"><span>Switch to LP</span><kbd class="kb-hint">2</kbd></div><div style="display:flex;justify-content:space-between;padding:8px;background:var(--bg4);border-radius:6px"><span>Switch to Anchor</span><kbd class="kb-hint">3</kbd></div><div style="display:flex;justify-content:space-between;padding:8px;background:var(--bg4);border-radius:6px"><span>Switch to Receiver</span><kbd class="kb-hint">4</kbd></div><div style="display:flex;justify-content:space-between;padding:8px;background:var(--bg4);border-radius:6px"><span>Switch to Admin</span><kbd class="kb-hint">5</kbd></div></div></div><div class="glass-card"><div style="font-weight:600;margin-bottom:12px">Demo Controls</div><div style="display:grid;gap:8px;font-size:13px"><div style="display:flex;justify-content:space-between;padding:8px;background:var(--bg4);border-radius:6px"><span>Reset Demo</span><kbd class="kb-hint">R</kbd></div><div style="display:flex;justify-content:space-between;padding:8px;background:var(--bg4);border-radius:6px"><span>Toggle Guided Mode</span><kbd class="kb-hint">G</kbd></div><div style="display:flex;justify-content:space-between;padding:8px;background:var(--bg4);border-radius:6px"><span>Toggle Free Mode</span><kbd class="kb-hint">F</kbd></div><div style="display:flex;justify-content:space-between;padding:8px;background:var(--bg4);border-radius:6px"><span>Show Keyboard Shortcuts</span><kbd class="kb-hint">?</kbd></div></div></div></div><div class="modal-footer"><button class="btn btn-primary" onclick="forceCloseModal()">Got it</button></div>';
  openModal(html);
}

// Keyboard shortcuts
document.addEventListener('keydown',(e)=>{
  if(e.target.tagName==='INPUT'||e.target.tagName==='SELECT'||e.target.tagName==='TEXTAREA')return;
  if(e.key==='?'){showKeyboardShortcutsModal();return}
  if(e.key==='r'||e.key==='R'){resetDemo()}
  if(e.key==='g'||e.key==='G'){toggleGuidedDemo()}
  if(e.key==='f'||e.key==='F'){toggleMode()}
  if(e.key==='1'){switchRole('sender')}
  if(e.key==='2'){switchRole('lp')}
  if(e.key==='3'){switchRole('anchor')}
  if(e.key==='4'){switchRole('receiver')}
  if(e.key==='5'){switchRole('admin')}
});
</script>
</body>
</html>
